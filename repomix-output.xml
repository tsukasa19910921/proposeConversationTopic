This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.claude/settings.local.json
.env.local.example
.gitignore
CLAUDE.md
DEPLOYMENT_FIX.md
next-env.d.ts
next.config.js
package.json
postcss.config.js
prisma/schema.prisma
PROJECT_STRUCTURE.md
src/app/api/auth/login/route.ts
src/app/api/auth/logout/route.ts
src/app/api/auth/signup/route.ts
src/app/api/me/route.ts
src/app/api/metrics/me/route.ts
src/app/api/profile/me/route.ts
src/app/api/qr/me/route.ts
src/app/api/scan/route.ts
src/app/auth/login/page.tsx
src/app/auth/signup/page.tsx
src/app/globals.css
src/app/home/page.tsx
src/app/layout.tsx
src/app/metrics/page.tsx
src/app/not-found.tsx
src/app/page.tsx
src/app/profile/page.tsx
src/app/scan/page.tsx
src/components/CameraScanner.tsx
src/components/ClientAnalytics.tsx
src/components/GoogleAnalytics.tsx
src/components/Navigation.tsx
src/components/Toast.tsx
src/components/TopicModal.tsx
src/lib/cooldown.ts
src/lib/db.ts
src/lib/llm.ts
src/lib/profile-shape.ts
src/lib/qr.ts
src/lib/repos/counters.ts
src/lib/repos/profile.ts
src/lib/repos/users.ts
src/lib/session.ts
src/lib/topics.ts
tailwind.config.js
tsconfig.json
UI_IMPROVEMENT_TODO.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".env.local.example">
# Database Configuration
DATABASE_URL=postgresql://...
DIRECT_URL=postgresql://...

# Session Configuration
SESSION_SECRET=your-random-secret-string-here
SESSION_MAX_AGE_SECONDS=86400

# Google Gemini API
GOOGLE_GEMINI_API_KEY=your-gemini-api-key

# App Configuration
APP_BASE_URL=http://localhost:3000

# Google Analytics (Optional)
NEXT_PUBLIC_GA_ID=your-google-analytics-id
</file>

<file path="DEPLOYMENT_FIX.md">
# Vercelãƒ‡ãƒ—ãƒ­ã‚¤500ã‚¨ãƒ©ãƒ¼ä¿®æ­£ã‚¬ã‚¤ãƒ‰

## 1. å®Œäº†ã—ãŸä¿®æ­£
âœ… ã™ã¹ã¦ã®APIãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«å‹•çš„å®Ÿè¡Œè¨­å®šã‚’è¿½åŠ ã—ã¾ã—ãŸ
- cookies()ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚é™çš„ãƒ—ãƒªãƒ¬ãƒ³ãƒ€ãŒã§ããªã„ã‚¨ãƒ©ãƒ¼ã‚’è§£æ±º

## 2. Vercelç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### å¿…é ˆã®ç’°å¢ƒå¤‰æ•°
ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’Vercelã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§è¨­å®šã—ã¦ãã ã•ã„ï¼š

1. **DATABASE_URL** (å¿…é ˆ)
   - PostgreSQLã®æ¥ç¶šæ–‡å­—åˆ—
   - ä¾‹: `postgresql://user:password@host:5432/dbname?sslmode=require`
   - Supabase/Neonã®ç„¡æ–™ãƒ—ãƒ©ãƒ³ã§OK

2. **SESSION_SECRET** (å¿…é ˆ)
   - ãƒ©ãƒ³ãƒ€ãƒ ãªé•·ã„æ–‡å­—åˆ—ï¼ˆ32æ–‡å­—ä»¥ä¸Šæ¨å¥¨ï¼‰
   - æœªè¨­å®šã ã¨Cookieç½²åã§ã‚¨ãƒ©ãƒ¼â†’500ã‚¨ãƒ©ãƒ¼ã®åŸå› 
   - ç”Ÿæˆä¾‹: `openssl rand -hex 32`

3. **APP_BASE_URL** (å¿…é ˆ)
   - æœ¬ç•ªç’°å¢ƒã®URL
   - ä¾‹: `https://your-app-name.vercel.app`
   - QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã§ä½¿ç”¨

4. **GOOGLE_GEMINI_API_KEY** (å¿…é ˆ)
   - Google AI Studioã‹ã‚‰Gemini APIã‚­ãƒ¼ã‚’å–å¾—
   - https://makersuite.google.com/app/apikey

5. **SESSION_MAX_AGE_SECONDS** (ä»»æ„)
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 86400 (24æ™‚é–“)

### è¨­å®šæ‰‹é †
1. Vercelãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ãƒ­ã‚°ã‚¤ãƒ³
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
3. Settings â†’ Environment Variables
4. å„ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ï¼ˆProduction/Preview/Developmentå…¨ã¦ã«ãƒã‚§ãƒƒã‚¯ï¼‰
5. Save

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–

### Supabaseã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼š
```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œ
npx prisma db push
```

ã¾ãŸã¯ã€Vercelã®ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒƒãƒ—ã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™ï¼ˆpackage.jsonã®buildã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰

## 4. å†ãƒ‡ãƒ—ãƒ­ã‚¤
ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ãŸã‚‰ã€å†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œï¼š
```bash
vercel --prod
```

## 5. å‹•ä½œç¢ºèª

### APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
```bash
# ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ
curl -X POST https://your-app.vercel.app/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"userId":"test1","password":"password123"}'

# ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼ˆæˆåŠŸï¼‰
# {"ok":true}
# Set-Cookie: sid=...
```

### ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®ç¢ºèª
1. `/auth/signup`ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
2. `/home`ã§è‡ªåˆ†ã®QRè¡¨ç¤ºç¢ºèª
3. `/metrics`ã§å®Ÿç¸¾è¡¨ç¤ºç¢ºèª

## 6. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 500ã‚¨ãƒ©ãƒ¼ãŒç¶šãå ´åˆ
- Vercelã® Functions ãƒ­ã‚°ã‚’ç¢ºèª
- ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹å†ç¢ºèª
- DATABASE_URLã®æ¥ç¶šæ–‡å­—åˆ—ãŒæ­£ã—ã„ã‹ç¢ºèª

### "Dynamic server usage"ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆ
- ã™ã¹ã¦ã®APIãƒ«ãƒ¼ãƒˆã«`export const dynamic = 'force-dynamic'`ãŒã‚ã‚‹ã‹ç¢ºèª
- å†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œ

### favicon.ico 404ã‚¨ãƒ©ãƒ¼
- `/public/favicon.ico`ã‚’è¿½åŠ ï¼ˆä»»æ„ï¼‰
</file>

<file path="next-env.d.ts">
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/building-your-application/configuring/typescript for more information.
</file>

<file path="postcss.config.js">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};
</file>

<file path="PROJECT_STRUCTURE.md">
# ğŸ“š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆãƒ»æ©Ÿèƒ½é…ç½® è§£èª¬æ›¸

## ğŸ¯ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€Œ**é«˜æ ¡ç”Ÿå‘ã‘QRãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«Ã—è©±é¡Œæç¤ºã‚¢ãƒ—ãƒª**ã€ã§ã™ã€‚
QRã‚³ãƒ¼ãƒ‰ã‚’é€šã˜ã¦ç›¸æ‰‹ã¨ç¹‹ãŒã‚Šã€AIï¼ˆGoogle Geminiï¼‰ãŒå…±é€šç‚¹ã‚’è¦‹ã¤ã‘ã¦ä¼šè©±ã®ãã£ã‹ã‘ã¨ãªã‚‹è©±é¡Œã‚’ææ¡ˆã—ã¾ã™ã€‚

### ä¸»è¦ãªæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: Next.js 14ï¼ˆApp Routerï¼‰
- **è¨€èª**: TypeScript
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: PostgreSQLï¼ˆSupabaseï¼‰+ Prisma ORM
- **AI**: Google Gemini 1.5 Flash
- **èªè¨¼**: ç½²åä»˜ãCookieï¼ˆHMACï¼‰
- **ãƒ‡ãƒ—ãƒ­ã‚¤**: Vercel
- **ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°**: Tailwind CSS

---

## ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆã®å…¨ä½“åƒ

```
proposeConversationTopic/
â”œâ”€â”€ ğŸ“‚ .claude/                # Claude Codeè¨­å®š
â”‚   â””â”€â”€ settings.local.json    # ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®š
â”‚
â”œâ”€â”€ ğŸ“‚ .vscode/                # VS Codeè¨­å®š
â”‚   â””â”€â”€ settings.json
â”‚
â”œâ”€â”€ ğŸ“‚ prisma/                 # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®šç¾©
â”‚   â””â”€â”€ schema.prisma         # Prismaã‚¹ã‚­ãƒ¼ãƒ
â”‚
â”œâ”€â”€ ğŸ“‚ src/                    # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰æœ¬ä½“
â”‚   â”œâ”€â”€ ğŸ“‚ app/               # Next.js App Routerï¼ˆãƒšãƒ¼ã‚¸ã¨APIï¼‰
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ api/          # APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ auth/     # èªè¨¼API
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ login/route.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ logout/route.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ signup/route.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ me/       # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±API
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ metrics/  # å®Ÿç¸¾API
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ me/route.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ profile/  # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«API
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ me/route.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ qr/       # QRã‚³ãƒ¼ãƒ‰API
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ me/route.ts
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“‚ scan/     # ã‚¹ã‚­ãƒ£ãƒ³API
â”‚   â”‚   â”‚       â””â”€â”€ route.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ auth/          # èªè¨¼é–¢é€£ãƒšãƒ¼ã‚¸
â”‚   â”‚   â”‚   â”œâ”€â”€ login/page.tsx
â”‚   â”‚   â”‚   â””â”€â”€ signup/page.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ home/          # ãƒ›ãƒ¼ãƒ ç”»é¢
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ metrics/       # å®Ÿç¸¾ç”»é¢
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ profile/       # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ scan/          # QRã‚¹ã‚­ãƒ£ãƒ³ç”»é¢
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ globals.css       # ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ«
â”‚   â”‚   â”œâ”€â”€ layout.tsx        # å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”‚   â”‚   â”œâ”€â”€ not-found.tsx     # 404ãƒšãƒ¼ã‚¸
â”‚   â”‚   â””â”€â”€ page.tsx          # ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“‚ components/         # å†åˆ©ç”¨å¯èƒ½ãªUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ CameraScanner.tsx # QRã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒŠãƒ¼
â”‚   â”‚   â”œâ”€â”€ ClientAnalytics.tsx # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´GA
â”‚   â”‚   â”œâ”€â”€ GoogleAnalytics.tsx # ã‚µãƒ¼ãƒãƒ¼å´GA
â”‚   â”‚   â”œâ”€â”€ Navigation.tsx    # 3ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”‚   â”œâ”€â”€ Toast.tsx         # ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
â”‚   â”‚   â””â”€â”€ TopicModal.tsx    # è©±é¡Œè¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“‚ lib/               # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚       â”œâ”€â”€ ğŸ“‚ repos/         # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œå±¤
â”‚       â”‚   â”œâ”€â”€ counters.ts   # ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ç®¡ç†
â”‚       â”‚   â”œâ”€â”€ profile.ts    # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†
â”‚       â”‚   â””â”€â”€ users.ts      # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
â”‚       â”‚
â”‚       â”œâ”€â”€ cooldown.ts       # ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³åˆ¶å¾¡
â”‚       â”œâ”€â”€ db.ts             # Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚       â”œâ”€â”€ llm.ts            # Gemini AIé€£æº
â”‚       â”œâ”€â”€ profile-shape.ts  # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å‹å®šç¾©
â”‚       â”œâ”€â”€ qr.ts             # QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
â”‚       â”œâ”€â”€ session.ts        # ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
â”‚       â””â”€â”€ topics.ts         # ãƒˆãƒ”ãƒƒã‚¯å®šç¾©
â”‚
â”œâ”€â”€ ğŸ“„ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¾¤
â”‚   â”œâ”€â”€ .env                  # ç’°å¢ƒå¤‰æ•°ï¼ˆGité™¤å¤–ï¼‰
â”‚   â”œâ”€â”€ .env.local.example    # ç’°å¢ƒå¤‰æ•°ã‚µãƒ³ãƒ—ãƒ«
â”‚   â”œâ”€â”€ .gitignore
â”‚   â”œâ”€â”€ next.config.js        # Next.jsè¨­å®š
â”‚   â”œâ”€â”€ next-env.d.ts         # TypeScriptç’°å¢ƒå®šç¾©
â”‚   â”œâ”€â”€ package.json          # ä¾å­˜é–¢ä¿‚
â”‚   â”œâ”€â”€ package-lock.json
â”‚   â”œâ”€â”€ postcss.config.js     # PostCSSè¨­å®š
â”‚   â”œâ”€â”€ tailwind.config.js    # Tailwindè¨­å®š
â”‚   â”œâ”€â”€ tsconfig.json         # TypeScriptè¨­å®š
â”‚   â””â”€â”€ tsconfig.tsbuildinfo  # TSãƒ“ãƒ«ãƒ‰æƒ…å ±
â”‚
â”œâ”€â”€ ğŸ“„ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ CLAUDE.md             # Claude Codeå®Ÿè£…ã‚¬ã‚¤ãƒ‰
â”‚   â”œâ”€â”€ DEPLOYMENT_FIX.md     # ãƒ‡ãƒ—ãƒ­ã‚¤ä¿®æ­£è¨˜éŒ²
â”‚   â”œâ”€â”€ PROJECT_STRUCTURE.md  # æœ¬ãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â””â”€â”€ UI_IMPROVEMENT_TODO.md # UIæ”¹å–„ã‚¿ã‚¹ã‚¯
â”‚
â””â”€â”€ ğŸ“„ ãã®ä»–
    â””â”€â”€ repomix-output.xml    # ã‚³ãƒ¼ãƒ‰è§£æçµæœ
```

---

## ğŸ—‚ï¸ è©³ç´°ãªãƒ•ã‚©ãƒ«ãƒ€ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«è§£èª¬

### 1ï¸âƒ£ `/src/app/` - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸­æ ¸

#### **ãƒšãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆç”»é¢ï¼‰**

| ãƒ•ã‚¡ã‚¤ãƒ« | æ©Ÿèƒ½èª¬æ˜ | ã‚¢ã‚¯ã‚»ã‚¹URL |
|---------|---------|------------|
| `page.tsx` | ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼ˆãƒ›ãƒ¼ãƒ ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰ | `/` |
| `not-found.tsx` | 404ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ | å­˜åœ¨ã—ãªã„URL |
| `layout.tsx` | å…¨ãƒšãƒ¼ã‚¸å…±é€šã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ<br>- Google Analyticsè¨­å®š<br>- åŸºæœ¬çš„ãªã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨ | - |
| `globals.css` | ã‚°ãƒ­ãƒ¼ãƒãƒ«CSS<br>- ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆå®šç¾©<br>- ã‚¬ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ <br>- ãƒã‚ªãƒ³åŠ¹æœ<br>- QRã‚³ãƒ¼ãƒ‰SVGã‚¹ã‚¿ã‚¤ãƒ« | - |

#### **èªè¨¼é–¢é€£ï¼ˆ`/auth/`ï¼‰**

| ãƒ•ã‚¡ã‚¤ãƒ« | æ©Ÿèƒ½èª¬æ˜ | ç‰¹å¾´ |
|---------|---------|------|
| `auth/signup/page.tsx` | æ–°è¦ç™»éŒ²ç”»é¢ | ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ID/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›<br>ãƒ»ç™»éŒ²å¾Œã¯è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³â†’ãƒ›ãƒ¼ãƒ ã¸ |
| `auth/login/page.tsx` | ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ | ãƒ»æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼<br>ãƒ»æˆåŠŸå¾Œãƒ›ãƒ¼ãƒ ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ |

#### **ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ç”»é¢**

| ãƒ•ã‚¡ã‚¤ãƒ« | æ©Ÿèƒ½èª¬æ˜ | ä¸»ãªè¦ç´  |
|---------|---------|----------|
| `home/page.tsx` | ãƒ›ãƒ¼ãƒ ç”»é¢ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ | ãƒ»è‡ªåˆ†ã®QRã‚³ãƒ¼ãƒ‰å¤§ããè¡¨ç¤º<br>ãƒ»ã€Œç›¸æ‰‹ã®QRã‚’èª­ã¿å–ã‚‹ã€ãƒœã‚¿ãƒ³<br>ãƒ»è©±é¡Œãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º<br>ãƒ»QRã‚«ãƒ¼ãƒ‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³æ”¹å–„æ¸ˆã¿ |
| `profile/page.tsx` | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›† | ãƒ»è¶£å‘³ãƒ»èˆˆå‘³ã‚’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é¸æŠ<br>ãƒ»è©³ç´°ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›<br>ãƒ»ä¿å­˜ãƒœã‚¿ãƒ³ |
| `metrics/page.tsx` | å®Ÿç¸¾è¡¨ç¤º | ãƒ»èª­ã¿å–ã£ãŸå›æ•°ï¼ˆscanOutï¼‰<br>ãƒ»èª­ã¿å–ã‚‰ã‚ŒãŸå›æ•°ï¼ˆscanInï¼‰ |
| `scan/page.tsx` | QRã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ | ãƒ»ã‚«ãƒ¡ãƒ©ã§QRèª­ã¿å–ã‚Š<br>ãƒ»URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿çµŒç”±ã§ã‚‚å‡¦ç†å¯èƒ½ |

---

### 2ï¸âƒ£ `/src/app/api/` - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API

#### **èªè¨¼APIï¼ˆ`/api/auth/`ï¼‰**

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | æ©Ÿèƒ½ | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ |
|--------------|---------|------|-------------|
| `/api/auth/signup` | POST | æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² | `{ok: true}` + Cookieè¨­å®š |
| `/api/auth/login` | POST | ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼ | `{ok: true}` + Cookieè¨­å®š |
| `/api/auth/logout` | POST | ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ | Cookieå‰Šé™¤ |

#### **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿API**

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | æ©Ÿèƒ½ | èªè¨¼ |
|--------------|---------|------|------|
| `/api/me` | GET | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾— | å¿…é ˆ |
| `/api/profile/me` | GET/PUT | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ãƒ»æ›´æ–° | å¿…é ˆ |
| `/api/qr/me` | GET | QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆURL+SVGï¼‰ | å¿…é ˆ |
| `/api/metrics/me` | GET | å®Ÿç¸¾æ•°å€¤å–å¾— | å¿…é ˆ |

#### **ã‚³ã‚¢æ©Ÿèƒ½API**

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | æ©Ÿèƒ½ | ç‰¹æ®Šå‡¦ç† |
|--------------|---------|------|----------|
| `/api/scan` | POST | QRã‚¹ã‚­ãƒ£ãƒ³å‡¦ç† | ãƒ»30ç§’ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³<br>ãƒ»Gemini AIè©±é¡Œç”Ÿæˆ<br>ãƒ»ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–° |

---

### 3ï¸âƒ£ `/src/components/` - UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | å½¹å‰² | ä½¿ç”¨å ´æ‰€ | æœ€è¿‘ã®å¤‰æ›´ |
|--------------|------|----------|------------|
| `Navigation.tsx` | 3ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³<br>ï¼ˆãƒ›ãƒ¼ãƒ /ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«/å®Ÿç¸¾ï¼‰ | å„ãƒ¡ã‚¤ãƒ³ç”»é¢ | - |
| `TopicModal.tsx` | è©±é¡Œè¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«<br>ãƒ»ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º<br>ãƒ»è©±é¡Œãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º | ãƒ›ãƒ¼ãƒ ç”»é¢ | ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹è¿½åŠ  |
| `Toast.tsx` | é€šçŸ¥ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º<br>ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ»æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ | å…¨ç”»é¢ | - |
| `CameraScanner.tsx` | QRã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒŠãƒ¼<br>ãƒ»ã‚«ãƒ¡ãƒ©èµ·å‹•<br>ãƒ»QRæ¤œå‡º | ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ | ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œæ”¹å–„ |
| `GoogleAnalytics.tsx` | Google Analyticsè¨­å®š<br>ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰ | layout.tsx | - |
| `ClientAnalytics.tsx` | SPAé·ç§»ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°<br>ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰ | layout.tsx | - |

---

### 4ï¸âƒ£ `/src/lib/` - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤

#### **ã‚³ã‚¢æ©Ÿèƒ½**

| ãƒ•ã‚¡ã‚¤ãƒ« | æ©Ÿèƒ½ | ä¸»è¦ãªé–¢æ•°/å‡¦ç† | æœ€è¿‘ã®å¤‰æ›´ |
|---------|------|----------------|------------|
| `session.ts` | èªè¨¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† | ãƒ»`issueTicket()`: Cookieç™ºè¡Œ<br>ãƒ»`requireSession()`: èªè¨¼ç¢ºèª | - |
| `llm.ts` | AIè©±é¡Œç”Ÿæˆ | ãƒ»Gemini APIé€£æº<br>ãƒ»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ<br>ãƒ»ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç† | ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºæœ€é©åŒ– |
| `qr.ts` | QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ | SVGå½¢å¼ã®QRã‚³ãƒ¼ãƒ‰ä½œæˆ | margin: 2ã«èª¿æ•´ï¼ˆç¾è¦³æ”¹å–„ï¼‰ |
| `cooldown.ts` | ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³åˆ¶å¾¡ | 30ç§’é–“ã®é‡è¤‡ã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢ | - |
| `db.ts` | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š | Prisma ClientåˆæœŸåŒ– | - |

#### **ãƒ‡ãƒ¼ã‚¿å®šç¾©**

| ãƒ•ã‚¡ã‚¤ãƒ« | å†…å®¹ |
|---------|------|
| `topics.ts` | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é¸æŠè‚¢ã®å®šç¾©<br>ï¼ˆéŸ³æ¥½ã€ã‚¹ãƒãƒ¼ãƒ„ã€è¶£å‘³ç­‰ï¼‰ |
| `profile-shape.ts` | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ å®šç¾© |

#### **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œï¼ˆ`/lib/repos/`ï¼‰**

| ãƒ•ã‚¡ã‚¤ãƒ« | å¯¾è±¡ãƒ†ãƒ¼ãƒ–ãƒ« | ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰ |
|---------|------------|-------------|
| `users.ts` | User | ãƒ»`createUser()`: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ<br>ãƒ»`verifyPassword()`: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª |
| `profile.ts` | Profile | ãƒ»`getProfile()`: å–å¾—<br>ãƒ»`saveProfile()`: ä¿å­˜ï¼ˆStringå‹ã§JSONä¿å­˜ï¼‰ |
| `counters.ts` | Counters | ãƒ»`incrScanOutIn()`: ã‚«ã‚¦ãƒ³ãƒˆå¢—åŠ <br>ãƒ»`getCounters()`: å–å¾— |

---

### 5ï¸âƒ£ `/prisma/` - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®šç¾©

#### **ã‚¹ã‚­ãƒ¼ãƒæ§‹é€ **

```prisma
ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆ

Userï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±ï¼‰
â”œâ”€â”€ id: UUIDï¼ˆä¸»ã‚­ãƒ¼ï¼‰
â”œâ”€â”€ userId: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆä¸€æ„ï¼‰
â”œâ”€â”€ passwordHash: ãƒãƒƒã‚·ãƒ¥åŒ–ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
â””â”€â”€ timestamps

Profileï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ï¼‰
â”œâ”€â”€ userId: å¤–éƒ¨ã‚­ãƒ¼ â†’ User.id
â”œâ”€â”€ profileJson: Stringå‹ï¼ˆJSONæ–‡å­—åˆ—ã¨ã—ã¦ä¿å­˜ï¼‰
â””â”€â”€ updatedAt

Countersï¼ˆå®Ÿç¸¾ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼‰
â”œâ”€â”€ userId: å¤–éƒ¨ã‚­ãƒ¼ â†’ User.id
â”œâ”€â”€ scanOutCount: èª­ã¿å–ã£ãŸå›æ•°
â”œâ”€â”€ scanInCount: èª­ã¿å–ã‚‰ã‚ŒãŸå›æ•°
â””â”€â”€ updatedAt
```

---

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã¨å‡¦ç†ã®æµã‚Œ

### **1. æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼**
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
    â†“
[signup/page.tsx]
    â†“
POST /api/auth/signup
    â†“
[users.ts] createUser()
    â†“
Cookieç™ºè¡Œ â†’ ãƒ›ãƒ¼ãƒ ç”»é¢ã¸
```

### **2. QRã‚¹ã‚­ãƒ£ãƒ³ãƒ»è©±é¡Œç”Ÿæˆãƒ•ãƒ­ãƒ¼**
```
QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š
    â†“
[CameraScanner.tsx]
    â†“
POST /api/scan
    â†“
[cooldown.ts] 30ç§’ãƒã‚§ãƒƒã‚¯
    â†“
[profile.ts] ä¸¡è€…ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
    â†“
[llm.ts] Gemini AIã§è©±é¡Œç”Ÿæˆï¼ˆè»½é‡åŒ–æ¸ˆã¿ï¼‰
    â†“
[counters.ts] ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
    â†“
[TopicModal.tsx] è©±é¡Œè¡¨ç¤º
```

### **3. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ•ãƒ­ãƒ¼**
```
ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢è¡¨ç¤º
    â†“
GET /api/profile/me
    â†“
ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†
    â†“
PUT /api/profile/me
    â†“
[profile.ts] saveProfile()
    â†“
DBæ›´æ–°å®Œäº†
```

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### **èªè¨¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³**
- **HMACç½²åä»˜ãCookie**: æ”¹ã–ã‚“é˜²æ­¢
- **æœ‰åŠ¹æœŸé™ç®¡ç†**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ24æ™‚é–“
- **HTTPOnlyå±æ€§**: XSSå¯¾ç­–
- **Secureå±æ€§**: HTTPSé€šä¿¡æ™‚ã®ã¿ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

### **APIä¿è­·**
- å…¨ã¦ã®å€‹äººãƒ‡ãƒ¼ã‚¿APIã§`requireSession()`ã«ã‚ˆã‚‹èªè¨¼ãƒã‚§ãƒƒã‚¯
- è‡ªå·±ã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢
- ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã«ã‚ˆã‚‹ã‚¹ãƒ‘ãƒ é˜²æ­¢

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»ç’°å¢ƒè¨­å®š

### **å¿…è¦ãªç’°å¢ƒå¤‰æ•°**
```env
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
DATABASE_URL=postgresql://...

# ã‚»ãƒƒã‚·ãƒ§ãƒ³
SESSION_SECRET=ãƒ©ãƒ³ãƒ€ãƒ ãªé•·ã„æ–‡å­—åˆ—
SESSION_MAX_AGE_SECONDS=86400

# AI
GOOGLE_GEMINI_API_KEY=AIza...

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
APP_BASE_URL=https://your-app.vercel.app

# ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
NEXT_PUBLIC_GA_ID=G-XXXXXXXXXX
```

### **Vercelå›ºæœ‰ã®è¨­å®š**
- å…¨APIãƒ«ãƒ¼ãƒˆã«`export const dynamic = 'force-dynamic'`è¨­å®š
- Edge Runtimeã§ã¯ãªã Node.js Runtimeã‚’ä½¿ç”¨
- Suspenseãƒã‚¦ãƒ³ãƒ€ãƒªã§`useSearchParams()`ã‚’ãƒ©ãƒƒãƒ—

---

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### **å®Ÿè£…æ¸ˆã¿ã®æœ€é©åŒ–**
1. **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿è»½é‡åŒ–**: é¸æŠã•ã‚ŒãŸé …ç›®ã®ã¿LLMã«é€ä¿¡ï¼ˆç´„1/10ã‚µã‚¤ã‚ºå‰Šæ¸›ï¼‰
2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: Gemini APIå¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
3. **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: QRã‚³ãƒ¼ãƒ‰ã®SVGã‚­ãƒ£ãƒƒã‚·ãƒ¥
4. **ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ´»ç”¨**: ä¸è¦ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆJSã‚’å‰Šæ¸›
5. **QRè¡¨ç¤ºæœ€é©åŒ–**: marginèª¿æ•´ã¨SVG display:blockåŒ–ã§ç¾è¦³æ”¹å–„

### **ä»Šå¾Œã®æ”¹å–„ãƒã‚¤ãƒ³ãƒˆ**
- Vercel KVã§ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç®¡ç†ï¼ˆç¾åœ¨ã¯in-memoryï¼‰
- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ã•ã‚‰ãªã‚‹åœ§ç¸®
- ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…
- Gemini APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–

---

## ğŸ¨ UI/UXã®ç‰¹å¾´

### **ãƒ‡ã‚¶ã‚¤ãƒ³ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**
- **ã‚·ãƒ³ãƒ—ãƒ«**: é«˜æ ¡ç”ŸãŒç›´æ„Ÿçš„ã«ä½¿ãˆã‚‹
- **ãƒ¢ãƒã‚¤ãƒ«ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ**: ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³æœ€é©åŒ–
- **ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–**: å„ç¨®ç”»é¢ã‚µã‚¤ã‚ºå¯¾å¿œ
- **ã‚¬ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ **: åŠé€æ˜ãƒ‡ã‚¶ã‚¤ãƒ³
- **ãƒã‚ªãƒ³åŠ¹æœ**: è‹¥è€…å‘ã‘ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«

### **ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆ**
- **3ã‚¿ãƒ–æ§‹æˆ**: ãƒ›ãƒ¼ãƒ ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»å®Ÿç¸¾
- **ãƒ¢ãƒ¼ãƒ€ãƒ«æ´»ç”¨**: è©±é¡Œè¡¨ç¤ºã¯ç”»é¢é·ç§»ãªã—
- **ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥**: ã‚¨ãƒ©ãƒ¼ã‚’æ§ãˆã‚ã«è¡¨ç¤º

### **æœ€è¿‘ã®UIæ”¹å–„**
- QRã‚³ãƒ¼ãƒ‰ã®è¡¨ç¤ºã‚µã‚¤ã‚ºæ‹¡å¤§ï¼ˆ260px/300pxï¼‰
- QRã‚³ãƒ¼ãƒ‰å†…å´ã®å‡ç­‰ãªç™½ç¸ï¼ˆmargin: 2ï¼‰
- å¤–å´ã‚«ãƒ¼ãƒ‰ã®æ­£æ–¹å½¢åŒ–ï¼ˆaspect-squareï¼‰
- SVGã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¡¨ç¤ºã®ä¿®æ­£

---

## ğŸ“ é–‹ç™ºè€…å‘ã‘ãƒ¡ãƒ¢

### **ã‚ˆãä½¿ã†ã‚³ãƒãƒ³ãƒ‰**
```bash
# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run dev

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
npx prisma db push

# Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆ
npx prisma generate

# æœ¬ç•ªãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
npm run build
```

### **ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**
- **Gemini API 503ã‚¨ãƒ©ãƒ¼**: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã§å¯¾å¿œä¸­
- **ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼**: `useSearchParams()`ã¯Suspenseãƒã‚¦ãƒ³ãƒ€ãƒªå¿…é ˆ
- **Cookieå•é¡Œ**: SameSiteå±æ€§ã®ç¢ºèª
- **PostgreSQLå‹ã‚¨ãƒ©ãƒ¼**: Profile.profileJsonã¯Stringå‹ã§ä¿å­˜

### **æ—¢çŸ¥ã®å•é¡Œ**
1. **Gemini APIé »ç¹ãª503ã‚¨ãƒ©ãƒ¼**
   - ç¾çŠ¶: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†å®Ÿè£…æ¸ˆã¿
   - å¯¾ç­–æ¡ˆ: ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã€åˆ¥ãƒ¢ãƒ‡ãƒ«ã¸ã®åˆ‡ã‚Šæ›¿ãˆ

2. **ãƒ¢ãƒã‚¤ãƒ«ã‚«ãƒ¡ãƒ©å•é¡Œ**
   - ç¾çŠ¶: react-qr-scannerå®Ÿè£…æ¸ˆã¿
   - æ³¨æ„ç‚¹: ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¿…é ˆ

---

## ğŸ ã¾ã¨ã‚

ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€**æŠ€è¡“çš„ã«ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªãŒã‚‰å®Ÿç”¨çš„**ãªæ§‹æˆã¨ãªã£ã¦ã„ã¾ã™ã€‚
Next.js 14ã®æœ€æ–°æ©Ÿèƒ½ã‚’æ´»ç”¨ã—ã€TypeScriptã«ã‚ˆã‚‹å‹å®‰å…¨æ€§ã‚’ä¿ã¡ãªãŒã‚‰ã€
é«˜æ ¡ç”ŸãŒæ°—è»½ã«ä½¿ãˆã‚‹ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

å„ãƒ•ã‚©ãƒ«ãƒ€ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ˜ç¢ºãªå½¹å‰²ã‚’æŒã¡ã€ä¿å®ˆæ€§ã®é«˜ã„æ§‹é€ ã¨ãªã£ã¦ã„ã‚‹ãŸã‚ã€
ä»Šå¾Œã®æ©Ÿèƒ½æ‹¡å¼µã‚‚å®¹æ˜“ã«è¡Œãˆã‚‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ãªã£ã¦ã„ã¾ã™ã€‚

---

*æœ€çµ‚æ›´æ–°: 2025å¹´10æœˆ*
</file>

<file path="src/app/api/me/route.ts">
import { NextResponse } from "next/server";
import { requireSession } from "@/lib/session";
import { prisma } from "@/lib/db";

export const runtime = 'nodejs';
export const dynamic = 'force-dynamic';

export async function GET() {
  try {
    const session = requireSession();

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—
    const user = await prisma.user.findUnique({
      where: { id: session.userId },
      include: {
        profile: true
      }
    });

    if (!user) {
      return NextResponse.json({ error: "user_not_found" }, { status: 404 });
    }

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å®Œäº†çŠ¶æ…‹ã‚’åˆ¤å®š
    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒå­˜åœ¨ã—ã€profileJsonã«ä½•ã‚‰ã‹ã®ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã‚Œã°å®Œäº†ã¨ã¿ãªã™
    const profileCompleted = user.profile &&
      user.profile.profileJson &&
      typeof user.profile.profileJson === 'string' &&
      user.profile.profileJson.trim() !== '{}' &&
      user.profile.profileJson.trim() !== '';

    return NextResponse.json({
      userId: user.id,
      userIdName: user.userId,
      profileCompleted: Boolean(profileCompleted),
      hasProfile: Boolean(user.profile)
    });
  } catch (error) {
    if (error instanceof Error && error.message === "UNAUTH") {
      return NextResponse.json({ error: "unauthorized" }, { status: 401 });
    }
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}
</file>

<file path="src/app/not-found.tsx">
export default function NotFound() {
  return (
    <div className="max-w-md mx-auto p-6 space-y-4">
      <div className="text-center mb-6">
        <div className="text-6xl mb-4">ğŸ˜µ</div>
        <h1 className="text-2xl font-bold text-gray-800">ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h1>
        <p className="text-gray-600 mt-2">
          URLãŒé–“é•ã£ã¦ã„ã‚‹ã‹ã€ãƒšãƒ¼ã‚¸ãŒç§»å‹•ãƒ»å‰Šé™¤ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
        </p>
      </div>

      <div className="space-y-3">
        <a
          href="/auth/login"
          className="block w-full text-center py-3 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition-colors"
        >
          ãƒ­ã‚°ã‚¤ãƒ³
        </a>
        <a
          href="/auth/signup"
          className="block w-full text-center py-3 rounded-lg bg-green-500 text-white hover:bg-green-600 transition-colors"
        >
          æ–°è¦ç™»éŒ²
        </a>
        <a
          href="/"
          className="block w-full text-center py-3 rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors"
        >
          ãƒ›ãƒ¼ãƒ ã¸
        </a>
      </div>

      <div className="mt-6 p-4 bg-blue-50 rounded-lg">
        <p className="text-sm text-blue-700 text-center">
          ğŸ’¡ QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ãŸå ´åˆã¯ã€ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«å†åº¦ãŠè©¦ã—ãã ã•ã„
        </p>
      </div>
    </div>
  )
}
</file>

<file path="src/components/GoogleAnalytics.tsx">
import Script from "next/script";

const GA_ID = process.env.NEXT_PUBLIC_GA_ID;

export default function GoogleAnalytics() {
  if (!GA_ID) return null;

  return (
    <>
      <Script
        src={`https://www.googletagmanager.com/gtag/js?id=${GA_ID}`}
        strategy="afterInteractive"
      />
      <Script id="gtag-init" strategy="afterInteractive">
        {`
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          // SPAäºŒé‡è¨ˆæ¸¬ã‚’é˜²ããŸã‚åˆæœŸè‡ªå‹•é€ä¿¡ã‚’OFF
          gtag('config', '${GA_ID}', { send_page_view: false });
        `}
      </Script>
    </>
  );
}
</file>

<file path="src/lib/db.ts">
import { PrismaClient } from '@prisma/client';

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma = globalForPrisma.prisma ?? new PrismaClient();

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;
</file>

<file path="src/lib/profile-shape.ts">
import { TOPICS } from "./topics";

// Packedå½¢å¼ï¼ˆæœ€å°æ§‹é€ ï¼‰ - DBä¿å­˜ãƒ»LLMå…¥åŠ›ç”¨
export type PackedProfile = {
  [topicId: string]: Array<{ name: string; text: string }>
};

// UIå½¢å¼ï¼ˆãƒ•ãƒ«æ§‹é€ ï¼‰ - UIè¡¨ç¤ºç”¨
export type UIProfile = {
  [topicId: string]: {
    [option: string]: { selected: boolean; freeText: string }
  }
};

// UI â†’ Packedï¼ˆé¸æŠæ¸ˆã¿ï¼‹freeTextã®ã¿ã‚’æŠ½å‡ºï¼‰
export function packProfileFromUI(ui: UIProfile): PackedProfile {
  const out: PackedProfile = {};

  for (const [topicId, options] of Object.entries(ui || {})) {
    // ç¾è¡ŒUIã«å­˜åœ¨ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹
    const topicDef = TOPICS[topicId as keyof typeof TOPICS];
    if (!topicDef) continue;

    const allowed = topicDef.options;
    const picked = Object.entries(options)
      .filter(([name, v]) => v?.selected && allowed.includes(name as any))
      .map(([name, v]) => ({ name, text: v.freeText || '' }));

    if (picked.length > 0) {
      out[topicId] = picked;
    }
  }

  return out;
}

// DB/LLMï¼ˆPackedå½¢å¼ï¼‰â†’ UIï¼ˆç¾è¡ŒUIã«ã‚ã‚‹é …ç›®ã®ã¿åæ˜ ï¼‰
export function expandProfileForUI(input: any): UIProfile {
  // ã¾ãšã€UIåˆæœŸå½¢çŠ¶ã‚’ä½œæˆ
  const ui: UIProfile = {};

  for (const [topicId, def] of Object.entries(TOPICS)) {
    ui[topicId] = {};
    def.options.forEach(opt => {
      ui[topicId][opt] = { selected: false, freeText: '' };
    });
  }

  if (!input || typeof input !== 'object') {
    return ui;
  }

  // Packedå½¢å¼ï¼ˆé…åˆ—ï¼‰ã®å‡¦ç†ã®ã¿
  for (const [topicId, val] of Object.entries(input)) {
    if (Array.isArray(val)) {
      for (const item of val) {
        const name = item?.name;
        // ç¾è¡ŒUIã«å­˜åœ¨ã™ã‚‹é …ç›®ã®ã¿åæ˜ 
        if (ui[topicId]?.[name]) {
          ui[topicId][name] = {
            selected: true,
            freeText: String(item?.text || '')
          };
        }
      }
    }
  }

  return ui;
}
</file>

<file path="src/lib/repos/counters.ts">
import { prisma } from "@/lib/db";

export async function getCounters(userId: string) {
  const counters = await prisma.counters.findUnique({
    where: { userId },
  });

  return {
    scanOut: counters?.scanOutCount ?? 0,
    scanIn: counters?.scanInCount ?? 0,
  };
}

export async function incrScanOutIn(scannerId: string, scannedId: string) {
  await prisma.$transaction([
    prisma.counters.upsert({
      where: { userId: scannerId },
      create: {
        userId: scannerId,
        scanOutCount: 1,
        scanInCount: 0,
      },
      update: {
        scanOutCount: { increment: 1 },
      },
    }),
    prisma.counters.upsert({
      where: { userId: scannedId },
      create: {
        userId: scannedId,
        scanOutCount: 0,
        scanInCount: 1,
      },
      update: {
        scanInCount: { increment: 1 },
      },
    }),
  ]);
}
</file>

<file path="src/lib/repos/profile.ts">
import { prisma } from "@/lib/db";

export async function getProfile(userId: string) {
  const profile = await prisma.profile.findUnique({
    where: { userId },
  });

  return profile ? JSON.parse(profile.profileJson) : null;
}

export async function upsertProfile(userId: string, profileData: any) {
  const profileJson = JSON.stringify(profileData);

  if (profileJson.length > 8192) {
    throw new Error("Profile data too large (max 8KB)");
  }

  return await prisma.profile.upsert({
    where: { userId },
    create: {
      userId,
      profileJson: profileJson,
    },
    update: {
      profileJson: profileJson,
    },
  });
}
</file>

<file path="src/lib/repos/users.ts">
import { prisma } from "@/lib/db";
import crypto from "crypto";

export async function createUser(userId: string, password: string) {
  const passwordHash = crypto.createHash("sha256").update(password).digest("hex");

  return await prisma.user.create({
    data: {
      userId,
      passwordHash,
    },
  });
}

export async function getUserByUserId(userId: string) {
  return await prisma.user.findUnique({
    where: { userId },
  });
}

export async function verifyPassword(userId: string, password: string) {
  const user = await getUserByUserId(userId);
  if (!user) return null;

  const passwordHash = crypto.createHash("sha256").update(password).digest("hex");
  if (user.passwordHash !== passwordHash) return null;

  return user;
}
</file>

<file path="src/lib/topics.ts">
export const TOPICS = {
  sports: {
    label: 'ã‚¹ãƒãƒ¼ãƒ„',
    icon: 'âš½',
    options: ['é‡çƒ', 'ã‚µãƒƒã‚«ãƒ¼', 'å“çƒ', 'ãƒ†ãƒ‹ã‚¹', 'ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«', 'ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«', 'ã‚´ãƒ«ãƒ•', 'ãã®ä»–']
  },
  music: {
    label: 'éŸ³æ¥½',
    icon: 'ğŸµ',
    options: ['J-POP', 'K-POP', 'ãƒ­ãƒƒã‚¯', 'ã‚¸ãƒ£ã‚º', 'ã‚¯ãƒ©ã‚·ãƒƒã‚¯', 'ã‚¢ãƒ‹ã‚½ãƒ³', 'ãƒœã‚«ãƒ­', 'ãã®ä»–']
  },
  food: {
    label: 'é£Ÿäº‹',
    icon: 'ğŸ•',
    options: ['å’Œé£Ÿ', 'æ´‹é£Ÿ', 'ä¸­è¯', 'ã‚¤ã‚¿ãƒªã‚¢ãƒ³', 'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰', 'ãŠè“å­ä½œã‚Š', 'ã‚«ãƒ•ã‚§', 'ãã®ä»–']
  },
  movies: {
    label: 'æ˜ ç”»ãƒ»ãƒ‰ãƒ©ãƒ',
    icon: 'ğŸ¬',
    options: ['é‚¦ç”»', 'æ´‹ç”»', 'éŸ“å›½ãƒ‰ãƒ©ãƒ', 'ã‚¢ãƒ‹ãƒ¡', 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼', 'ã‚³ãƒ¡ãƒ‡ã‚£', 'ãƒ›ãƒ©ãƒ¼', 'ãã®ä»–']
  },
  games: {
    label: 'ã‚²ãƒ¼ãƒ ',
    icon: 'ğŸ®',
    options: ['RPG', 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³', 'ãƒ‘ã‚ºãƒ«', 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', 'FPS', 'ãƒ¢ãƒã‚¤ãƒ«ã‚²ãƒ¼ãƒ ', 'ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ', 'ãã®ä»–']
  },
  books: {
    label: 'èª­æ›¸',
    icon: 'ğŸ“š',
    options: ['å°èª¬', 'æ¼«ç”»', 'ãƒ©ã‚¤ãƒˆãƒãƒ™ãƒ«', 'ãƒ“ã‚¸ãƒã‚¹æ›¸', 'è‡ªå·±å•“ç™º', 'æ­´å²', 'ç§‘å­¦', 'ãã®ä»–']
  }
} as const;
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "es2020",
    "lib": ["dom", "dom.iterable", "es2020"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
</file>

<file path="UI_IMPROVEMENT_TODO.md">
# ğŸ¨ UIæ”¹å–„TODOãƒªã‚¹ãƒˆ - é«˜æ ¡ç”Ÿå‘ã‘ãƒãƒƒãƒ—Ã—æœªæ¥æ„Ÿãƒ‡ã‚¶ã‚¤ãƒ³

## ğŸ“‹ å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºåˆ†å‰²

### ğŸ¯ ãƒ•ã‚§ãƒ¼ã‚º1: åŸºç›¤æ•´å‚™ï¼ˆãƒ™ãƒ¼ã‚¹ã‚«ãƒ©ãƒ¼ãƒ»ãƒ•ã‚©ãƒ³ãƒˆãƒ»ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
**ç›®æ¨™**: ã‚¢ãƒ—ãƒªå…¨ä½“ã®ãƒˆãƒ¼ãƒ³ï¼†ãƒãƒŠãƒ¼ã‚’çµ±ä¸€

- [x] 1-1. ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆå®šç¾©ï¼ˆCSSå¤‰æ•°åŒ–ï¼‰
  - ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼: ãƒ†ã‚£ãƒ¼ãƒ«ãƒ–ãƒ«ãƒ¼ (#28C7FA) + ãƒã‚¤ã‚ªãƒ¬ãƒƒãƒˆ (#9B5DE5)
  - ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼: ãƒã‚ªãƒ³ã‚¤ã‚¨ãƒ­ãƒ¼ (#FEE440)ã€ãƒ”ãƒ³ã‚¯ (#F15BB5)ã€ãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼ (#00BBF9)
  - ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©

- [x] 1-2. ãƒ•ã‚©ãƒ³ãƒˆå°å…¥
  - Google Fonts ã‹ã‚‰ Poppins ã‚’å°å…¥
  - æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆ: Noto Sans JPï¼ˆä¸¸ã¿ã®ã‚ã‚‹æ›¸ä½“ï¼‰

- [x] 1-3. Tailwind CSS ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
  - ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆè¿½åŠ 
  - ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ä½œæˆï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚°ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ï¼‰

- [x] 1-4. ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°ï¼ˆglobals.cssï¼‰
  - èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  - åŸºæœ¬çš„ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©

**âœ… ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ1**: å®Œäº†

---

### ğŸ¯ ãƒ•ã‚§ãƒ¼ã‚º2: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ«æ”¹å–„ï¼ˆãƒœã‚¿ãƒ³ãƒ»ã‚«ãƒ¼ãƒ‰ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«åŸºç¤ï¼‰
**ç›®æ¨™**: å†åˆ©ç”¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«å‘ä¸Š

- [x] 2-1. ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ
  - ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
  - ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆå…‰æ²¢æ„Ÿï¼‰
  - ã‚¯ãƒªãƒƒã‚¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

- [x] 2-2. ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ
  - ã‚¬ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ åŠ¹æœï¼ˆæ”¹å–„æ¸ˆã¿ï¼‰
  - ãƒã‚ªãƒ³é¢¨ãƒœãƒ¼ãƒ€ãƒ¼ï¼ˆæ”¹å–„æ¸ˆã¿ï¼‰
  - æµ®éŠæ„Ÿã®ã‚ã‚‹å½±

- [x] 2-3. ãƒ¢ãƒ¼ãƒ€ãƒ«åŸºç¤ã‚¹ã‚¿ã‚¤ãƒ«
  - èƒŒæ™¯ãƒ–ãƒ©ãƒ¼åŠ¹æœ
  - ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³/ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

- [x] 2-4. ã‚¢ã‚¤ã‚³ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå°å…¥
  - Lucide React å°å…¥æ¸ˆã¿
  - å¿…è¦ãªã‚¢ã‚¤ã‚³ãƒ³ã‚»ãƒƒãƒˆã®é¸å®š

**âœ… ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ2**: å®Œäº†

---

### ğŸ¯ ãƒ•ã‚§ãƒ¼ã‚º3: ãƒ›ãƒ¼ãƒ ç”»é¢ã®æ”¹å–„
**ç›®æ¨™**: ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’ãƒãƒƒãƒ—ã§æœªæ¥çš„ã«

- [x] 3-1. QRã‚³ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰å‹UI
  - ã‚¬ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ã‚«ãƒ¼ãƒ‰ï¼ˆå®Œäº†ï¼‰
  - å‘¨å›²ã®å…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆCSS ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ï¼ˆå®Œäº†ï¼‰
  - QRã‚³ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ï¼ˆå®Œäº†ï¼‰

- [x] 3-2. FABã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³
  - æµ®éŠæ„Ÿã®ã‚ã‚‹å††å½¢ãƒœã‚¿ãƒ³ï¼ˆå®Œäº†ï¼‰
  - ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Œäº†ï¼‰
  - ã‚¢ã‚¤ã‚³ãƒ³ï¼‹ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå®Œäº†ï¼‰
  - é…ç½®èª¿æ•´æ©Ÿèƒ½è¿½åŠ ï¼ˆplacement propï¼‰

- [x] 3-3. èƒŒæ™¯æ¼”å‡º
  - ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ï¼ˆå®Œäº†ï¼‰
  - ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆCanvaså®Ÿè£…ï¼‰ï¼ˆå®Œäº†ï¼‰
  - ã‚ªãƒ¼ãƒ–ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆå®Œäº†ï¼‰

- [x] 3-4. ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ”¹å–„
  - ã‚¢ã‚¤ã‚³ãƒ³ä»˜ãã‚¿ãƒ–ãƒãƒ¼ï¼ˆLucide Reactä½¿ç”¨ï¼‰ï¼ˆå®Œäº†ï¼‰
  - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆå®Œäº†ï¼‰
  - é·ç§»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Œäº†ï¼‰
  - ã‚¬ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ èƒŒæ™¯ï¼ˆå®Œäº†ï¼‰

**âœ… ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ3**: å®Œäº†ï¼ˆé…ç½®ä¿®æ­£æ¸ˆã¿ï¼‰

---

### ğŸ¯ ãƒ•ã‚§ãƒ¼ã‚º4: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢ã®æ”¹å–„
**ç›®æ¨™**: æ¥½ã—ãå…¥åŠ›ã§ãã‚‹ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–UI

- [x] 4-1. ã‚¿ã‚°å¼èˆˆå‘³é¸æŠUI
  - ã‚¢ã‚¤ã‚³ãƒ³ä»˜ãã‚«ãƒ©ãƒ•ãƒ«ã‚¿ã‚°ï¼ˆå®Œäº†ï¼‰
  - ã‚¿ãƒƒãƒ—æ™‚ã®è‰²å¤‰åŒ–ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Œäº†ï¼‰
  - é¸æŠæ•°ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¡¨ç¤ºï¼ˆå®Œäº†ï¼‰

- [x] 4-2. å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¬ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ 
  - é€æ˜æ„Ÿã®ã‚ã‚‹å…¥åŠ›æ¬„ï¼ˆå®Œäº†ï¼‰
  - ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®å…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆå®Œäº†ï¼‰

- [x] 4-3. ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  - æˆåŠŸæ™‚ã®ã€Œã‚­ãƒ©ãƒƒã€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆå®Œäº†ï¼‰
  - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®è¡¨ç¾ï¼ˆå®Œäº†ï¼‰

<!-- - [ ] 4-4. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å®Œæˆåº¦ãƒ¡ãƒ¼ã‚¿ãƒ¼
  - ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤º
  - é”æˆæ„Ÿã‚’æ¼”å‡º -->

**âœ… ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ4**: å®Œäº†

---

### ğŸ¯ ãƒ•ã‚§ãƒ¼ã‚º5: å®Ÿç¸¾ç”»é¢ãƒ»UIçµ±ä¸€ã®æ”¹å–„
**ç›®æ¨™**: å…¨ãƒšãƒ¼ã‚¸ã®çµ±ä¸€æ„Ÿã¨ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³

- [x] 5-1. å®Ÿç¸¾ç”»é¢ã®æ”¹å–„
  - ã‚¬ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ã‚«ãƒ¼ãƒ‰ï¼ˆå®Œäº†ï¼‰
  - ã‚¢ã‚¤ã‚³ãƒ³ä»˜ãå®Ÿç¸¾è¡¨ç¤ºï¼ˆå®Œäº†ï¼‰
  - ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è£…é£¾ï¼ˆå®Œäº†ï¼‰
  - æ•°å€¤ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼‰ï¼ˆå®Œäº†ï¼‰

- [x] 5-2. UIçµ±ä¸€åŒ–
  - å…¨ãƒšãƒ¼ã‚¸å…±é€šã®èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Œäº†ï¼‰
  - çµ±ä¸€ã•ã‚ŒãŸNavigationã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆå®Œäº†ï¼‰
  - ã‚¬ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ åŠ¹æœã®çµ±ä¸€ï¼ˆå®Œäº†ï¼‰
  - ãƒœã‚¿ãƒ³ãƒ»ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã®çµ±ä¸€ï¼ˆå®Œäº†ï¼‰

- [x] 5-3. è©±é¡Œãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ¼”å‡º
  - ãƒãƒ£ãƒƒãƒˆé¢¨å¹ãå‡ºã—UIï¼ˆå®Œäº†ï¼‰
  - ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Œäº†ï¼‰
  - AIé¢¨ã®æ³¢ç´‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆèƒŒæ™¯ï¼ˆå®Œäº†ï¼‰

- [x] 5-4. ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã®æ”¹å–„
  - ã‚«ãƒ©ãƒ•ãƒ«ãªãƒˆãƒ¼ã‚¹ãƒˆï¼ˆå®Œäº†ï¼‰
  - ã‚¢ã‚¤ã‚³ãƒ³ä»˜ãï¼ˆå®Œäº†ï¼‰
  - ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Œäº†ï¼‰

- [x] 5-5. å…¨ãƒšãƒ¼ã‚¸UIçµ±ä¸€ï¼ˆè¿½åŠ å®Ÿè£…ï¼‰
  - ãƒ«ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ï¼ˆ/ï¼‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³çµ±ä¸€ï¼ˆå®Œäº†ï¼‰
  - èªè¨¼ãƒšãƒ¼ã‚¸ï¼ˆlogin/signupï¼‰ã®çµ±ä¸€ï¼ˆå®Œäº†ï¼‰
  - ã‚¹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ã‚¸ã®çµ±ä¸€ï¼ˆå®Œäº†ï¼‰

**âœ… ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ5**: å®Œäº†

---

### ğŸ¯ ãƒ•ã‚§ãƒ¼ã‚º6: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ãƒ»å¾®èª¿æ•´
**ç›®æ¨™**: å®Ÿç”¨ãƒ¬ãƒ™ãƒ«ã®å®Œæˆåº¦ã¸

- [ ] 6-1. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æœ€é©åŒ–
  - é‡ã„å‡¦ç†ã®è»½é‡åŒ–
  - will-change ã®é©åˆ‡ãªä½¿ç”¨

- [ ] 6-2. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ
  - ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å„ã‚µã‚¤ã‚ºç¢ºèª
  - ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œ

- [ ] 6-3. ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£
  - ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆæ¯”ã®ç¢ºèª
  - ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ã®æ˜ç¢ºåŒ–

- [ ] 6-4. ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  - ã‚«ãƒ©ãƒ¼ã‚¹ã‚­ãƒ¼ãƒ åˆ‡ã‚Šæ›¿ãˆ
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®ä¿å­˜

**ğŸ”´ æœ€çµ‚ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ**: æœ¬ç•ªç’°å¢ƒã§ã®å‹•ä½œç¢ºèª

---

## ğŸš€ å®Ÿè£…é–‹å§‹é †åº

1. **ã¾ãšãƒ•ã‚§ãƒ¼ã‚º1ã‹ã‚‰é–‹å§‹** â†’ åŸºç›¤ãŒæ•´ã£ãŸã‚‰ä¸€åº¦ç¢ºèª
2. **ãƒ•ã‚§ãƒ¼ã‚º2ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ** â†’ å†åˆ©ç”¨ãƒ‘ãƒ¼ãƒ„å®Œæˆã§ç¢ºèª
3. **ãƒ•ã‚§ãƒ¼ã‚º3ã§ãƒ›ãƒ¼ãƒ ç”»é¢** â†’ ãƒ¡ã‚¤ãƒ³ç”»é¢å®Œæˆã§ç¢ºèª
4. **ãƒ•ã‚§ãƒ¼ã‚º4ã§ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«** â†’ å…¥åŠ›ç³»UIå®Œæˆã§ç¢ºèª
5. **ãƒ•ã‚§ãƒ¼ã‚º5ã§æ®‹ã‚Šç”»é¢** â†’ å…¨ç”»é¢å®Œæˆã§ç¢ºèª
6. **ãƒ•ã‚§ãƒ¼ã‚º6ã§ä»•ä¸Šã’** â†’ ãƒªãƒªãƒ¼ã‚¹æº–å‚™å®Œäº†

---

## ğŸ“ æ³¨æ„äº‹é …

- å„ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã¯å¿…ãš `npm run dev` ã§å‹•ä½œç¢ºèª
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ„è­˜ï¼ˆç‰¹ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
- ãƒ¢ãƒã‚¤ãƒ«ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã§å®Ÿè£…
- æ—¢å­˜æ©Ÿèƒ½ã‚’å£Šã•ãªã„ã‚ˆã†æ®µéšçš„ã«æ”¹å–„

---

## ğŸ¯ ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

**ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º**: ãƒ•ã‚§ãƒ¼ã‚º5å®Œäº†
**æ¬¡ã®ã‚¿ã‚¹ã‚¯**: ãƒ•ã‚§ãƒ¼ã‚º6ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

### ğŸ“… é€²æ—è¨˜éŒ²
- **2024/12/30**: ãƒ•ã‚§ãƒ¼ã‚º1ã€œ3å®Œäº†
  - åŸºç›¤æ•´å‚™ï¼ˆã‚«ãƒ©ãƒ¼ã€ãƒ•ã‚©ãƒ³ãƒˆã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
  - ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆï¼ˆButtonã€Cardã€Modalã€FABï¼‰
  - ãƒ›ãƒ¼ãƒ ç”»é¢æ”¹å–„ï¼ˆQRã‚«ãƒ¼ãƒ‰ã€èƒŒæ™¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  - ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³é…ç½®ä¿®æ­£

- **2025/01/01**: ãƒ•ã‚§ãƒ¼ã‚º4ã€œ5å®Œäº†
  - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢æ”¹å–„ï¼ˆã‚¿ã‚°å¼é¸æŠUIã€ã‚¬ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ã€ä¿å­˜ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  - å®Ÿç¸¾ç”»é¢æ”¹å–„ï¼ˆã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã€ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã€ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼‰
  - å…¨ãƒšãƒ¼ã‚¸UIçµ±ä¸€åŒ–ï¼ˆå…±é€šèƒŒæ™¯ã€Navigationã€ã‚¹ã‚¿ã‚¤ãƒ«çµ±ä¸€ï¼‰
  - è©±é¡Œãƒ¢ãƒ¼ãƒ€ãƒ«æ”¹å–„ï¼ˆãƒãƒ£ãƒƒãƒˆé¢¨UIã€ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  - ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥æ”¹å–„ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ï¼‰
  - èªè¨¼ãƒšãƒ¼ã‚¸ãƒ»ã‚¹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ã‚¸ã®UIçµ±ä¸€

---

*ã“ã®TODOãƒªã‚¹ãƒˆã¯é€²æ—ã«å¿œã˜ã¦æ›´æ–°ã•ã‚Œã¾ã™*
</file>

<file path=".claude/settings.local.json">
{
  "permissions": {
    "allow": [
      "Bash(npm run dev:*)",
      "Bash(curl:*)",
      "Bash(npm install:*)",
      "Bash(npx prisma generate:*)",
      "Bash(npx prisma:*)",
      "Bash(tasklist)",
      "Bash(taskkill:*)",
      "Bash(cp:*)"
    ],
    "deny": [],
    "ask": []
  }
}
</file>

<file path="next.config.js">
/** @type {import('next').NextConfig} */
const nextConfig = {};

module.exports = nextConfig;
</file>

<file path="src/app/page.tsx">
'use client'

import { useState } from 'react'
import Link from 'next/link'
import { QrCode, UserPlus, LogIn, Sparkles, MessageCircle, Users } from 'lucide-react'

export default function HomePage() {
  const [isLoggedIn, setIsLoggedIn] = useState(false)

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-600 via-teal-500 to-blue-600 flex items-center justify-center">
      <div className="max-w-md w-full mx-auto p-4">
        {/* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ */}
        <div className="backdrop-blur-lg bg-white/90 rounded-3xl shadow-2xl p-8
                      transform transition-all duration-300 hover:scale-[1.02]">

          {/* ãƒ­ã‚´ãƒ»ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ† */}
          <div className="text-center mb-8">
            <div className="inline-flex p-4 bg-gradient-to-br from-purple-500 to-teal-500 rounded-full mb-4 shadow-lg">
              <QrCode className="w-12 h-12 text-white" />
            </div>
            <h1 className="text-3xl font-bold bg-gradient-to-r from-purple-600 to-teal-500 bg-clip-text text-transparent mb-3">
              QR Connect
            </h1>
            <p className="text-gray-600 text-sm leading-relaxed">
              QRã‚³ãƒ¼ãƒ‰ã§ç¹‹ãŒã‚‹æ–°ã—ã„å‡ºä¼šã„<br />
              AIãŒè©±é¡Œã‚’ææ¡ˆã—ã¦ãã‚Œã‚‹äº¤æµã‚¢ãƒ—ãƒª
            </p>
          </div>

          {/* ç‰¹å¾´ */}
          <div className="grid grid-cols-3 gap-4 mb-8">
            <div className="text-center">
              <div className="p-3 bg-purple-100 rounded-xl mb-2 mx-auto w-fit">
                <QrCode className="w-6 h-6 text-purple-600" />
              </div>
              <p className="text-xs text-gray-600">ç°¡å˜QRäº¤æ›</p>
            </div>
            <div className="text-center">
              <div className="p-3 bg-pink-100 rounded-xl mb-2 mx-auto w-fit">
                <Sparkles className="w-6 h-6 text-pink-600" />
              </div>
              <p className="text-xs text-gray-600">AIè©±é¡Œææ¡ˆ</p>
            </div>
            <div className="text-center">
              <div className="p-3 bg-teal-100 rounded-xl mb-2 mx-auto w-fit">
                <Users className="w-6 h-6 text-teal-600" />
              </div>
              <p className="text-xs text-gray-600">æ–°ã—ã„å‡ºä¼šã„</p>
            </div>
          </div>

          {!isLoggedIn ? (
            <div className="space-y-3">
              {/* ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ */}
              <Link
                href="/auth/login"
                className="block w-full py-4 px-6 rounded-2xl font-bold text-white text-lg
                         bg-gradient-to-r from-purple-500 via-pink-500 to-teal-500
                         transform transition-all duration-300 hover:scale-105 hover:shadow-xl
                         active:scale-95 relative overflow-hidden group"
              >
                <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent
                                -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
                </div>
                <span className="relative flex items-center justify-center gap-3">
                  <LogIn className="w-5 h-5" />
                  ãƒ­ã‚°ã‚¤ãƒ³
                </span>
              </Link>

              {/* æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³ */}
              <Link
                href="/auth/signup"
                className="block w-full py-4 px-6 rounded-2xl font-bold text-gray-700 text-lg
                         backdrop-blur-lg bg-white/60 border-2 border-white/50
                         transform transition-all duration-300 hover:scale-105 hover:shadow-xl hover:bg-white/80
                         active:scale-95"
              >
                <span className="flex items-center justify-center gap-3">
                  <UserPlus className="w-5 h-5" />
                  æ–°è¦ç™»éŒ²
                </span>
              </Link>

              <p className="text-center text-xs text-gray-500 mt-4">
                ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦å§‹ã‚ã¾ã—ã‚‡ã†
              </p>
            </div>
          ) : (
            <div className="text-center">
              <div className="inline-flex p-3 bg-green-100 rounded-full mb-4">
                <MessageCircle className="w-8 h-8 text-green-600" />
              </div>
              <p className="text-gray-600 mb-6">ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§ã™</p>
              <Link
                href="/home"
                className="inline-flex items-center gap-2 py-3 px-6
                         bg-gradient-to-r from-purple-500 to-teal-500 text-white
                         rounded-2xl font-bold hover:scale-105 transition-all duration-300 shadow-lg"
              >
                ãƒ›ãƒ¼ãƒ ã«é€²ã‚€
                <Sparkles className="w-4 h-4" />
              </Link>
            </div>
          )}
        </div>

        {/* ãƒ•ãƒƒã‚¿ãƒ¼ */}
        <p className="text-center text-white/60 text-xs mt-6">
          Â© 2025 QR Connect - Powered by AI
        </p>
      </div>
    </div>
  )
}
</file>

<file path="src/components/ClientAnalytics.tsx">
"use client";

import { usePathname, useSearchParams } from "next/navigation";
import { useEffect, Suspense } from "react";

const GA_ID = process.env.NEXT_PUBLIC_GA_ID;

declare global {
  interface Window {
    gtag?: (...args: any[]) => void;
  }
}

function Analytics() {
  const pathname = usePathname();
  const searchParams = useSearchParams();

  useEffect(() => {
    if (!GA_ID || !pathname) return;
    const url = pathname + (searchParams?.toString() ? `?${searchParams}` : "");
    // SPAé·ç§»ã”ã¨ã«page_view
    window.gtag?.("config", GA_ID, { page_path: url });
  }, [pathname, searchParams]);

  return null;
}

export default function ClientAnalytics() {
  return (
    <Suspense fallback={null}>
      <Analytics />
    </Suspense>
  );
}
</file>

<file path="src/components/Toast.tsx">
'use client'

import { useEffect, useState } from 'react'
import { CheckCircle, XCircle, AlertCircle, X } from 'lucide-react'

interface ToastProps {
  message: string
  type: 'success' | 'error' | 'warning'
  isVisible: boolean
  onClose: () => void
  duration?: number
}

export default function Toast({
  message,
  type,
  isVisible,
  onClose,
  duration = 4000
}: ToastProps) {
  const [isAnimating, setIsAnimating] = useState(false)

  useEffect(() => {
    if (isVisible) {
      setIsAnimating(true)
      const timer = setTimeout(() => {
        setIsAnimating(false)
        setTimeout(onClose, 300) // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«ã‚¯ãƒ­ãƒ¼ã‚º
      }, duration)
      return () => clearTimeout(timer)
    }
  }, [isVisible, onClose, duration])

  if (!isVisible) return null

  const styles = {
    success: {
      bg: 'from-green-500 to-teal-500',
      border: 'border-green-400',
      icon: CheckCircle,
      iconColor: 'text-white',
      glow: 'shadow-green-500/50'
    },
    error: {
      bg: 'from-red-500 to-pink-500',
      border: 'border-red-400',
      icon: XCircle,
      iconColor: 'text-white',
      glow: 'shadow-red-500/50'
    },
    warning: {
      bg: 'from-yellow-400 to-orange-500',
      border: 'border-yellow-400',
      icon: AlertCircle,
      iconColor: 'text-white',
      glow: 'shadow-yellow-500/50'
    }
  }[type]

  const Icon = styles.icon

  return (
    <div className={`fixed top-20 right-4 z-50 transition-all duration-300 transform
                    ${isAnimating ? 'translate-x-0 opacity-100' : 'translate-x-full opacity-0'}`}>
      <div className={`backdrop-blur-lg bg-white/90 rounded-2xl shadow-2xl overflow-hidden
                      border ${styles.border} max-w-sm
                      transform transition-all duration-300 hover:scale-105 ${styles.glow}`}>
        {/* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div className={`h-1.5 bg-gradient-to-r ${styles.bg}`}></div>

        <div className="px-4 py-3">
          <div className="flex items-start gap-3">
            {/* ã‚¢ã‚¤ã‚³ãƒ³ */}
            <div className={`p-2 rounded-full bg-gradient-to-br ${styles.bg} flex-shrink-0
                          shadow-lg transform transition-transform duration-300 hover:rotate-12`}>
              <Icon className={`w-5 h-5 ${styles.iconColor}`} />
            </div>

            {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
            <div className="flex-1 pt-1">
              <p className="text-gray-800 font-medium text-sm leading-relaxed">
                {message}
              </p>
            </div>

            {/* ã‚¯ãƒ­ãƒ¼ã‚ºãƒœã‚¿ãƒ³ */}
            <button
              onClick={() => {
                setIsAnimating(false)
                setTimeout(onClose, 300)
              }}
              className="p-1 hover:bg-gray-100 rounded-full transition-colors group"
            >
              <X className="w-4 h-4 text-gray-400 group-hover:text-gray-600" />
            </button>
          </div>

          {/* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */}
          <div className="mt-3 h-1 bg-gray-200 rounded-full overflow-hidden">
            <div
              className={`h-full bg-gradient-to-r ${styles.bg} rounded-full transition-all`}
              style={{
                animation: `shrink ${duration}ms linear`,
                transformOrigin: 'left'
              }}
            />
          </div>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="src/lib/cooldown.ts">
const mem = new Map<string, number>();
const WINDOW = 5_000; // 5 seconds - éå‰°ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢ç”¨ã®çŸ­ã„ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³

export async function canScan(scannerId: string, scannedId: string) {
  const key = `${scannerId}:${scannedId}`;
  const now = Date.now();
  const last = mem.get(key) ?? 0;

  if (now - last < WINDOW) {
    return { ok: false, waitMs: WINDOW - (now - last) };
  }

  mem.set(key, now);
  return { ok: true };
}

setInterval(() => {
  const now = Date.now();
  for (const [key, time] of mem.entries()) {
    if (now - time > WINDOW) {
      mem.delete(key);
    }
  }
}, WINDOW);
</file>

<file path="src/lib/qr.ts">
import QRCode from "qrcode";

export async function generateQR(url: string): Promise<string> {
  try {
    const svg = await QRCode.toString(url, {
      type: "svg",
      errorCorrectionLevel: "M",
      margin: 2,  // QRå†…å´ã«å‡ç­‰ãªç™½ç¸ã‚’ç¢ºä¿
    });
    return svg;
  } catch (error) {
    console.error("QR generation error:", error);
    throw new Error("Failed to generate QR code");
  }
}
</file>

<file path="src/lib/session.ts">
import { cookies } from "next/headers";
import crypto from "crypto";

const NAME = "sid";
const MAX_AGE = Number(process.env.SESSION_MAX_AGE_SECONDS || 86400);
const SECRET = process.env.SESSION_SECRET!;

export function issueTicket(userId: string) {
  const exp = Math.floor(Date.now() / 1000) + MAX_AGE;
  const payload = `${userId}.${exp}`;
  const sig = crypto.createHmac("sha256", SECRET).update(payload).digest("hex");
  return `${payload}.${sig}`;
}

export function setSessionCookie(resp: any, userId: string) {
  const ticket = issueTicket(userId);
  resp.cookies.set(NAME, ticket, {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    sameSite: "lax",  // Changed from "strict" to "lax" for mobile compatibility
    path: "/",
    maxAge: MAX_AGE,
  });
}

export function clearSessionCookie(resp: any) {
  resp.cookies.set(NAME, "", {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    sameSite: "lax",  // Changed from "strict" to "lax" for consistency
    path: "/",
    maxAge: 0,
  });
}

export function requireSession() {
  const raw = cookies().get(NAME)?.value;
  if (!raw) throw new Error("UNAUTH");

  const parts = raw.split(".");
  if (parts.length !== 3) throw new Error("INVALID_FORMAT");

  const [userId, expStr, sig] = parts;
  const exp = Number(expStr);
  const now = Math.floor(Date.now() / 1000);

  if (now > exp) throw new Error("EXPIRED");

  const payload = `${userId}.${exp}`;
  const expected = crypto.createHmac("sha256", SECRET).update(payload).digest("hex");

  if (expected !== sig) throw new Error("BADSIG");

  return { userId };
}
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      colors: {
        // ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼
        'app-teal': '#28C7FA',
        'app-violet': '#9B5DE5',
        // ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼
        'app-yellow': '#FEE440',
        'app-pink': '#F15BB5',
        'app-light-blue': '#00BBF9',
      },
      fontFamily: {
        'sans': ['var(--font-noto-sans-jp)', 'var(--font-poppins)', 'system-ui'],
        'poppins': ['var(--font-poppins)', 'system-ui'],
      },
      backgroundImage: {
        'gradient-main': 'linear-gradient(135deg, #28C7FA 0%, #9B5DE5 100%)',
        'gradient-pop': 'linear-gradient(135deg, #F15BB5 0%, #FEE440 100%)',
        'gradient-cool': 'linear-gradient(135deg, #00BBF9 0%, #28C7FA 100%)',
        'gradient-bg': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
      },
      boxShadow: {
        'neon-teal': '0 0 20px rgba(40, 199, 250, 0.5)',
        'neon-violet': '0 0 20px rgba(155, 93, 229, 0.5)',
        'neon-pink': '0 0 20px rgba(241, 91, 181, 0.5)',
        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.37)',
      },
      animation: {
        'pulse-neon': 'pulse-neon 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
        'float': 'float 3s ease-in-out infinite',
        'glow': 'glow 2s ease-in-out infinite',
      },
      keyframes: {
        'pulse-neon': {
          '0%, 100%': {
            boxShadow: '0 0 20px rgba(40, 199, 250, 0.5), 0 0 40px rgba(40, 199, 250, 0.3)',
          },
          '50%': {
            boxShadow: '0 0 30px rgba(40, 199, 250, 0.8), 0 0 60px rgba(40, 199, 250, 0.5)',
          },
        },
        'float': {
          '0%, 100%': { transform: 'translateY(0)' },
          '50%': { transform: 'translateY(-10px)' },
        },
        'glow': {
          '0%, 100%': { opacity: '1' },
          '50%': { opacity: '0.7' },
        },
      },
      backdropFilter: {
        'glass': 'blur(20px) saturate(180%)',
      },
    },
  },
  plugins: [],
};
</file>

<file path=".gitignore">
# dependencies
/node_modules
/.pnp
.pnp.js

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# local env files
.env*.local
.env

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.tsrepomix-output.xml
</file>

<file path="CLAUDE.md">
# CLAUDE.md â€” POCã€Œé«˜æ ¡ç”Ÿå‘ã‘QRãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«Ã—è©±é¡Œæç¤ºã€å®Ÿè£…ã‚¬ã‚¤ãƒ‰

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ **Vercel** ã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€**Gemini**ï¼ˆGoogle Generative AIï¼‰ã‚’ç”¨ã„ã¦ã€Œè©±é¡Œã‚’1ä»¶ã ã‘ã€ç”Ÿæˆã™ã‚‹Webã‚¢ãƒ—ãƒªã§ã™ã€‚  
é–‹ç™ºã¯ **Claude Code**ï¼ˆanthropic/claude-codeï¼‰ã§ã®ãƒšã‚¢ãƒ—ãƒ­ãƒ»è‡ªå‹•åŒ–ã‚’æƒ³å®šã—ãŸæ‰‹é †ãƒ»ã‚¿ã‚¹ã‚¯ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

---

## 0. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¦ç´„
- ç›®çš„ï¼šQRäº¤æ› â†’ GeminiãŒ**ä¼šè©±ã®æœ€åˆã®ã²ã¨è¨€ï¼ˆ1ä»¶ï¼‰**ã‚’æç¤º  
- ä¸»è¦ãƒšãƒ¼ã‚¸ï¼š
  - **ãƒ›ãƒ¼ãƒ **ï¼šè‡ªåˆ†ã®QRï¼ˆå¤§ï¼‰ï¼‹ã€Œç›¸æ‰‹ã®QRã‚’èª­ã¿å–ã‚‹ã€ãƒœã‚¿ãƒ³ã€è©±é¡Œã¯ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º  
  - **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«**ï¼šãƒˆãƒ”ãƒƒã‚¯â†’é¸æŠè‚¢â†’ä»»æ„å…¥åŠ›ï¼ˆPUTã§å…¨ç½®æ›ï¼‰  
  - **å®Ÿç¸¾**ï¼šè‡ªåˆ†ã® `scanOut / scanIn` æ•°å€¤ã®ã¿  
- ä¸»è¦APIï¼š
  - `POST /api/auth/signup|login|logout`ï¼ˆç½²åä»˜ãCookieã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰
  - `GET/PUT /api/profile/me`
  - `GET /api/qr/me`ï¼ˆURLï¼‹SVGè¿”å´ï¼‰
  - `POST /api/scan`ï¼ˆ30ç§’ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ / messageè¿”å´ï¼‰
  - `GET /api/metrics/me`ï¼ˆã‚«ã‚¦ãƒ³ãƒˆã®ã¿ï¼‰
- DBã¯ **User / Profile / Counters** ã®3è¡¨åˆ†é›¢è¨­è¨ˆã€‚  
- ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã¯ **30ç§’**ï¼ˆæœ¬ç•ªã¯KVæ¨å¥¨ã€é–‹ç™ºã¯ in-memoryï¼‰ã€‚

---

## 1. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **Framework**: Next.js 14ï¼ˆApp Routerï¼‰
- **Runtime**: Node.js 18+ï¼ˆVercelæ¨å¥¨ï¼‰
- **DB**: PostgreSQLï¼ˆNeon ã¾ãŸã¯ Supabase ç„¡æ–™æ  / Prismaï¼‰
- **LLM**: **Gemini 1.5**ï¼ˆGoogle Generative AI / @google/generative-aiï¼‰
- **Auth**: ç½²åä»˜ãCookieï¼ˆHMACï¼‰
- **QR**: SVGç”Ÿæˆï¼ˆ`qrcode`ï¼‰
- **Cooldown**: Vercel KVï¼ˆæœ¬ç•ªæ¨å¥¨ï¼‰ / é–‹ç™ºã¯ in-memory Map
- **UI**: React + Tailwindï¼ˆæ¨å¥¨ï¼‰

---

## 2. ç’°å¢ƒå¤‰æ•°ï¼ˆ.env.localï¼‰
DATABASE_URL=postgres://...
SESSION_SECRET=ãƒ©ãƒ³ãƒ€ãƒ é•·æ–‡å­—åˆ—
SESSION_MAX_AGE_SECONDS=86400
APP_BASE_URL=http://localhost:3000

GOOGLE_GEMINI_API_KEY=xxxxxxxxxxxxxxxx

---

## 3. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
```
/src
  /app
    /api
      /auth
        login/route.ts
        logout/route.ts
        signup/route.ts
      /profile/me/route.ts
      /qr/me/route.ts
      /scan/route.ts
      /metrics/me/route.ts
    layout.tsx
    page.tsx
    globals.css
  /lib
    db.ts
    session.ts       # HMACç½²åCookie
    llm.ts           # Geminiå‘¼ã³å‡ºã—
    qr.ts            # QRç”Ÿæˆ
    cooldown.ts      # ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
    repos/
      users.ts
      profile.ts
      counters.ts
  /components
    QrCard.tsx
    TopicModal.tsx
    Toast.tsx
    Navigation.tsx
    CameraScanner.tsx
/prisma
  schema.prisma
package.json
tsconfig.json
next.config.js
tailwind.config.js
postcss.config.js
.env.local
CLAUDE.md

---

## 4. UXè¨­è¨ˆãƒ»ç”»é¢ä»•æ§˜

### 4.1 ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ3ã‚¿ãƒ–ï¼‰
1. **ãƒ›ãƒ¼ãƒ ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰**
   - ä¸Šéƒ¨ï¼šè‡ªåˆ†ã®QRï¼ˆå¤§ããè¡¨ç¤ºï¼‰
   - ä¸‹éƒ¨ï¼šï¼»ç›¸æ‰‹ã®QRã‚’èª­ã¿å–ã‚‹ï¼½ãƒœã‚¿ãƒ³
   - ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸ â†’ ãƒ›ãƒ¼ãƒ ä¸Šã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è©±é¡Œè¡¨ç¤º â†’ ï¼»é–‰ã˜ã‚‹ï¼½ã§ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹

2. **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«**
   - ãƒˆãƒ”ãƒƒã‚¯ï¼ˆä¾‹ï¼šéŸ³æ¥½ã€ã‚¹ãƒãƒ¼ãƒ„ã€è¶£å‘³ç­‰ï¼‰â†’ é¸æŠè‚¢ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰
   - é¸æŠæ™‚ã®ã¿ä»»æ„ã®è‡ªç”±å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¡¨ç¤º
   - ï¼»ä¿å­˜ï¼½ãƒœã‚¿ãƒ³ã§PUTå…¨ç½®æ›

3. **å®Ÿç¸¾**
   - æ•°å€¤ã®ã¿ã‚·ãƒ³ãƒ—ãƒ«è¡¨ç¤ºï¼š
     - `scanOut`ï¼ˆèª­ã‚“ã å›æ•°ï¼‰
     - `scanIn`ï¼ˆèª­ã¾ã‚ŒãŸå›æ•°ï¼‰

### 4.2 èª­ã¿å–ã‚Šç”»é¢
- å…¨ç”»é¢ã‚«ãƒ¡ãƒ©ãƒ“ãƒ¥ãƒ¼
- QRæ¤œå‡º â†’ `POST /api/scan`
- **429ï¼ˆã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰æ™‚**ï¼šãƒ¢ãƒ¼ãƒ€ãƒ«å‡ºã•ãšã€**ãƒˆãƒ¼ã‚¹ãƒˆ**ã€Œæ™‚é–“ã‚’ãŠã„ã¦ãƒˆãƒ©ã‚¤ã—ã¦ãã ã•ã„ â³ã€

### 4.3 è©±é¡Œè¡¨ç¤º
- ãƒ¢ãƒ¼ãƒ€ãƒ«ã§**1ä»¶ã ã‘**è¡¨ç¤ºï¼ˆæ•¬ä½“ï¼1â€“2æ–‡ï¼è³ªå•ã§çµ‚ãˆã‚‹ï¼‰
- ï¼»é–‰ã˜ã‚‹ï¼½ã§ãƒ›ãƒ¼ãƒ ã¸ï¼ˆè‡ªåˆ†ã®QRãŒå†ã³å¤§ããè¡¨ç¤ºï¼‰

---

## 5. APIä»•æ§˜è©³ç´°

### 5.1 Auth
- `POST /api/auth/signup`
  - Body: `{ userId: string, password: string }`
  - æˆåŠŸ: 200 `{ok:true}` + `Set-Cookie: sid=...`
  - é‡è¤‡ID: 409 `{error:"user_exists"}`

- `POST /api/auth/login`
  - Body: `{ userId: string, password: string }`
  - æˆåŠŸ: 200 `{ok:true}` + `Set-Cookie: sid=...`
  - å¤±æ•—: 401 `{error:"invalid_credentials"}`

- `POST /api/auth/logout`
  - æˆåŠŸ: 200 `{ok:true}`ï¼ˆCookieç ´æ£„ï¼‰

### 5.2 Profileï¼ˆèªè¨¼å¿…é ˆï¼‰
- `GET /api/profile/me`
  - æˆåŠŸ: 200 `{...profileJson}`
  - æœªä½œæˆ: 404 or `{}`

- `PUT /api/profile/me`
  - Body: `{ ...profileJson }` ï¼ˆã‚µã‚¤ã‚ºä¸Šé™8KBï¼‰
  - æˆåŠŸ: 200 `{ok:true}`

### 5.3 QRï¼ˆèªè¨¼å¿…é ˆï¼‰
- `GET /api/qr/me`
  - æˆåŠŸ: 200 `{ "url": "https://app/scan?sid=<UUID>", "svg": "<svg...>" }`

### 5.4 Scanï¼ˆèªè¨¼å¿…é ˆï¼‰
- `POST /api/scan`
  - Body: `{ "scannedSid": "<ç›¸æ‰‹User.id(UUID)>" }`
  - æ¤œè¨¼ï¼šè‡ªå·±ã‚¹ã‚­ãƒ£ãƒ³â†’400ã€ç›¸æ‰‹ä¸åœ¨â†’404
  - ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³30ç§’â†’429 `{"error":"cooldown","message":"æ™‚é–“ã‚’ãŠã„ã¦ãƒˆãƒ©ã‚¤ã—ã¦ãã ã•ã„"}`
  - æˆåŠŸâ†’200 `{ "message": "äºŒäººã¨ã‚‚éŸ³æ¥½ãŒå¥½ãã¿ãŸã„ã§ã™ã­ã€‚æœ€è¿‘ã‚ˆãè´ãæ›²ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ" }`
  - å‰¯ä½œç”¨ï¼š`scanOut++` / `scanIn++`

### 5.5 Metricsï¼ˆèªè¨¼å¿…é ˆï¼‰
- `GET /api/metrics/me`
  - æˆåŠŸ: 200 `{ "scanOut": number, "scanIn": number }`

### 5.6 å…±é€šã‚¨ãƒ©ãƒ¼
| çŠ¶æ…‹ | HTTP | è¿”å´ä¾‹ |
|------|-----:|--------|
| æœªãƒ­ã‚°ã‚¤ãƒ³ | 401 | `{"error":"unauthorized"}` |
| è‡ªå·±ã‚¹ã‚­ãƒ£ãƒ³ | 400 | `{"error":"self_scan"}` |
| ç›¸æ‰‹ä¸åœ¨ | 404 | `{"error":"user_not_found"}` |
| ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ | 429 | `{"error":"cooldown","message":"æ™‚é–“ã‚’ãŠã„ã¦ãƒˆãƒ©ã‚¤ã—ã¦ãã ã•ã„"}` |
| äºˆæœŸã›ã¬ | 500 | `{"error":"internal"}` |

---

## 6. Prisma ã‚¹ã‚­ãƒ¼ãƒ
```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  userId       String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  profile      Profile?
  counters     Counters?
}

model Profile {
  userId      String   @id
  profileJson Json
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Counters {
  userId        String   @id
  scanOutCount  Int      @default(0)
  scanInCount   Int      @default(0)
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
```

---

## 5. ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆHMACç½²åä»˜ãCookieï¼‰
```ts
// lib/session.ts
import { cookies } from "next/headers";
import crypto from "crypto";

const NAME = "sid";
const MAX_AGE = Number(process.env.SESSION_MAX_AGE_SECONDS || 86400);
const SECRET = process.env.SESSION_SECRET!;

export function issueTicket(userId: string) {
  const exp = Math.floor(Date.now() / 1000) + MAX_AGE;
  const payload = `${userId}.${exp}`;
  const sig = crypto.createHmac("sha256", SECRET).update(payload).digest("hex");
  return `${payload}.${sig}`;
}

export function setSessionCookie(resp: any, userId: string) {
  const ticket = issueTicket(userId);
  resp.cookies.set(NAME, ticket, {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    sameSite: "strict",
    path: "/",
    maxAge: MAX_AGE,
  });
}

export function requireSession() {
  const raw = cookies().get(NAME)?.value;
  if (!raw) throw new Error("UNAUTH");
  const [userId, expStr, sig] = raw.split(".");
  const exp = Number(expStr);
  const now = Math.floor(Date.now() / 1000);
  if (now > exp) throw new Error("EXPIRED");
  const payload = `${userId}.${exp}`;
  const expect = crypto.createHmac("sha256", SECRET).update(payload).digest("hex");
  if (expect !== sig) throw new Error("BADSIG");
  return { userId };
}
```

---

## 6. ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³å®Ÿè£…
```ts
// lib/cooldown.ts
let mem = new Map<string, number>();
const WINDOW = 30_000;

export async function canScan(scannerId: string, scannedId: string) {
  const key = `${scannerId}:${scannedId}`;
  const now = Date.now();
  const last = mem.get(key) ?? 0;
  if (now - last < WINDOW) return { ok: false, waitMs: WINDOW - (now - last) };
  mem.set(key, now);
  return { ok: true };
}
```

---

## 7. Gemini å‘¼ã³å‡ºã—
```ts
// lib/llm.ts
import { GoogleGenerativeAI } from "@google/generative-ai";

const genAI = new GoogleGenerativeAI(process.env.GOOGLE_GEMINI_API_KEY!);
const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

const SYSTEM = `ã‚ãªãŸã¯é«˜æ ¡ç”Ÿã®åˆå¯¾é¢ã®ä¼šè©±ã‚’åŠ©ã‘ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
å®‰å…¨ç¬¬ä¸€ï¼ˆæ”¿æ²»/å®—æ•™/æ€§/ç—…æ°—/é‡‘éŠ­/å€‹äººç‰¹å®šã¯æ‰±ã‚ãªã„ï¼‰ã€‚
å‡ºåŠ›ã¯æ•¬ä½“ã§1ã€œ2æ–‡ã€æœ€å¾Œã¯è³ªå•ã§çµ‚ãˆã‚‹ã€‚å‡ºåŠ›ã¯1ä»¶ã®ã¿ã€‚`;

export async function generateTopic(profileA: any, profileB: any): Promise<string> {
  try {
    const prompt = [
      { role: "user", parts: [{ text: SYSTEM }] },
      { role: "user", parts: [{ text: `A=${JSON.stringify(profileA)}\nB=${JSON.stringify(profileB)}\nå‡ºåŠ›ã¯ {"message":"..."} å½¢å¼ã§ã€‚`} ] },
    ];
    const res = await model.generateContent({ contents: prompt });
    const msg = JSON.parse(res.response.text().trim()).message;
    return msg;
  } catch {
    return "éŸ³æ¥½ã¯ã‚ˆãè´ãã¾ã™ã‹ï¼Ÿæœ€è¿‘ã®ãŠæ°—ã«å…¥ã‚ŠãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚";
  }
}
```

---

## 8. API ã‚µãƒ³ãƒ—ãƒ«

### QR
```ts
// app/api/qr/me/route.ts
import { NextResponse } from "next/server";
import { requireSession } from "@/lib/session";
import QRCode from "qrcode";

export async function GET() {
  const me = requireSession();
  const url = `${process.env.APP_BASE_URL}/scan?sid=${me.userId}`;
  const svg = await QRCode.toString(url, { type: "svg", errorCorrectionLevel: "M", margin: 0 });
  return NextResponse.json({ url, svg });
}
```

### ã‚¹ã‚­ãƒ£ãƒ³
```ts
// app/api/scan/route.ts
import { NextResponse } from "next/server";
import { requireSession } from "@/lib/session";
import { prisma } from "@/lib/db";
import { getProfile } from "@/lib/repos/profile";
import { incrScanOutIn } from "@/lib/repos/counters";
import { generateTopic } from "@/lib/llm";
import { canScan } from "@/lib/cooldown";

export async function POST(req: Request) {
  try {
    const me = requireSession();
    const { scannedSid } = await req.json();
    if (!scannedSid) return NextResponse.json({ error: "bad_request" }, { status: 400 });
    if (me.userId === scannedSid) return NextResponse.json({ error: "self_scan" }, { status: 400 });

    const scanned = await prisma.user.findUnique({ where: { id: scannedSid } });
    if (!scanned) return NextResponse.json({ error: "user_not_found" }, { status: 404 });

    const cd = await canScan(me.userId, scanned.id);
    if (!cd.ok) return NextResponse.json({ error: "cooldown", message: "æ™‚é–“ã‚’ãŠã„ã¦ãƒˆãƒ©ã‚¤ã—ã¦ãã ã•ã„" }, { status: 429 });

    const [pa, pb] = await Promise.all([getProfile(me.userId), getProfile(scanned.id)]);
    const message = await generateTopic(pa ?? {}, pb ?? {});
    await incrScanOutIn(me.userId, scanned.id);

    return NextResponse.json({ message });
  } catch {
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}
```

### å®Ÿç¸¾
```ts
// app/api/metrics/me/route.ts
import { NextResponse } from "next/server";
import { requireSession } from "@/lib/session";
import { prisma } from "@/lib/db";

export async function GET() {
  const me = requireSession();
  const c = await prisma.counters.findUnique({ where: { userId: me.userId } });
  return NextResponse.json({
    scanOut: c?.scanOutCount ?? 0,
    scanIn:  c?.scanInCount  ?? 0,
  });
}
```

---

## 9. ãƒ†ã‚¹ãƒˆè¦³ç‚¹ï¼ˆPOCï¼‰
- ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼šCookieå±æ€§ç¢ºèª  
- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼šGETç©ºâ†’PUTä¿å­˜â†’GETåæ˜   
- QRï¼šURLï¼‹SVGãŒè¿”å´ã•ã‚Œã‚‹ã“ã¨  
- ã‚¹ã‚­ãƒ£ãƒ³ï¼šæ­£å¸¸ï¼è‡ªå·±ï¼ç›¸æ‰‹ä¸åœ¨ï¼ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³  
- LLMï¼šJSONå½¢å¼ã®è¿”å´ã€å¤±æ•—æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯  
- å®Ÿç¸¾ï¼šã‚«ã‚¦ãƒ³ãƒˆãŒæ­£ã—ãå¢—åŠ   

---

## 10. å®Ÿè£…çŠ¶æ³ã¨é †åº

### âœ… å®Ÿè£…å®Œäº†æ¸ˆã¿ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰ï¼š
1. **åŸºç›¤è¨­å®š**
   - Next.js 14ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–
   - Prismaè¨­å®šã¨ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ï¼ˆPostgreSQLå¯¾å¿œï¼‰
   - TypeScriptè¨­å®šï¼ˆtarget: es2020ï¼‰
   - Tailwind CSSè¨­å®š

2. **èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ** (ç½²åä»˜ãCookie)
   - `lib/session.ts` - HMACç½²åä»˜ãCookie
   - `lib/repos/users.ts` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
   - `api/auth/signup` - æ–°è¦ç™»éŒ²
   - `api/auth/login` - ãƒ­ã‚°ã‚¤ãƒ³
   - `api/auth/logout` - ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ

3. **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ©Ÿèƒ½**
   - `lib/repos/profile.ts` - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†ï¼ˆStringå‹ã§JSONä¿å­˜ï¼‰
   - `api/profile/me` - GET/PUT ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

4. **QRç”Ÿæˆãƒ»è¡¨ç¤º**
   - `lib/qr.ts` - SVG QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
   - `api/qr/me` - QRç”Ÿæˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

5. **ã‚¹ã‚­ãƒ£ãƒ³ãƒ»è©±é¡Œæç¤º**ï¼ˆæ ¸å¿ƒæ©Ÿèƒ½ï¼‰
   - `lib/cooldown.ts` - 30ç§’ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
   - `lib/llm.ts` - Geminié€£æº
   - `lib/repos/counters.ts` - ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ç®¡ç†
   - `api/scan` - ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

6. **å®Ÿç¸¾è¡¨ç¤º**
   - `api/metrics/me` - å®Ÿç¸¾å–å¾—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### âœ… å®Ÿè£…å®Œäº†æ¸ˆã¿ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰ï¼š
1. **èªè¨¼ç”»é¢**
   - `/auth/signup` - æ–°è¦ç™»éŒ²ç”»é¢
   - `/auth/login` - ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
   - èªè¨¼å¾Œã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†

2. **ãƒ¡ã‚¤ãƒ³ç”»é¢**
   - `/home` - QRè¡¨ç¤ºãƒ»ã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½
   - `/profile` - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
   - `/metrics` - å®Ÿç¸¾è¡¨ç¤º

3. **å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**
   - `Navigation.tsx` - 3ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
   - `TopicModal.tsx` - è©±é¡Œè¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«
   - `Toast.tsx` - ã‚¨ãƒ©ãƒ¼/é€šçŸ¥ãƒˆãƒ¼ã‚¹ãƒˆ
   - `CameraScanner.tsx` - QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼

### âœ… Vercelãƒ‡ãƒ—ãƒ­ã‚¤å¯¾å¿œï¼š
- **å‹•çš„å®Ÿè¡Œè¨­å®š**: å…¨APIãƒ«ãƒ¼ãƒˆã« `export const runtime = 'nodejs'` ã¨ `export const dynamic = 'force-dynamic'` è¿½åŠ 
- **ç’°å¢ƒå¤‰æ•°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: DEPLOYMENT_FIX.mdä½œæˆ
- **æœ¬ç•ªç’°å¢ƒã§ã®å‹•ä½œç¢ºèªæ¸ˆã¿**

### ğŸ“ ä¿®æ­£æ¸ˆã¿è¨­è¨ˆå¤‰æ›´ï¼š
- **Middlewareå‰Šé™¤**: Edgeç’°å¢ƒã§ã®next/headersäº’æ›æ€§å•é¡Œã«ã‚ˆã‚Šã€å„APIãƒãƒ³ãƒ‰ãƒ©ã§ã®èªè¨¼ãƒã‚§ãƒƒã‚¯ã«çµ±ä¸€
- **QRç”»åƒã‚µã‚¤ã‚º**: SVGã®æ‹¡å¤§ç¸®å°ç‰¹æ€§ã‚’æ´»ã‹ã™ãŸã‚widthå›ºå®šæŒ‡å®šã‚’å‰Šé™¤
- **Profile.profileJsonå‹**: PostgreSQLã¨ã®äº’æ›æ€§ã®ãŸã‚Stringå‹ã§ä¿æŒï¼ˆJSON.parse/stringifyã§å‡¦ç†ï¼‰
- **å‹•çš„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¼·åˆ¶**: cookies()ä½¿ç”¨ã«ã‚ˆã‚‹ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼å¯¾ç­–

### ğŸš€ æœ€è¿‘ã®æ”¹å–„ï¼ˆ2024å¹´12æœˆï¼‰ï¼š
1. **QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼å®Ÿè£…** (CameraScanner.tsx)
   - react-qr-scannerå°å…¥
   - ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼ˆèƒŒé¢ã‚«ãƒ¡ãƒ©å„ªå…ˆï¼‰
   - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰

2. **UXæ”¹å–„**
   - QRèª­ã¿å–ã‚Šç›´å¾Œã«å‡¦ç†ä¸­ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
   - TopicModalã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹è¿½åŠ 
   - æŒ¯å‹•ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆå¯¾å¿œãƒ‡ãƒã‚¤ã‚¹ï¼‰

3. **LLMæœ€é©åŒ–** (lib/llm.ts)
   - ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºå‰Šæ¸›ï¼ˆé¸æŠé …ç›®ã®ã¿é€ä¿¡ã§ç´„1/10ï¼‰
   - 503ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
   - æŸ”è»Ÿãªãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æ

### ğŸ‰ POCå®ŒæˆçŠ¶æ…‹ï¼š
ç¾åœ¨ã€å…¨æ©Ÿèƒ½ãŒå®Ÿè£…æ¸ˆã¿ã§Vercelãƒ‡ãƒ—ãƒ­ã‚¤ã‚‚æˆåŠŸã€‚ä»¥ä¸‹ãŒå‹•ä½œç¢ºèªæ¸ˆã¿ï¼š
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³
- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ãƒ»å–å¾—
- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ»è¡¨ç¤ºï¼ˆã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒ³å¯¾å¿œï¼‰
- ã‚¹ã‚­ãƒ£ãƒ³ãƒ»è©±é¡Œç”Ÿæˆï¼ˆGeminié€£æºã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
- å®Ÿç¸¾ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º
- 30ç§’ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æ©Ÿèƒ½

### ğŸ› æ—¢çŸ¥ã®å•é¡Œã¨æ®‹ã‚¿ã‚¹ã‚¯ï¼š
1. **Gemini API 503ã‚¨ãƒ©ãƒ¼é »ç™º**
   - ç¾çŠ¶ï¼šãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã§å¯¾å¿œä¸­
   - TODO: ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…
   - TODO: åˆ¥ã®LLMãƒ¢ãƒ‡ãƒ«ã¸ã®åˆ‡ã‚Šæ›¿ãˆæ¤œè¨ï¼ˆgemini-proç­‰ï¼‰
   - TODO: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å®Ÿè£…æ¤œè¨

2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
   - TODO: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ã•ã‚‰ãªã‚‹è»½é‡åŒ–
   - TODO: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®å®Ÿè£…

---

## 11. å—ã‘å…¥ã‚Œæ¡ä»¶ï¼ˆPOC Doneï¼‰
20â€“30äººè¦æ¨¡ãƒ†ã‚¹ãƒˆã§ï¼š
- ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜æˆåŠŸç‡ â‰¥ 90%
- ã‚¹ã‚­ãƒ£ãƒ³â†’è©±é¡Œè¡¨ç¤ºã®æˆåŠŸç‡ â‰¥ 85%ã€å¹³å‡å¿œç­” â‰¤ 1.5s
- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼šã€Œä¼šè©±ã‚’å§‹ã‚ã‚„ã™ããªã£ãŸã€**â‰¥ 70%**
- ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã¯ 429 ã¨ãƒˆãƒ¼ã‚¹ãƒˆãŒæ­£ã—ãè¡¨ç¤º

---

## 12. ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ï¼ˆVercelï¼‰

### å¿…é ˆç’°å¢ƒå¤‰æ•°
1. **DATABASE_URL** - PostgreSQLæ¥ç¶šæ–‡å­—åˆ—ï¼ˆSupabase/Neonï¼‰
2. **SESSION_SECRET** - ãƒ©ãƒ³ãƒ€ãƒ ãª32æ–‡å­—ä»¥ä¸Šã®æ–‡å­—åˆ—
3. **APP_BASE_URL** - æœ¬ç•ªURLï¼ˆä¾‹: https://your-app.vercel.appï¼‰
4. **GOOGLE_GEMINI_API_KEY** - Gemini APIã‚­ãƒ¼
5. **SESSION_MAX_AGE_SECONDS** - ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 86400ï¼‰

### ãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèªäº‹é …
- âœ… å…¨APIãƒ«ãƒ¼ãƒˆã« `export const dynamic = 'force-dynamic'` è¨­å®šæ¸ˆã¿
- âœ… Prismaãƒ“ãƒ«ãƒ‰æ™‚ã« `prisma generate` å®Ÿè¡Œï¼ˆpackage.jsonã®buildã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å¯¾å¿œæ¸ˆã¿ï¼‰
- âœ… PostgreSQLï¼ˆSupabaseï¼‰ã¨ã®æ¥ç¶šç¢ºèªæ¸ˆã¿
- âœ… HTTPSç’°å¢ƒã§ã®å‹•ä½œç¢ºèªæ¸ˆã¿

---

## 13. é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### å‰ææ¡ä»¶
- Node.js 18+
- PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆSupabaseæ¨å¥¨ï¼‰
- Gemini API ã‚­ãƒ¼

### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# ç’°å¢ƒå¤‰æ•°è¨­å®š
cp .env.local.example .env.local
# DATABASE_URL, SESSION_SECRET, GOOGLE_GEMINI_API_KEY ã‚’è¨­å®š

# Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆ
npx prisma generate

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
npx prisma db push

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run dev
```

### APIãƒ†ã‚¹ãƒˆä¾‹
```bash
# æ–°è¦ç™»éŒ²
curl -X POST http://localhost:3000/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"userId":"test1","password":"password123"}'

# QRå–å¾—
curl -X GET http://localhost:3000/api/qr/me \
  -H "Cookie: sid=<session_cookie>"
```
</file>

<file path="prisma/schema.prisma">
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  userId       String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  profile      Profile?
  counters     Counters?
}

model Profile {
  userId      String   @id
  profileJson String
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Counters {
  userId        String   @id
  scanOutCount  Int      @default(0)
  scanInCount   Int      @default(0)
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
</file>

<file path="src/app/layout.tsx">
import './globals.css'
import { Poppins, Noto_Sans_JP } from 'next/font/google'
import GoogleAnalytics from '@/components/GoogleAnalytics'
import ClientAnalytics from '@/components/ClientAnalytics'

const poppins = Poppins({
  subsets: ['latin'],
  weight: ['300', '400', '500', '600', '700'],
  variable: '--font-poppins',
})

const notoSansJP = Noto_Sans_JP({
  subsets: ['latin'],
  weight: ['300', '400', '500', '700'],
  variable: '--font-noto-sans-jp',
})

export const metadata = {
  title: 'QRãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«Ã—è©±é¡Œæç¤º',
  description: 'é«˜æ ¡ç”Ÿå‘ã‘QRäº¤æ›ã‚¢ãƒ—ãƒª',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja" className={`${poppins.variable} ${notoSansJP.variable}`}>
      <body className="font-sans">
        <GoogleAnalytics />
        <ClientAnalytics />
        <main className="min-h-screen">
          {children}
        </main>
      </body>
    </html>
  )
}
</file>

<file path="src/components/TopicModal.tsx">
'use client'

import { useEffect, useState } from 'react'
import { MessageCircle, Sparkles, X, Loader2 } from 'lucide-react'

interface TopicModalProps {
  isOpen: boolean
  message: string
  onClose: () => void
  isBusy?: boolean
  title?: string
  subtitle?: string
}

export default function TopicModal({
  isOpen,
  message,
  onClose,
  isBusy = false,
  title = 'ä¼šè©±ã®è©±é¡Œ',
  subtitle
}: TopicModalProps) {
  const [displayedMessage, setDisplayedMessage] = useState('')
  const [isTyping, setIsTyping] = useState(false)

  // ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  useEffect(() => {
    if (message && !isBusy) {
      setIsTyping(true)
      setDisplayedMessage('')
      let currentIndex = 0
      const interval = setInterval(() => {
        if (currentIndex <= message.length) {
          setDisplayedMessage(message.slice(0, currentIndex))
          currentIndex++
        } else {
          clearInterval(interval)
          setIsTyping(false)
        }
      }, 30)
      return () => clearInterval(interval)
    }
  }, [message, isBusy])

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4
                  animate-fadeIn">
      <div className="relative max-w-md w-full animate-slideInUp">
        {/* ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“ */}
        <div className="backdrop-blur-lg bg-white/95 rounded-3xl shadow-2xl overflow-hidden
                      transform transition-all duration-300 hover:scale-[1.02]">

          {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          <div className="bg-gradient-to-r from-purple-600 via-pink-500 to-teal-500 p-6 text-white">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="p-2 bg-white/20 rounded-full backdrop-blur-md">
                  {isBusy ? (
                    <Loader2 className="w-6 h-6 animate-spin" />
                  ) : (
                    <MessageCircle className="w-6 h-6" />
                  )}
                </div>
                <div>
                  <h2 className="text-xl font-bold">{title}</h2>
                  {subtitle && (
                    <p className="text-white/80 text-sm">{subtitle}</p>
                  )}
                </div>
              </div>
              {!isBusy && (
                <button
                  onClick={onClose}
                  className="p-2 hover:bg-white/20 rounded-full transition-colors"
                >
                  <X className="w-5 h-5" />
                </button>
              )}
            </div>
          </div>

          {/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
          <div className="p-6">
            {isBusy ? (
              // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
              <div className="flex flex-col items-center py-8">
                {/* AIæ³¢ç´‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */}
                <div className="relative mb-6">
                  <div className="absolute inset-0 animate-ping">
                    <div className="w-20 h-20 bg-purple-400 rounded-full opacity-20"></div>
                  </div>
                  <div className="absolute inset-0 animate-ping animation-delay-200">
                    <div className="w-20 h-20 bg-pink-400 rounded-full opacity-20"></div>
                  </div>
                  <div className="relative w-20 h-20 bg-gradient-to-br from-purple-500 to-teal-500 rounded-full
                                flex items-center justify-center shadow-lg">
                    <Sparkles className="w-10 h-10 text-white animate-pulse" />
                  </div>
                </div>
                <p className="text-gray-700 font-medium animate-pulse mb-2">
                  AIãŒè©±é¡Œã‚’æ¢ã—ã¦ã„ã¾ã™
                </p>
                <div className="flex gap-1">
                  <span className="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></span>
                  <span className="w-2 h-2 bg-pink-500 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></span>
                  <span className="w-2 h-2 bg-teal-500 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></span>
                </div>
              </div>
            ) : (
              // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆãƒãƒ£ãƒƒãƒˆé¢¨ï¼‰
              <div className="space-y-4">
                <div className="flex items-start gap-3">
                  <div className="p-2 bg-gradient-to-br from-purple-500 to-teal-500 rounded-full flex-shrink-0">
                    <Sparkles className="w-5 h-5 text-white" />
                  </div>
                  <div className="flex-1">
                    <p className="text-xs text-gray-500 mb-2">AI Assistant</p>
                    <div className="bg-gradient-to-r from-purple-50 to-teal-50 rounded-2xl rounded-tl-none p-4 shadow-inner">
                      <p className="text-gray-800 leading-relaxed">
                        {displayedMessage}
                        {isTyping && <span className="animate-pulse">â–Š</span>}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>

        </div>
      </div>
    </div>
  )
}
</file>

<file path="src/app/api/auth/login/route.ts">
// Force dynamic execution (required for cookies and Prisma)
export const runtime = 'nodejs';
export const dynamic = 'force-dynamic';
export const revalidate = 0;

import { NextRequest, NextResponse } from "next/server";
import { verifyPassword } from "@/lib/repos/users";
import { setSessionCookie } from "@/lib/session";

export async function POST(req: NextRequest) {
  try {
    const { userId, password } = await req.json();

    if (!userId || !password) {
      return NextResponse.json({ error: "bad_request" }, { status: 400 });
    }

    const user = await verifyPassword(userId, password);
    if (!user) {
      return NextResponse.json({ error: "invalid_credentials" }, { status: 401 });
    }

    const response = NextResponse.json({ ok: true });
    setSessionCookie(response, user.id);

    return response;
  } catch (error) {
    console.error("Login error:", error);
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}
</file>

<file path="src/app/api/auth/logout/route.ts">
// Force dynamic execution (required for cookies and Prisma)
export const runtime = 'nodejs';
export const dynamic = 'force-dynamic';
export const revalidate = 0;

import { NextRequest, NextResponse } from "next/server";
import { clearSessionCookie } from "@/lib/session";

export async function POST(req: NextRequest) {
  try {
    const response = NextResponse.json({ ok: true });
    clearSessionCookie(response);
    return response;
  } catch (error) {
    console.error("Logout error:", error);
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}
</file>

<file path="src/app/api/auth/signup/route.ts">
// Force dynamic execution (required for cookies and Prisma)
export const runtime = 'nodejs';
export const dynamic = 'force-dynamic';
export const revalidate = 0;

import { NextRequest, NextResponse } from "next/server";
import { createUser, getUserByUserId } from "@/lib/repos/users";
import { setSessionCookie } from "@/lib/session";

export async function POST(req: NextRequest) {
  try {
    const { userId, password } = await req.json();

    if (!userId || !password) {
      return NextResponse.json({ error: "bad_request" }, { status: 400 });
    }

    const existingUser = await getUserByUserId(userId);
    if (existingUser) {
      return NextResponse.json({ error: "user_exists" }, { status: 409 });
    }

    const user = await createUser(userId, password);

    const response = NextResponse.json({ ok: true });
    setSessionCookie(response, user.id);

    return response;
  } catch (error) {
    console.error("Signup error:", error);
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}
</file>

<file path="src/app/api/metrics/me/route.ts">
// Force dynamic execution (required for cookies and Prisma)
export const runtime = 'nodejs';
export const dynamic = 'force-dynamic';
export const revalidate = 0;

import { NextResponse } from "next/server";
import { requireSession } from "@/lib/session";
import { getCounters } from "@/lib/repos/counters";

export async function GET() {
  try {
    const { userId } = requireSession();
    const counters = await getCounters(userId);

    return NextResponse.json({
      scanOut: counters.scanOut,
      scanIn: counters.scanIn,
    });
  } catch (error: any) {
    if (error.message === "UNAUTH" || error.message === "EXPIRED" || error.message === "BADSIG") {
      return NextResponse.json({ error: "unauthorized" }, { status: 401 });
    }
    console.error("Get metrics error:", error);
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}
</file>

<file path="src/app/api/qr/me/route.ts">
// Force dynamic execution (required for cookies and Prisma)
export const runtime = 'nodejs';
export const dynamic = 'force-dynamic';
export const revalidate = 0;

import { NextResponse } from "next/server";
import { requireSession } from "@/lib/session";
import { generateQR } from "@/lib/qr";

export async function GET() {
  try {
    const { userId } = requireSession();
    const url = `${process.env.APP_BASE_URL}/scan?sid=${userId}`;
    const svg = await generateQR(url);

    return NextResponse.json({ url, svg });
  } catch (error: any) {
    if (error.message === "UNAUTH" || error.message === "EXPIRED" || error.message === "BADSIG") {
      return NextResponse.json({ error: "unauthorized" }, { status: 401 });
    }
    console.error("QR generation error:", error);
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}
</file>

<file path="src/app/api/scan/route.ts">
// Force dynamic execution (required for cookies and Prisma)
export const runtime = 'nodejs';
export const dynamic = 'force-dynamic';
export const revalidate = 0;

import { NextRequest, NextResponse } from "next/server";
import { requireSession } from "@/lib/session";
import { prisma } from "@/lib/db";
import { getProfile } from "@/lib/repos/profile";
import { incrScanOutIn } from "@/lib/repos/counters";
import { generateTopic } from "@/lib/llm";
import { canScan } from "@/lib/cooldown";

export async function POST(req: NextRequest) {
  try {
    const { userId: scannerId } = requireSession();
    const { scannedSid } = await req.json();

    if (!scannedSid) {
      return NextResponse.json({ error: "bad_request" }, { status: 400 });
    }

    if (scannerId === scannedSid) {
      return NextResponse.json({ error: "self_scan" }, { status: 400 });
    }

    const scannedUser = await prisma.user.findUnique({
      where: { id: scannedSid },
    });

    if (!scannedUser) {
      return NextResponse.json({ error: "user_not_found" }, { status: 404 });
    }

    const cd = await canScan(scannerId, scannedUser.id);
    if (!cd.ok) {
      return NextResponse.json({
        error: "cooldown",
        message: "æ™‚é–“ã‚’ãŠã„ã¦ãƒˆãƒ©ã‚¤ã—ã¦ãã ã•ã„"
      }, { status: 429 });
    }

    const [profileA, profileB] = await Promise.all([
      getProfile(scannerId),
      getProfile(scannedUser.id),
    ]);

    let message: string;
    try {
      message = await generateTopic(profileA ?? {}, profileB ?? {});
    } catch (llmError: any) {
      console.error("LLM error in scan:", llmError);

      // ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨ä¸å¯ã®å ´åˆ
      if (llmError.message === "SERVICE_UNAVAILABLE") {
        return NextResponse.json({
          error: "service_unavailable",
          message: "ã‚µãƒ¼ãƒ“ã‚¹ãŒä¸€æ™‚çš„ã«åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
        }, { status: 503 });
      }

      // ãã®ä»–ã®ç”Ÿæˆã‚¨ãƒ©ãƒ¼
      if (llmError.message === "GENERATION_FAILED") {
        return NextResponse.json({
          error: "generation_failed",
          message: "è©±é¡Œã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚"
        }, { status: 500 });
      }

      throw llmError; // äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ã¯å†ã‚¹ãƒ­ãƒ¼
    }

    await incrScanOutIn(scannerId, scannedUser.id);

    return NextResponse.json({ message });
  } catch (error: any) {
    if (error.message === "UNAUTH" || error.message === "EXPIRED" || error.message === "BADSIG") {
      return NextResponse.json({ error: "unauthorized" }, { status: 401 });
    }
    console.error("Scan error:", error);
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}
</file>

<file path="src/components/CameraScanner.tsx">
'use client';

import { useEffect, useMemo, useRef, useState } from 'react';
import dynamic from 'next/dynamic';

const Scanner = dynamic(
  () => import('@yudiel/react-qr-scanner').then(m => m.Scanner),
  { ssr: false }
);

interface CameraScannerProps {
  isOpen: boolean;
  onClose: () => void;
  onScan: (data: string) => void;
}

export default function CameraScanner({ isOpen, onClose, onScan }: CameraScannerProps) {
  const [hasPermission, setHasPermission] = useState<boolean | null>(null);
  const [error, setError] = useState<string | null>(null);

  // é¸æŠã—ãŸã‚«ãƒ¡ãƒ©
  const [deviceId, setDeviceId] = useState<string | undefined>(undefined);
  // fallback ç”¨ï¼šfront ã‚’ä½¿ã£ã¦ã„ã‚‹ã‹ï¼Ÿ
  const [usingFront, setUsingFront] = useState(false);

  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è¿½è·¡
  const activeStreamRef = useRef<MediaStream | null>(null);

  // constraints å¤‰æ›´æ™‚ã«å†ãƒã‚¦ãƒ³ãƒˆã•ã›ã‚‹ key
  const scannerKey = useMemo(
    () => `scanner-${deviceId ?? (usingFront ? 'front' : 'env')}-${Date.now()}`,
    [deviceId, usingFront]
  );

  // å…¨ã¦ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢ã™ã‚‹é–¢æ•°
  const stopAllStreams = () => {
    // activeStreamRef ã®è§£æ”¾
    if (activeStreamRef.current) {
      activeStreamRef.current.getTracks().forEach(track => {
        track.stop();
      });
      activeStreamRef.current = null;
    }

    // å…¨ã¦ã®ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’æ¢ã—ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
    const videos = document.querySelectorAll('video');
    videos.forEach(video => {
      const stream = (video as HTMLVideoElement).srcObject as MediaStream;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        (video as HTMLVideoElement).srcObject = null;
      }
    });
  };

  useEffect(() => {
    if (!isOpen) {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹æ™‚ã«ã™ã¹ã¦ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
      stopAllStreams();
      return;
    }

    setError(null);
    setHasPermission(null);
    setDeviceId(undefined);
    setUsingFront(false);

    // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦å‰ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒç¢ºå®Ÿã«è§£æ”¾ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤
    const timeoutId = setTimeout(() => {
      // 1) å…ˆã«æ¨©é™ã‚’å–ã‚‹ï¼ˆiOS ã® label å•é¡Œã«å¯¾å¿œï¼‰
      // æœ€åˆã‹ã‚‰èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’è¦æ±‚
      navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' }
      })
        .then(async (stream) => {
          activeStreamRef.current = stream;
          setHasPermission(true);

          // 2) ã‚«ãƒ¡ãƒ©åˆ—æŒ™ â†’ èƒŒé¢å€™è£œå„ªå…ˆ
          const devices = await navigator.mediaDevices.enumerateDevices();
          const videos = devices.filter(d => d.kind === 'videoinput');

          const back = videos.find(d => /back|rear|environment/i.test(d.label));
          if (back?.deviceId) {
            setDeviceId(back.deviceId);
            setUsingFront(false);
          } else if (videos.length > 0) {
            // èƒŒé¢ãŒãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯environmentåˆ¶ç´„ã§ä»»ã›ã‚‹
            // deviceIdã¯æŒ‡å®šã—ãªã„ï¼ˆfacingModeã§åˆ¶å¾¡ï¼‰
            setDeviceId(undefined);
            setUsingFront(false);
          }

          // æ¨©é™å–å¾—ã«ä½¿ã£ãŸã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯é–‰ã˜ã‚‹ï¼ˆScanner ã«ä»»ã›ã‚‹ï¼‰
          stream.getTracks().forEach(t => t.stop());
          activeStreamRef.current = null;
        })
        .catch((err) => {
          // èƒŒé¢ã‚«ãƒ¡ãƒ©ãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚«ãƒ¡ãƒ©ã§å†è©¦è¡Œ
          console.warn('èƒŒé¢ã‚«ãƒ¡ãƒ©å–å¾—å¤±æ•—ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚«ãƒ¡ãƒ©ã§å†è©¦è¡Œ:', err);
          navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
            .then(async (stream) => {
              activeStreamRef.current = stream;
              setHasPermission(true);
              const devices = await navigator.mediaDevices.enumerateDevices();
              const videos = devices.filter(d => d.kind === 'videoinput');
              if (videos.length > 0) {
                setDeviceId(videos[0]?.deviceId);
                setUsingFront(true);
              }
              stream.getTracks().forEach(t => t.stop());
              activeStreamRef.current = null;
            })
            .catch(() => {
              setHasPermission(false);
              setError('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            });
        });
    }, 100); // 100ms ã®é…å»¶

    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    return () => {
      clearTimeout(timeoutId);
      stopAllStreams();
    };
  }, [isOpen]);

  if (!isOpen) return null;

  const handleDecode = (val: string) => {
    try {
      const url = new URL(val);
      const sid = url.searchParams.get('sid');
      if (sid) {
        // å³åº§ã«æŒ¯å‹•ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆå¯¾å¿œãƒ‡ãƒã‚¤ã‚¹ã®ã¿ï¼‰
        if ('vibrate' in navigator) {
          navigator.vibrate(50);
        }

        // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢ã—ã¦ã‹ã‚‰é–‰ã˜ã‚‹
        stopAllStreams();

        // ã‚«ãƒ¡ãƒ©ã‚’å³åº§ã«é–‰ã˜ã‚‹ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã‚’å„ªå…ˆï¼‰
        onClose();

        // ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«é€šçŸ¥
        onScan(sid);
        return;
      }
    } catch { /* not a URL */ }
    setError('ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™');
  };

  const handleError = (e: any) => {
    console.error('QR Scanner Error:', e?.name ?? e, e);

    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ã®å ´åˆ
    if (e?.message?.includes('timed out') || e?.message?.includes('timeout')) {
      setError('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„');
      // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦ãƒªãƒˆãƒ©ã‚¤æº–å‚™
      stopAllStreams();
      setTimeout(() => {
        setError(null);
        setHasPermission(null);
        // å†åˆæœŸåŒ–ã®ãŸã‚isOpenã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        window.location.reload();
      }, 2000);
      return;
    }

    // ä»£è¡¨çš„ãªã‚¨ãƒ©ãƒ¼ â†’ åˆ¶ç´„ã‚’ç·©ã‚ã¦å†è©¦è¡Œ
    if (e?.name === 'OverconstrainedError' || e?.name === 'NotReadableError') {
      // ãƒ•ãƒ­ãƒ³ãƒˆä½¿ç”¨ä¸­ãªã‚‰åˆ¶ç´„ã‚’æ¥µåŠ›å¤–ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã«é¸ã°ã›ã‚‹
      if (usingFront) {
        setDeviceId(undefined);     // deviceId æŒ‡å®šã‚’å¤–ã™
      } else {
        setUsingFront(true);        // ãƒ•ãƒ­ãƒ³ãƒˆã¸åˆ‡æ›¿
      }
      setError('ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ã§å†è©¦è¡Œã—ã¦ã„ã¾ã™â€¦');
      return; // Scanner ã¯ key å¤‰åŒ–ã§å†ãƒã‚¦ãƒ³ãƒˆ
    }
    if (e?.name === 'NotAllowedError' || e?.name === 'SecurityError') {
      setHasPermission(false);
      setError('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
      return;
    }
    setError('ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
  };

  // æœ€çµ‚çš„ã« Scanner ã«æ¸¡ã™åˆ¶ç´„
  const constraints: MediaTrackConstraints | boolean =
    deviceId
      ? { deviceId: { exact: deviceId } }
      : { facingMode: usingFront ? 'user' : 'environment' };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-90 flex flex-col z-50">
      <div className="bg-white text-black p-4 flex justify-between items-center">
        <h2 className="text-xl font-semibold">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</h2>
        <button onClick={onClose} className="text-gray-600 hover:text-gray-800 text-2xl">âœ•</button>
      </div>

      <div className="flex-1 relative">
        {hasPermission === false ? (
          <div className="flex flex-col items-center justify-center h-full text-white p-4">
            <svg
              className="w-24 h-24 mb-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
              />
            </svg>
            <p className="text-center mb-4">ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ</p>
            <p className="text-sm text-gray-300 text-center">
              ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„
            </p>
          </div>
        ) : hasPermission === null ? (
          <div className="flex flex-col items-center justify-center h-full text-white">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div>
            <p>ã‚«ãƒ¡ãƒ©ã®è¨±å¯ã‚’ç¢ºèªä¸­...</p>
          </div>
        ) : (
          <>
            <Scanner
              key={scannerKey}
              onScan={(res) => { if (res && res.length > 0) handleDecode(res[0].rawValue); }}
              onError={handleError}
              constraints={constraints}
              styles={{
                container: { width: '100%', height: '100%' },
                video: { width: '100%', height: '100%', objectFit: 'cover' as const }
              }}
            />

            {/* Scanning overlay */}
            <div className="absolute inset-0 pointer-events-none">
              <div className="absolute inset-0 flex items-center justify-center">
                <div className="relative w-64 h-64">
                  {/* Corner markers */}
                  <div className="absolute top-0 left-0 w-12 h-12 border-t-4 border-l-4 border-white rounded-tl-lg"></div>
                  <div className="absolute top-0 right-0 w-12 h-12 border-t-4 border-r-4 border-white rounded-tr-lg"></div>
                  <div className="absolute bottom-0 left-0 w-12 h-12 border-b-4 border-l-4 border-white rounded-bl-lg"></div>
                  <div className="absolute bottom-0 right-0 w-12 h-12 border-b-4 border-r-4 border-white rounded-br-lg"></div>

                  {/* Scanning line animation */}
                  <div className="absolute inset-x-0 h-1 bg-gradient-to-r from-transparent via-blue-400 to-transparent animate-scan"></div>
                </div>
              </div>

              {/* Instructions */}
              <div className="absolute bottom-20 left-0 right-0 text-center text-white">
                <p className="text-lg">QRã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«åˆã‚ã›ã¦ãã ã•ã„</p>
              </div>
            </div>
          </>
        )}

        {error && (
          <div className="absolute top-20 left-4 right-4 bg-red-500 text-white p-4 rounded-lg">
            <p>{error}</p>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/components/Navigation.tsx">
'use client'

import Link from 'next/link'
import { usePathname } from 'next/navigation'
import { Home, User, TrendingUp } from 'lucide-react'

export default function Navigation() {
  const pathname = usePathname()

  const navItems = [
    { href: '/home', label: 'ãƒ›ãƒ¼ãƒ ', icon: Home },
    { href: '/profile', label: 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«', icon: User },
    { href: '/metrics', label: 'å®Ÿç¸¾', icon: TrendingUp },
  ]

  return (
    <nav className="fixed bottom-0 left-0 right-0 z-50">
      {/* ã‚¬ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ èƒŒæ™¯ */}
      <div className="backdrop-blur-xl bg-white/15 border-t border-white/20 shadow-lg">
        <div className="max-w-md mx-auto">
          <div className="flex justify-around py-2">
            {navItems.map((item) => {
              const Icon = item.icon
              const isActive = pathname === item.href

              return (
                <Link
                  key={item.href}
                  href={item.href}
                  className={`flex flex-col items-center py-1.5 px-4 rounded-xl transition-all duration-300 transform
                    ${isActive
                      ? 'scale-105 bg-white/15'
                      : 'hover:scale-105 hover:bg-white/10'
                    }`}
                >
                  <div className={`p-1.5 rounded-full transition-all duration-300
                    ${isActive
                      ? 'bg-gradient-to-r from-purple-500 to-teal-500 shadow-md'
                      : 'bg-white/10'
                    }`}>
                    <Icon
                      className={`w-4 h-4 transition-colors duration-300
                        ${isActive ? 'text-white' : 'text-white/70'}`}
                    />
                  </div>
                  <span className={`text-[10px] mt-0.5 font-medium transition-colors duration-300
                    ${isActive
                      ? 'text-white font-bold'
                      : 'text-white/70'
                    }`}>
                    {item.label}
                  </span>
                  {isActive && (
                    <div className="absolute -bottom-0.5 w-8 h-0.5 bg-gradient-to-r from-purple-500 to-teal-500 rounded-full"></div>
                  )}
                </Link>
              )
            })}
          </div>
        </div>
      </div>
    </nav>
  )
}
</file>

<file path="package.json">
{
  "name": "propose-conversation-topic",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "prisma generate && next build",
    "start": "next start",
    "lint": "next lint",
    "db:generate": "prisma generate",
    "db:push": "prisma db push",
    "db:studio": "prisma studio"
  },
  "dependencies": {
    "@google/generative-ai": "^0.21.0",
    "@prisma/client": "^5.19.1",
    "@yudiel/react-qr-scanner": "^2.3.1",
    "autoprefixer": "^10.4.21",
    "clsx": "^2.1.1",
    "lucide-react": "^0.544.0",
    "next": "14.2.12",
    "qrcode": "^1.5.4",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "tailwind-merge": "^3.3.1"
  },
  "devDependencies": {
    "@types/node": "^20.16.5",
    "@types/qrcode": "^1.5.5",
    "@types/react": "^18.3.5",
    "@types/react-dom": "^18.3.0",
    "eslint": "^8.57.0",
    "eslint-config-next": "14.2.12",
    "postcss": "^8.4.45",
    "prisma": "^5.19.1",
    "tailwindcss": "^3.4.10",
    "typescript": "^5.6.2"
  }
}
</file>

<file path="src/app/api/profile/me/route.ts">
// Force dynamic execution (required for cookies and Prisma)
export const runtime = 'nodejs';
export const dynamic = 'force-dynamic';
export const revalidate = 0;

import { NextRequest, NextResponse } from "next/server";
import { requireSession } from "@/lib/session";
import { getProfile, upsertProfile } from "@/lib/repos/profile";
import { packProfileFromUI, expandProfileForUI } from "@/lib/profile-shape";

export async function GET() {
  try {
    const { userId } = requireSession();
    const profile = await getProfile(userId);

    if (!profile) {
      return NextResponse.json({}, { status: 200 });
    }

    return NextResponse.json(profile);
  } catch (error: any) {
    if (error.message === "UNAUTH" || error.message === "EXPIRED" || error.message === "BADSIG") {
      return NextResponse.json({ error: "unauthorized" }, { status: 401 });
    }
    console.error("Get profile error:", error);
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}

export async function PUT(req: NextRequest) {
  try {
    const { userId } = requireSession();
    const input = await req.json();

    // å…¥åŠ›ã‚’æ­£è¦åŒ–: ã¾ãšç¾è¡ŒUIã«å­˜åœ¨ã™ã‚‹ã‚‚ã®ã ã‘ã«æ­£è¦åŒ–ã—ã¦ã‹ã‚‰ã€æœ€å°æ§‹é€ ã«ãƒ‘ãƒƒã‚¯
    const packed = packProfileFromUI(expandProfileForUI(input));

    await upsertProfile(userId, packed);

    return NextResponse.json({ ok: true });
  } catch (error: any) {
    if (error.message === "UNAUTH" || error.message === "EXPIRED" || error.message === "BADSIG") {
      return NextResponse.json({ error: "unauthorized" }, { status: 401 });
    }
    if (error.message.includes("Profile data too large")) {
      return NextResponse.json({ error: "profile_too_large" }, { status: 400 });
    }
    console.error("Update profile error:", error);
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}
</file>

<file path="src/app/auth/login/page.tsx">
'use client'

import { useState, Suspense } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import Link from 'next/link'
import { LogIn, User, Lock, ArrowLeft } from 'lucide-react'

function LoginForm() {
  const [userId, setUserId] = useState('')
  const [password, setPassword] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState('')
  const router = useRouter()
  const searchParams = useSearchParams()
  const nextPath = searchParams.get('next') || '/home'

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsLoading(true)
    setError('')

    try {
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include', // Added for better cookie handling
        body: JSON.stringify({ userId, password }),
      })

      const data = await response.json()

      if (response.ok) {
        // Use window.location for full page reload to ensure cookies are sent
        window.location.assign(nextPath)
      } else {
        setError(data.error === 'invalid_credentials' ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“' : 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ')
      }
    } catch (error) {
      setError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-600 via-teal-500 to-blue-600 flex items-center justify-center">
      <div className="max-w-md w-full mx-auto p-4">
        {/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */}
        <Link
          href="/"
          className="inline-flex items-center gap-2 text-white/80 hover:text-white mb-4 transition-colors"
        >
          <ArrowLeft className="w-4 h-4" />
          <span className="text-sm">æˆ»ã‚‹</span>
        </Link>

        {/* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ */}
        <div className="backdrop-blur-lg bg-white/90 rounded-3xl shadow-2xl p-8
                      transform transition-all duration-300 hover:scale-[1.02]">

          {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          <div className="text-center mb-8">
            <div className="inline-flex p-4 bg-gradient-to-br from-purple-500 to-teal-500 rounded-full mb-4 shadow-lg">
              <LogIn className="w-8 h-8 text-white" />
            </div>
            <h1 className="text-2xl font-bold bg-gradient-to-r from-purple-600 to-teal-500 bg-clip-text text-transparent mb-2">
              ãƒ­ã‚°ã‚¤ãƒ³
            </h1>
            <p className="text-gray-600 text-sm">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
          </div>

          <form onSubmit={handleSubmit} className="space-y-5">
            {/* ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå…¥åŠ› */}
            <div>
              <label htmlFor="userId" className="block text-sm font-medium text-gray-700 mb-2">
                ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
              </label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <User className="w-5 h-5 text-gray-400" />
                </div>
                <input
                  type="text"
                  id="userId"
                  value={userId}
                  onChange={(e) => setUserId(e.target.value)}
                  className="w-full pl-10 pr-3 py-3 backdrop-blur-lg bg-white/60 border border-white/50
                           rounded-xl shadow-inner
                           focus:outline-none focus:ring-2 focus:ring-purple-400 focus:bg-white/80
                           transition-all duration-300"
                  placeholder="your_id"
                  required
                  disabled={isLoading}
                />
              </div>
            </div>

            {/* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ› */}
            <div>
              <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-2">
                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
              </label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Lock className="w-5 h-5 text-gray-400" />
                </div>
                <input
                  type="password"
                  id="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full pl-10 pr-3 py-3 backdrop-blur-lg bg-white/60 border border-white/50
                           rounded-xl shadow-inner
                           focus:outline-none focus:ring-2 focus:ring-purple-400 focus:bg-white/80
                           transition-all duration-300"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  required
                  disabled={isLoading}
                />
              </div>
            </div>

            {/* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
            {error && (
              <div className="backdrop-blur-lg bg-red-500/10 border border-red-200 text-red-700 text-sm text-center p-3 rounded-xl">
                {error}
              </div>
            )}

            {/* ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ */}
            <button
              type="submit"
              disabled={isLoading}
              className={`w-full py-4 px-6 rounded-2xl font-bold text-white text-lg
                       transform transition-all duration-300
                       ${isLoading
                         ? 'bg-gray-400 cursor-wait scale-95'
                         : 'bg-gradient-to-r from-purple-500 via-pink-500 to-teal-500 hover:scale-105 hover:shadow-2xl active:scale-95'
                       }
                       shadow-xl backdrop-blur-md relative overflow-hidden group`}
            >
              {!isLoading && (
                <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent
                                -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
                </div>
              )}
              <span className="relative flex items-center justify-center gap-3">
                {isLoading ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
                    ãƒ­ã‚°ã‚¤ãƒ³ä¸­...
                  </>
                ) : (
                  <>
                    <LogIn className="w-5 h-5" />
                    ãƒ­ã‚°ã‚¤ãƒ³
                  </>
                )}
              </span>
            </button>
          </form>

          {/* ãƒ•ãƒƒã‚¿ãƒ¼ */}
          <div className="mt-6 text-center">
            <p className="text-gray-600 text-sm">
              ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„å ´åˆ
            </p>
            <Link
              href="/auth/signup"
              className="inline-flex items-center gap-2 mt-2 text-purple-600 hover:text-purple-700 font-medium transition-colors"
            >
              æ–°è¦ç™»éŒ²ã¯ã“ã¡ã‚‰
              <ArrowLeft className="w-4 h-4 rotate-180" />
            </Link>
          </div>
        </div>
      </div>
    </div>
  )
}

export default function LoginPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 via-teal-500 to-blue-600">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mx-auto mb-4"></div>
          <p className="text-white font-medium">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    }>
      <LoginForm />
    </Suspense>
  )
}
</file>

<file path="src/app/auth/signup/page.tsx">
'use client'

import { useState, Suspense } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import Link from 'next/link'
import { UserPlus, User, Lock, CheckCircle, ArrowLeft } from 'lucide-react'

function SignupForm() {
  const [userId, setUserId] = useState('')
  const [password, setPassword] = useState('')
  const [confirmPassword, setConfirmPassword] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState('')
  const router = useRouter()
  const searchParams = useSearchParams()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setError('')

    if (password !== confirmPassword) {
      setError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“')
      return
    }

    if (password.length < 6) {
      setError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„')
      return
    }

    setIsLoading(true)

    try {
      const response = await fetch('/api/auth/signup', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include', // Added for better cookie handling
        body: JSON.stringify({ userId, password }),
      })

      const data = await response.json()

      if (response.ok) {
        // Use window.location for full page reload to ensure cookies are sent
        window.location.assign('/profile')
      } else {
        setError(data.error === 'user_exists' ? 'ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™' : 'æ–°è¦ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ')
      }
    } catch (error) {
      setError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-600 via-teal-500 to-blue-600 flex items-center justify-center">
      <div className="max-w-md w-full mx-auto p-4">
        {/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */}
        <Link
          href="/"
          className="inline-flex items-center gap-2 text-white/80 hover:text-white mb-4 transition-colors"
        >
          <ArrowLeft className="w-4 h-4" />
          <span className="text-sm">æˆ»ã‚‹</span>
        </Link>

        {/* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ */}
        <div className="backdrop-blur-lg bg-white/90 rounded-3xl shadow-2xl p-8
                      transform transition-all duration-300 hover:scale-[1.02]">

          {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          <div className="text-center mb-8">
            <div className="inline-flex p-4 bg-gradient-to-br from-pink-500 to-teal-500 rounded-full mb-4 shadow-lg">
              <UserPlus className="w-8 h-8 text-white" />
            </div>
            <h1 className="text-2xl font-bold bg-gradient-to-r from-pink-500 to-teal-500 bg-clip-text text-transparent mb-2">
              æ–°è¦ç™»éŒ²
            </h1>
            <p className="text-gray-600 text-sm">æ–°ã—ã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„</p>
          </div>

          <form onSubmit={handleSubmit} className="space-y-5">
            {/* ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå…¥åŠ› */}
            <div>
              <label htmlFor="userId" className="block text-sm font-medium text-gray-700 mb-2">
                ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
              </label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <User className="w-5 h-5 text-gray-400" />
                </div>
                <input
                  type="text"
                  id="userId"
                  value={userId}
                  onChange={(e) => setUserId(e.target.value)}
                  className="w-full pl-10 pr-3 py-3 backdrop-blur-lg bg-white/60 border border-white/50
                           rounded-xl shadow-inner
                           focus:outline-none focus:ring-2 focus:ring-pink-400 focus:bg-white/80
                           transition-all duration-300"
                  placeholder="your_id"
                  required
                  disabled={isLoading}
                  minLength={3}
                />
              </div>
              <p className="text-xs text-gray-500 mt-1 ml-1">3æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            </div>

            {/* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ› */}
            <div>
              <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-2">
                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
              </label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Lock className="w-5 h-5 text-gray-400" />
                </div>
                <input
                  type="password"
                  id="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full pl-10 pr-3 py-3 backdrop-blur-lg bg-white/60 border border-white/50
                           rounded-xl shadow-inner
                           focus:outline-none focus:ring-2 focus:ring-pink-400 focus:bg-white/80
                           transition-all duration-300"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  required
                  disabled={isLoading}
                  minLength={6}
                />
              </div>
              <p className="text-xs text-gray-500 mt-1 ml-1">6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            </div>

            {/* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª */}
            <div>
              <label htmlFor="confirmPassword" className="block text-sm font-medium text-gray-700 mb-2">
                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
              </label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <CheckCircle className="w-5 h-5 text-gray-400" />
                </div>
                <input
                  type="password"
                  id="confirmPassword"
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  className="w-full pl-10 pr-3 py-3 backdrop-blur-lg bg-white/60 border border-white/50
                           rounded-xl shadow-inner
                           focus:outline-none focus:ring-2 focus:ring-pink-400 focus:bg-white/80
                           transition-all duration-300"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  required
                  disabled={isLoading}
                />
              </div>
            </div>

            {/* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
            {error && (
              <div className="backdrop-blur-lg bg-red-500/10 border border-red-200 text-red-700 text-sm text-center p-3 rounded-xl">
                {error}
              </div>
            )}

            {/* ç™»éŒ²ãƒœã‚¿ãƒ³ */}
            <button
              type="submit"
              disabled={isLoading}
              className={`w-full py-4 px-6 rounded-2xl font-bold text-white text-lg
                       transform transition-all duration-300
                       ${isLoading
                         ? 'bg-gray-400 cursor-wait scale-95'
                         : 'bg-gradient-to-r from-pink-500 via-purple-500 to-teal-500 hover:scale-105 hover:shadow-2xl active:scale-95'
                       }
                       shadow-xl backdrop-blur-md relative overflow-hidden group`}
            >
              {!isLoading && (
                <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent
                                -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
                </div>
              )}
              <span className="relative flex items-center justify-center gap-3">
                {isLoading ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
                    ç™»éŒ²ä¸­...
                  </>
                ) : (
                  <>
                    <UserPlus className="w-5 h-5" />
                    æ–°è¦ç™»éŒ²
                  </>
                )}
              </span>
            </button>
          </form>

          {/* ãƒ•ãƒƒã‚¿ãƒ¼ */}
          <div className="mt-6 text-center">
            <p className="text-gray-600 text-sm">
              æ—¢ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®å ´åˆ
            </p>
            <Link
              href="/auth/login"
              className="inline-flex items-center gap-2 mt-2 text-purple-600 hover:text-purple-700 font-medium transition-colors"
            >
              ãƒ­ã‚°ã‚¤ãƒ³ã¯ã“ã¡ã‚‰
              <ArrowLeft className="w-4 h-4 rotate-180" />
            </Link>
          </div>
        </div>
      </div>
    </div>
  )
}

export default function SignupPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 via-teal-500 to-blue-600">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mx-auto mb-4"></div>
          <p className="text-white font-medium">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    }>
      <SignupForm />
    </Suspense>
  )
}
</file>

<file path="src/app/metrics/page.tsx">
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import Navigation from '@/components/Navigation'
import Toast from '@/components/Toast'
import { RefreshCw, QrCode, Users, Trophy, Sparkles, TrendingUp } from 'lucide-react'

interface MetricsData {
  scanOut: number
  scanIn: number
}

export default function MetricsPage() {
  const [metrics, setMetrics] = useState<MetricsData>({ scanOut: 0, scanIn: 0 })
  const [isLoading, setIsLoading] = useState(true)
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false
  })
  const router = useRouter()

  useEffect(() => {
    fetchMetrics()
  }, [])

  const fetchMetrics = async () => {
    try {
      const response = await fetch('/api/metrics/me', {
        credentials: 'include', // Added for better cookie handling
      })

      if (response.status === 401) {
        router.push('/auth/login')
        return
      }

      if (response.ok) {
        const data = await response.json()
        setMetrics(data)
      } else {
        showToast('å®Ÿç¸¾ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error')
      }
    } catch (error) {
      showToast('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error')
    } finally {
      setIsLoading(false)
    }
  }

  const showToast = (message: string, type: 'success' | 'error' | 'warning') => {
    setToast({ message, type, isVisible: true })
  }

  const hideToast = () => {
    setToast(prev => ({ ...prev, isVisible: false }))
  }

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 via-teal-500 to-blue-600">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mx-auto mb-4"></div>
          <p className="text-white font-medium">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    )
  }

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—åŠ¹æœ
  const AnimatedNumber = ({ value, delay = 0 }: { value: number; delay?: number }) => {
    const [displayValue, setDisplayValue] = useState(0)

    useEffect(() => {
      const timer = setTimeout(() => {
        const increment = Math.ceil(value / 20)
        let current = 0
        const interval = setInterval(() => {
          current += increment
          if (current >= value) {
            setDisplayValue(value)
            clearInterval(interval)
          } else {
            setDisplayValue(current)
          }
        }, 50)
        return () => clearInterval(interval)
      }, delay)
      return () => clearTimeout(timer)
    }, [value, delay])

    return <>{displayValue}</>
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-600 via-teal-500 to-blue-600">
      <div className="max-w-md mx-auto p-4 pb-20">
        <div className="flex justify-between items-center mb-4 pt-4">
          <div>
            <h1 className="text-xl sm:text-2xl font-bold text-white drop-shadow-lg">å®Ÿç¸¾</h1>
            <p className="text-white/80 text-xs sm:text-sm">ã‚ãªãŸã®äº¤æµè¨˜éŒ²</p>
          </div>
          <button
            onClick={fetchMetrics}
            className="p-2.5 backdrop-blur-lg bg-white/20 rounded-full
                     hover:bg-white/30 transition-all duration-300 transform hover:scale-110
                     shadow-lg group"
          >
            <RefreshCw className="w-4 h-4 sm:w-5 sm:h-5 text-white group-hover:rotate-180 transition-transform duration-500" />
          </button>
        </div>

        {/* å®Ÿç¸¾ã‚«ãƒ¼ãƒ‰ */}
        <div className="space-y-4">
          {/* èª­ã¿å–ã‚Šå›æ•° */}
          <div className="backdrop-blur-lg bg-white/90 rounded-xl shadow-xl p-4
                        transform transition-all duration-300 hover:scale-[1.01] hover:shadow-2xl">
            <div className="flex items-center justify-between">
              <div className="flex-1">
                <div className="flex items-center space-x-2 mb-2">
                  <div className="p-2 bg-gradient-to-r from-purple-500 to-teal-500 rounded-full shadow-md">
                    <QrCode className="w-4 h-4 sm:w-5 sm:h-5 text-white" />
                  </div>
                  <h2 className="text-sm sm:text-base font-bold bg-gradient-to-r from-purple-600 to-teal-500 bg-clip-text text-transparent">
                    èª­ã¿å–ã‚Šå›æ•°
                  </h2>
                </div>
                <p className="text-xs text-gray-600 ml-10">
                  ä»–ã®äººã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³
                </p>
              </div>
              <div className="text-right">
                <div className="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-purple-600 to-teal-500 bg-clip-text text-transparent">
                  <AnimatedNumber value={metrics.scanOut} delay={200} />
                </div>
                <div className="text-xs text-gray-500 font-medium">å›</div>
              </div>
            </div>
            {/* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼é¢¨ã®è£…é£¾ */}
            <div className="mt-4 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div
                className="h-full bg-gradient-to-r from-purple-500 to-teal-500 rounded-full transition-all duration-1000"
                style={{ width: `${Math.min((metrics.scanOut / 50) * 100, 100)}%` }}
              ></div>
            </div>
          </div>

          {/* èª­ã¿å–ã‚‰ã‚Œå›æ•° */}
          <div className="backdrop-blur-lg bg-white/90 rounded-xl shadow-xl p-4
                        transform transition-all duration-300 hover:scale-[1.01] hover:shadow-2xl">
            <div className="flex items-center justify-between">
              <div className="flex-1">
                <div className="flex items-center space-x-2 mb-2">
                  <div className="p-2 bg-gradient-to-r from-pink-500 to-yellow-400 rounded-full shadow-md">
                    <Users className="w-4 h-4 sm:w-5 sm:h-5 text-white" />
                  </div>
                  <h2 className="text-sm sm:text-base font-bold bg-gradient-to-r from-pink-500 to-yellow-400 bg-clip-text text-transparent">
                    èª­ã¿å–ã‚‰ã‚Œå›æ•°
                  </h2>
                </div>
                <p className="text-xs text-gray-600 ml-10">
                  ã‚ãªãŸã®QRã‚³ãƒ¼ãƒ‰ãŒèª­ã¾ã‚ŒãŸæ•°
                </p>
              </div>
              <div className="text-right">
                <div className="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-pink-500 to-yellow-400 bg-clip-text text-transparent">
                  <AnimatedNumber value={metrics.scanIn} delay={400} />
                </div>
                <div className="text-xs text-gray-500 font-medium">å›</div>
              </div>
            </div>
            {/* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼é¢¨ã®è£…é£¾ */}
            <div className="mt-4 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div
                className="h-full bg-gradient-to-r from-pink-500 to-yellow-400 rounded-full transition-all duration-1000"
                style={{ width: `${Math.min((metrics.scanIn / 50) * 100, 100)}%` }}
              ></div>
            </div>
          </div>

          {/* ç·åˆå®Ÿç¸¾ */}
          <div className="relative backdrop-blur-lg bg-gradient-to-r from-purple-500/90 via-pink-500/90 to-yellow-400/90
                        rounded-xl shadow-2xl p-6 text-white overflow-hidden
                        transform transition-all duration-300 hover:scale-[1.01]">
            {/* èƒŒæ™¯ã®å…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */}
            <div className="absolute inset-0 opacity-30">
              <div className="absolute top-0 right-0 w-24 h-24 bg-white rounded-full blur-3xl animate-pulse"></div>
              <div className="absolute bottom-0 left-0 w-24 h-24 bg-yellow-300 rounded-full blur-3xl animate-pulse delay-1000"></div>
            </div>

            <div className="relative text-center">
              <div className="inline-flex p-3 bg-white/20 rounded-full mb-3 backdrop-blur-md">
                <Trophy className="w-6 h-6 sm:w-8 sm:h-8 text-yellow-300 animate-pulse" />
              </div>
              <h2 className="text-base sm:text-lg font-bold mb-2 drop-shadow-lg">ç·åˆå®Ÿç¸¾</h2>
              <div className="text-3xl sm:text-4xl font-bold mb-2 drop-shadow-lg">
                <AnimatedNumber value={metrics.scanOut + metrics.scanIn} delay={600} />
              </div>
              <div className="text-xs sm:text-sm font-medium mb-3 opacity-90">
                ç·äº¤æµå›æ•°
              </div>

              {/* ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */}
              <div className="flex justify-center gap-1 mb-2">
                <Sparkles className="w-3 h-3 text-yellow-300 animate-pulse" />
                <Sparkles className="w-4 h-4 text-yellow-300 animate-pulse delay-100" />
                <Sparkles className="w-3 h-3 text-yellow-300 animate-pulse delay-200" />
              </div>

              <div className="text-[10px] sm:text-xs font-medium opacity-80 leading-relaxed">
                QRã‚³ãƒ¼ãƒ‰ã‚’é€šã˜ã¦<br />
                <span className="text-sm font-bold">{metrics.scanOut + metrics.scanIn}</span>å›ã®ç´ æ™´ã‚‰ã—ã„å‡ºä¼šã„ãŒã‚ã‚Šã¾ã—ãŸï¼
              </div>
            </div>
          </div>

          {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
          <div className="text-center mt-6 backdrop-blur-lg bg-white/10 rounded-2xl p-6 shadow-lg">
            {metrics.scanOut + metrics.scanIn === 0 ? (
              <div>
                <TrendingUp className="w-12 h-12 text-white/70 mx-auto mb-3" />
                <p className="text-white/90 text-sm font-medium leading-relaxed">
                  ã¾ã äº¤æµãŒã‚ã‚Šã¾ã›ã‚“<br />
                  ãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦<br />
                  æ–°ã—ã„å‡ºä¼šã„ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼
                </p>
              </div>
            ) : (
              <div>
                <div className="flex justify-center gap-1 mb-3">
                  <Sparkles className="w-6 h-6 text-yellow-300 animate-pulse" />
                  <Sparkles className="w-8 h-8 text-yellow-300 animate-pulse delay-100" />
                  <Sparkles className="w-6 h-6 text-yellow-300 animate-pulse delay-200" />
                </div>
                <p className="text-white/90 text-sm font-medium leading-relaxed">
                  ç´ æ™´ã‚‰ã—ã„äº¤æµå®Ÿç¸¾ã§ã™ï¼<br />
                  å¼•ãç¶šãæ–°ã—ã„å‡ºä¼šã„ã‚’æ¥½ã—ã‚“ã§ãã ã•ã„
                </p>
              </div>
            )}
          </div>
        </div>

        {/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
        <Navigation />

        {/* ãƒˆãƒ¼ã‚¹ãƒˆ */}
        <Toast
          message={toast.message}
          type={toast.type}
          isVisible={toast.isVisible}
          onClose={hideToast}
        />
      </div>
    </div>
  )
}
</file>

<file path="src/app/scan/page.tsx">
'use client'

import { useEffect, useState, Suspense } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import { QrCode, Lock, User, Home, Loader2 } from 'lucide-react'
import Link from 'next/link'

function ScanContent() {
  const router = useRouter()
  const sp = useSearchParams()
  const sid = sp.get('sid') || ''
  const [state, setState] = useState<'checking'|'need-login'|'need-profile'|'redirecting'>('checking')

  useEffect(() => {
    const run = async () => {
      if (!sid) {
        // sidãŒãªã„å ´åˆã¯ãƒ›ãƒ¼ãƒ ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        router.push('/home')
        return
      }

      // èªè¨¼ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å®Œäº†çŠ¶æ…‹ã‚’ç¢ºèª
      const me = await fetch('/api/me', {
        credentials: 'include', // Added for better cookie handling
      })
      if (me.status === 401) {
        setState('need-login')
        return
      }

      const user = await me.json().catch(() => ({}))
      if (!user.profileCompleted) {
        setState('need-profile')
        return
      }

      // ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
      setState('redirecting')
      router.push(`/home?scannedSid=${encodeURIComponent(sid)}`)
    }

    run()
  }, [sid])

  if (state === 'checking' || state === 'redirecting') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-600 via-teal-500 to-blue-600 flex items-center justify-center">
        <div className="max-w-md w-full mx-auto p-4">
          <div className="backdrop-blur-lg bg-white/90 rounded-3xl shadow-2xl p-8
                        transform transition-all duration-300">
            <div className="text-center">
              <div className="inline-flex p-4 bg-gradient-to-br from-purple-500 to-teal-500 rounded-full mb-6 shadow-lg">
                <QrCode className="w-10 h-10 text-white animate-pulse" />
              </div>
              <h1 className="text-xl font-bold bg-gradient-to-r from-purple-600 to-teal-500 bg-clip-text text-transparent mb-3">
                {state === 'redirecting' ? 'ãƒ›ãƒ¼ãƒ ã¸ç§»å‹•ä¸­...' : 'QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šä¸­...'}
              </h1>
              <div className="flex justify-center mb-4">
                <Loader2 className="w-8 h-8 text-purple-500 animate-spin" />
              </div>
              <p className="text-gray-600 text-sm">å‡¦ç†ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
            </div>
          </div>
        </div>
      </div>
    )
  }

  if (state === 'need-login') {
    const next = encodeURIComponent(`/scan?sid=${sid}`)
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-600 via-teal-500 to-blue-600 flex items-center justify-center">
        <div className="max-w-md w-full mx-auto p-4">
          <div className="backdrop-blur-lg bg-white/90 rounded-3xl shadow-2xl p-8
                        transform transition-all duration-300 hover:scale-[1.02]">
            <div className="text-center mb-8">
              <div className="inline-flex p-4 bg-gradient-to-br from-purple-500 to-teal-500 rounded-full mb-4 shadow-lg">
                <Lock className="w-10 h-10 text-white" />
              </div>
              <h1 className="text-2xl font-bold bg-gradient-to-r from-purple-600 to-teal-500 bg-clip-text text-transparent mb-3">
                ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™
              </h1>
              <p className="text-gray-600 text-sm">
                QRã‚³ãƒ¼ãƒ‰ã®å†…å®¹ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚
              </p>
            </div>

            <div className="space-y-3">
              <Link
                href={`/auth/login?next=${next}`}
                className="block w-full py-4 px-6 rounded-2xl font-bold text-white text-lg
                         bg-gradient-to-r from-purple-500 via-pink-500 to-teal-500
                         transform transition-all duration-300 hover:scale-105 hover:shadow-xl
                         active:scale-95 relative overflow-hidden group"
              >
                <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent
                                -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
                </div>
                <span className="relative">ãƒ­ã‚°ã‚¤ãƒ³</span>
              </Link>

              <Link
                href={`/auth/signup?next=${next}`}
                className="block w-full py-4 px-6 rounded-2xl font-bold text-gray-700 text-lg
                         backdrop-blur-lg bg-white/60 border-2 border-white/50
                         transform transition-all duration-300 hover:scale-105 hover:shadow-xl hover:bg-white/80
                         active:scale-95"
              >
                æ–°è¦ç™»éŒ²
              </Link>
            </div>
          </div>
        </div>
      </div>
    )
  }

  if (state === 'need-profile') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-600 via-teal-500 to-blue-600 flex items-center justify-center">
        <div className="max-w-md w-full mx-auto p-4">
          <div className="backdrop-blur-lg bg-white/90 rounded-3xl shadow-2xl p-8
                        transform transition-all duration-300 hover:scale-[1.02]">
            <div className="text-center mb-8">
              <div className="inline-flex p-4 bg-gradient-to-br from-pink-500 to-teal-500 rounded-full mb-4 shadow-lg">
                <User className="w-10 h-10 text-white" />
              </div>
              <h1 className="text-2xl font-bold bg-gradient-to-r from-pink-500 to-teal-500 bg-clip-text text-transparent mb-3">
                ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šãŒå¿…è¦ã§ã™
              </h1>
              <p className="text-gray-600 text-sm">
                ä¼šè©±ã‚’å§‹ã‚ã‚‹ã«ã¯ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šãŒå¿…è¦ã§ã™ã€‚
              </p>
            </div>

            <div className="space-y-3">
              <Link
                href="/profile?from=scan"
                className="block w-full py-4 px-6 rounded-2xl font-bold text-white text-lg
                         bg-gradient-to-r from-pink-500 via-purple-500 to-teal-500
                         transform transition-all duration-300 hover:scale-105 hover:shadow-xl
                         active:scale-95 relative overflow-hidden group"
              >
                <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent
                                -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
                </div>
                <span className="relative flex items-center justify-center gap-3">
                  <User className="w-5 h-5" />
                  ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¨­å®šã™ã‚‹
                </span>
              </Link>

              <Link
                href="/home"
                className="block w-full py-4 px-6 rounded-2xl font-bold text-gray-700 text-lg
                         backdrop-blur-lg bg-white/60 border-2 border-white/50
                         transform transition-all duration-300 hover:scale-105 hover:shadow-xl hover:bg-white/80
                         active:scale-95 text-center"
              >
                <span className="flex items-center justify-center gap-3">
                  <Home className="w-5 h-5" />
                  ãƒ›ãƒ¼ãƒ ã¸
                </span>
              </Link>
            </div>
          </div>
        </div>
      </div>
    )
  }

  // ä»–ã®çŠ¶æ…‹ã§ã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†ä¸­ï¼‰
  return null
}

export default function ScanLandingPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-gradient-to-br from-purple-600 via-teal-500 to-blue-600 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mx-auto mb-4"></div>
          <p className="text-white font-medium">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    }>
      <ScanContent />
    </Suspense>
  )
}
</file>

<file path="src/app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

/* ===== ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆå®šç¾© ===== */
:root {
  /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ */
  --color-teal: #28C7FA;
  --color-violet: #9B5DE5;

  /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ */
  --color-neon-yellow: #FEE440;
  --color-pink: #F15BB5;
  --color-light-blue: #00BBF9;

  /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
  --gradient-main: linear-gradient(135deg, var(--color-teal) 0%, var(--color-violet) 100%);
  --gradient-pop: linear-gradient(135deg, var(--color-pink) 0%, var(--color-neon-yellow) 100%);
  --gradient-cool: linear-gradient(135deg, var(--color-light-blue) 0%, var(--color-teal) 100%);

  /* ã‚¬ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ç”¨ */
  --glass-bg: rgba(255, 255, 255, 0.08);
  --glass-border: rgba(255, 255, 255, 0.18);
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);

  /* ãƒã‚ªãƒ³åŠ¹æœ */
  --neon-glow-teal: 0 0 30px rgba(40, 199, 250, 0.8), 0 0 60px rgba(40, 199, 250, 0.4);
  --neon-glow-violet: 0 0 30px rgba(155, 93, 229, 0.8), 0 0 60px rgba(155, 93, 229, 0.4);
  --neon-glow-pink: 0 0 30px rgba(241, 91, 181, 0.8), 0 0 60px rgba(241, 91, 181, 0.4);
}

/* ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ« ===== */
body {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  font-family: var(--font-noto-sans-jp), var(--font-poppins), system-ui, -apple-system, sans-serif;
}

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ ===== */
/* ã‚¬ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ  */
.glass {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px) saturate(200%);
  -webkit-backdrop-filter: blur(10px) saturate(200%);
  background-image: linear-gradient(
    135deg,
    rgba(255, 255, 255, 0.1) 0%,
    rgba(255, 255, 255, 0.05) 100%
  );
  border: 1px solid rgba(255, 255, 255, 0.18);
  box-shadow:
    0 8px 32px 0 rgba(31, 38, 135, 0.37),
    inset 0 1px 1px 0 rgba(255, 255, 255, 0.15);
}

/* ãƒã‚ªãƒ³ã‚«ãƒ¼ãƒ‰å°‚ç”¨ */
.neon-card {
  position: relative;
  background: linear-gradient(135deg, rgba(40, 199, 250, 0.1) 0%, rgba(155, 93, 229, 0.1) 100%);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

.neon-card::before {
  content: '';
  position: absolute;
  inset: -2px;
  background: linear-gradient(135deg, var(--color-teal), var(--color-violet));
  border-radius: 24px;
  z-index: -1;
  opacity: 0.7;
  filter: blur(10px);
  animation: pulse 3s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.5; transform: scale(1); }
  50% { opacity: 0.8; transform: scale(1.02); }
}

/* ãƒã‚ªãƒ³ãƒ†ã‚­ã‚¹ãƒˆ */
.text-neon-teal {
  color: var(--color-teal);
  text-shadow: var(--neon-glow-teal);
}

.text-neon-violet {
  color: var(--color-violet);
  text-shadow: var(--neon-glow-violet);
}

.text-neon-pink {
  color: var(--color-pink);
  text-shadow: var(--neon-glow-pink);
}

/* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ */
.text-gradient-main {
  background: var(--gradient-main);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.text-gradient-pop {
  background: var(--gradient-pop);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* ãƒœã‚¿ãƒ³ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
.btn-gradient {
  background: var(--gradient-main);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.btn-gradient:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(40, 199, 250, 0.3);
}

.btn-gradient::before {
  content: "";
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s;
}

.btn-gradient:hover::before {
  left: 100%;
}

/* ===== ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ===== */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fadeIn {
  animation: fadeIn 0.3s ease-out;
}

.animate-slideUp {
  animation: slideUp 0.3s ease-out;
}

.animate-slideDown {
  animation: slideDown 0.3s ease-out;
}

.animate-slideInUp {
  animation: slideInUp 0.4s ease-out;
}

.animation-delay-200 {
  animation-delay: 200ms;
}

/* QR Scanner Animation */
@keyframes scan {
  0% {
    top: 0;
  }
  50% {
    top: calc(100% - 4px);
  }
  100% {
    top: 0;
  }
}

.animate-scan {
  animation: scan 2s ease-in-out infinite;
}

/* Toast Progress Bar Animation */
@keyframes shrink {
  from {
    transform: scaleX(1);
  }
  to {
    transform: scaleX(0);
  }
}

/* QR Code SVG styles */
.qr-container svg {
  width: 100% !important;
  height: 100% !important;
  max-width: 100%;
  max-height: 100%;
  display: block; /* ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¡¨ç¤ºã«ã‚ˆã‚‹ä¸‹ç«¯ä½™ç™½ã‚’è§£æ¶ˆ */
}
</file>

<file path="src/lib/llm.ts">
import { GoogleGenerativeAI } from "@google/generative-ai";

const genAI = new GoogleGenerativeAI(process.env.GOOGLE_GEMINI_API_KEY!);
const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-lite" });

// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç¢ºèªï¼ˆPackedå½¢å¼ã®ã¿å¯¾å¿œï¼‰
function validatePackedProfile(profile: any): any {
  // Packedå½¢å¼ï¼ˆé…åˆ—ï¼‰ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
  if (!profile || typeof profile !== 'object') {
    return {};
  }

  // ã™ã¹ã¦ã®å€¤ãŒé…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
  const isPacked = Object.values(profile).every(v => Array.isArray(v));
  if (!isPacked) {
    console.warn('Profile is not in packed format, returning empty');
    return {};
  }

  return profile;
}

// ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãã®Gemini APIå‘¼ã³å‡ºã—
async function generateContentWithRetry(
  prompt: any,
  maxRetries: number = 3,
  initialDelay: number = 1000
): Promise<any> {
  let lastError: any;

  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      console.log(`Attempt ${attempt + 1}/${maxRetries} to generate content...`);

      const result = await model.generateContent({
        contents: prompt,
        generationConfig: {
          responseMimeType: "application/json",
          temperature: 0.7,  // å®‰å®šæ€§å‘ä¸Šã®ãŸã‚æ¸©åº¦ã‚’è¨­å®š
          maxOutputTokens: 256,  // å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’åˆ¶é™
        }
      });

      // æˆåŠŸã—ãŸã‚‰çµæœã‚’è¿”ã™
      return result;

    } catch (error: any) {
      lastError = error;
      console.error(`Attempt ${attempt + 1} failed:`, error?.message || error);

      // 503ã‚¨ãƒ©ãƒ¼ã®å ´åˆã®ã¿ãƒªãƒˆãƒ©ã‚¤
      if (error?.status === 503 && attempt < maxRetries - 1) {
        const delay = initialDelay * Math.pow(2, attempt); // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
        console.log(`Waiting ${delay}ms before retry...`);
        await new Promise(resolve => setTimeout(resolve, delay));
        continue;
      }

      // 503ä»¥å¤–ã®ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯æœ€å¾Œã®è©¦è¡Œã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹
      throw error;
    }
  }

  // ã™ã¹ã¦ã®è©¦è¡ŒãŒå¤±æ•—ã—ãŸå ´åˆ
  throw lastError;
}

export async function generateTopic(profileA: any, profileB: any): Promise<string> {
  try {
    // Packedå½¢å¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ¤œè¨¼
    const simplifiedA = validatePackedProfile(profileA);
    const simplifiedB = validatePackedProfile(profileB);

    // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
    console.log("=== LLM Debug ===");
    console.log("Simplified Profile A:", JSON.stringify(simplifiedA, null, 2));
    console.log("Simplified Profile B:", JSON.stringify(simplifiedB, null, 2));
    console.log("API Key exists:", !!process.env.GOOGLE_GEMINI_API_KEY);

    // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¨­å®š
    const systemPrompt = `ã‚ãªãŸã¯é«˜æ ¡ç”Ÿã®åˆå¯¾é¢ä¼šè©±ã‚’æ”¯æ´ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
å®‰å…¨ã§æ¥½ã—ã„è©±é¡Œã®ã¿ææ¡ˆã—ã€æ”¿æ²»ãƒ»å®—æ•™ãƒ»å€‹äººæƒ…å ±ã¯é¿ã‘ã¦ãã ã•ã„ã€‚
å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼: {"message": "è©±é¡Œå†…å®¹"}`;

    // æ”¹å–„ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    const promptText = `
## ã‚¿ã‚¹ã‚¯
äºŒäººã®é«˜æ ¡ç”Ÿãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‹ã‚‰ä¼šè©±ã®è©±é¡Œã‚’1ã¤ææ¡ˆ

## ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿
- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«1: ${JSON.stringify(simplifiedA)}
- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«2: ${JSON.stringify(simplifiedB)}
- å½¢å¼: {ã‚«ãƒ†ã‚´ãƒª: [{name: "é¸æŠé …ç›®", text: "è‡ªç”±è¨˜è¿°"}]}

## è©±é¡Œç”Ÿæˆãƒ«ãƒ¼ãƒ«
1. **å…±é€šç‚¹ç™ºè¦‹æ™‚**: "ãŠãµãŸã‚Šã¯â—‹â—‹ãŒå…±é€šç‚¹ãªã‚ˆã†ã§ã™ã€‚[å…·ä½“çš„ãªè³ªå•]"
2. **å…±é€šç‚¹ãªã—æ™‚**: ä¸¡ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’çµ„ã¿åˆã‚ã›ãŸæ–°ã—ã„è©±é¡Œ
3. **å‡ºåŠ›è¦ä»¶**:
   - 1-2æ–‡ã§å®Œçµ
   - è³ªå•å½¢å¼ã§çµ‚ã‚ã‚‹
   - é«˜æ ¡ç”Ÿã‚‰ã—ã„è‡ªç„¶ãªè¡¨ç¾

## ã‚¯ãƒ­ã‚¹ã‚ªãƒ¼ãƒãƒ¼è©±é¡Œä¾‹
- ã‚¹ãƒãƒ¼ãƒ„Ã—éŸ³æ¥½ â†’ "é‹å‹•æ™‚ã®BGMã‚„å¿œæ´æ­Œ"
- èª­æ›¸Ã—æ˜ ç”» â†’ "åŸä½œã¨æ˜ ç”»åŒ–ä½œå“ã®æ¯”è¼ƒ"
- æ–™ç†Ã—ã‚¢ãƒ‹ãƒ¡ â†’ "ã‚¢ãƒ‹ãƒ¡ã«å‡ºã¦ãã‚‹æ–™ç†ã®å†ç¾"
- ã‚²ãƒ¼ãƒ Ã—å‹‰å¼· â†’ "ã‚²ãƒ¼ãƒ ã§å­¦ã‚“ã ã“ã¨ã‚„é›†ä¸­åŠ›å‘ä¸Š"
- ã‚¢ãƒ¼ãƒˆÃ—ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ â†’ "ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¢ãƒ¼ãƒˆã‚„å‰µä½œãƒ„ãƒ¼ãƒ«"

## ä¾‹
å…±é€šç‚¹ã‚ã‚Š: "ãŠãµãŸã‚Šã¯éŸ³æ¥½ãŒå…±é€šç‚¹ãªã‚ˆã†ã§ã™ã€‚æœ€è¿‘ã‚ˆãè´ãã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ"
ã‚¯ãƒ­ã‚¹ã‚ªãƒ¼ãƒãƒ¼: "ã‚¹ãƒãƒ¼ãƒ„ã‚’ã•ã‚Œã‚‹æ–¹ã¨èª­æ›¸å¥½ãã®æ–¹ã§ã™ã­ã€‚ä½“ã‚’å‹•ã‹ã—ãŸå¾Œã®æœ¬ã¯ã„ã‹ãŒã§ã™ã‹ï¼Ÿ"

å‡ºåŠ›å½¢å¼: {"message": "è©±é¡Œã®å†…å®¹"}`;

    const prompt = [
      { role: "user", parts: [{ text: systemPrompt }] },
      { role: "user", parts: [{ text: promptText }] }
    ];

    console.log("Sending simplified prompt to Gemini...");

    // ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãã§APIå‘¼ã³å‡ºã—
    const result = await generateContentWithRetry(prompt);

    const response = result.response;
    let text = response.text().trim();
    console.log("Raw response from Gemini:", text);

    // å¿µã®ãŸã‚ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’é™¤å»
    if (text.startsWith('```json')) {
      text = text.replace(/^```json\s*/, '').replace(/\s*```$/, '').trim();
    } else if (text.startsWith('```')) {
      text = text.replace(/^```\s*/, '').replace(/\s*```$/, '').trim();
    }

    try {
      const parsed = JSON.parse(text);
      console.log("Parsed message:", parsed.message);
      return parsed.message || "éŸ³æ¥½ã¯ã‚ˆãè´ãã¾ã™ã‹ï¼Ÿæœ€è¿‘ã®ãŠæ°—ã«å…¥ã‚ŠãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚";
    } catch (parseError) {
      console.error("Failed to parse JSON response:", parseError);

      // JSONã§ã¯ãªã„å ´åˆã€ç›´æ¥ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ä½¿ç”¨ã‚’è©¦ã¿ã‚‹
      if (text && text.length > 10 && !text.toLowerCase().includes('error')) {
        // ã€Œã€ã‚„""ã§å›²ã¾ã‚ŒãŸéƒ¨åˆ†ã‚’æŠ½å‡º
        const match = text.match(/[ã€Œ"](.*?)[ã€"]/);
        if (match) {
          return match[1];
        }
        // ãã®ã¾ã¾è¿”ã™ï¼ˆãŸã ã—ã€æ”¹è¡Œã‚„ä½™è¨ˆãªè¨˜å·ã¯é™¤å»ï¼‰
        return text.replace(/[\n\r\"]/g, '').trim();
      }

      return "éŸ³æ¥½ã¯ã‚ˆãè´ãã¾ã™ã‹ï¼Ÿæœ€è¿‘ã®ãŠæ°—ã«å…¥ã‚ŠãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚";
    }
  } catch (error) {
    console.error("LLM generation error:", error);

    // 503ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€å†è©¦è¡Œã‚’ä¿ƒã™
    if ((error as any)?.status === 503) {
      console.log("503 error detected - service temporarily unavailable");
      throw new Error("SERVICE_UNAVAILABLE");
    }

    // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚å†è©¦è¡Œã‚’ä¿ƒã™
    throw new Error("GENERATION_FAILED");
  }
}
</file>

<file path="src/app/profile/page.tsx">
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import Navigation from '@/components/Navigation'
import Toast from '@/components/Toast'
import { TOPICS } from '@/lib/topics'
import { expandProfileForUI, packProfileFromUI } from '@/lib/profile-shape'
import type { UIProfile } from '@/lib/profile-shape'
import { CheckCircle, Sparkles, Save } from 'lucide-react'

interface ProfileData {
  [topicId: string]: {
    [option: string]: {
      selected: boolean
      freeText: string
    }
  }
}

export default function ProfilePage() {
  const [profile, setProfile] = useState<UIProfile>({})
  const [expandedTopics, setExpandedTopics] = useState<Set<string>>(new Set())
  const [isLoading, setIsLoading] = useState(true)
  const [isSaving, setIsSaving] = useState(false)
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false
  })
  const router = useRouter()

  useEffect(() => {
    fetchProfile()
  }, [])


  const fetchProfile = async () => {
    try {
      const response = await fetch('/api/profile/me', {
        credentials: 'include', // Added for better cookie handling
      })

      if (response.status === 401) {
        router.push('/auth/login')
        return
      }

      if (response.ok) {
        const data = await response.json()
        setProfile(expandProfileForUI(data)) // ç¾è¡ŒUIã«ã ã‘åæ˜ 
      } else {
        setProfile(expandProfileForUI({})) // ç©ºã‚’UIæ—¢å®šã«
      }
    } catch (error) {
      showToast('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error')
      setProfile(expandProfileForUI({}))
    } finally {
      setIsLoading(false)
    }
  }

  const showToast = (message: string, type: 'success' | 'error' | 'warning') => {
    setToast({ message, type, isVisible: true })
  }

  const hideToast = () => {
    setToast(prev => ({ ...prev, isVisible: false }))
  }

  const handleOptionToggle = (topicId: string, option: string) => {
    setProfile(prev => ({
      ...prev,
      [topicId]: {
        ...prev[topicId],
        [option]: {
          ...prev[topicId][option],
          selected: !prev[topicId][option].selected
        }
      }
    }))
  }

  const handleFreeTextChange = (topicId: string, option: string, value: string) => {
    setProfile(prev => ({
      ...prev,
      [topicId]: {
        ...prev[topicId],
        [option]: {
          ...prev[topicId][option],
          freeText: value
        }
      }
    }))
  }

  const toggleTopic = (topicId: string) => {
    setExpandedTopics(prev => {
      const newSet = new Set<string>()
      // ç¾åœ¨é–‹ã„ã¦ã„ã‚‹ã‚‚ã®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯é–‰ã˜ã‚‹
      // ãã†ã§ãªã„å ´åˆã¯ã€ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‚ã®ã ã‘ã‚’é–‹ã
      if (!prev.has(topicId)) {
        newSet.add(topicId)
      }
      return newSet
    })
  }

  const hasSelectedOptions = (topicId: string) => {
    return Object.values(profile[topicId] || {}).some(option => option.selected)
  }

  const handleSave = async () => {
    setIsSaving(true)

    try {
      const packed = packProfileFromUI(profile) // æœ€å°æ§‹é€ ã§é€ã‚‹
      const response = await fetch('/api/profile/me', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include', // Added for better cookie handling
        body: JSON.stringify(packed),
      })

      if (response.status === 401) {
        router.push('/auth/login')
        return
      }

      if (response.ok) {
        showToast('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success')
        // ä¿å­˜æˆåŠŸå¾Œã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ›ãƒ¼ãƒ ç”»é¢ã¸é·ç§»
        setTimeout(() => {
          router.push('/home')
        }, 1000)
      } else {
        showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error')
      }
    } catch (error) {
      showToast('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error')
    } finally {
      setIsSaving(false)
    }
  }

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 via-teal-500 to-blue-600">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mx-auto mb-4"></div>
          <p className="text-white font-medium">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-600 via-teal-500 to-blue-600">
      <div className="max-w-md mx-auto p-4 pb-20">
        <div className="text-center mb-4 pt-4">
          <h1 className="text-xl sm:text-2xl font-bold text-white mb-1 drop-shadow-lg">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h1>
          <p className="text-white/80 text-xs sm:text-sm">èˆˆå‘³ã®ã‚ã‚‹ã“ã¨ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã­ï¼</p>
        </div>

      {/* ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ */}
      {/* <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <div className="flex">
          <div className="flex-shrink-0">
            <svg className="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
              <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
            </svg>
          </div>
          <div className="ml-3">
            <p className="text-sm text-blue-800">
              ã¾ãšãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚è¨­å®šå¾Œã€ãƒ›ãƒ¼ãƒ ã‹ã‚‰ç›¸æ‰‹ã®QRã‚’èª­ã¿å–ã‚‹ã‹ã€è‡ªåˆ†ã®QRã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚
            </p>
          </div>
        </div>
      </div> */}

        <div className="space-y-4">
          {Object.entries(TOPICS).map(([topicId, topic]) => {
            const isExpanded = expandedTopics.has(topicId)
            const hasSelections = hasSelectedOptions(topicId)

            return (
              <div key={topicId}
                   className="backdrop-blur-lg bg-white/90 rounded-xl shadow-xl overflow-hidden
                            transform transition-all duration-300 hover:scale-[1.01] hover:shadow-2xl">
                {/* ãƒˆãƒ”ãƒƒã‚¯ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼‰ */}
                <button
                  onClick={() => toggleTopic(topicId)}
                  className="w-full p-4 flex items-center justify-between
                           bg-gradient-to-r from-white/50 to-white/30
                           hover:from-white/60 hover:to-white/40 transition-all duration-300"
                >
                  <div className="flex items-center space-x-2">
                    <div className={`text-2xl transform transition-transform duration-300 ${isExpanded ? 'rotate-12 scale-110' : ''}`}>
                      {topic.icon}
                    </div>
                    <h2 className="text-sm sm:text-base font-bold bg-gradient-to-r from-purple-600 to-teal-500 bg-clip-text text-transparent">
                      {topic.label}
                    </h2>
                    {hasSelections && (
                      <Sparkles className="w-4 h-4 text-yellow-400 animate-pulse" />
                    )}
                  </div>
                  <div className="flex items-center space-x-2">
                    {hasSelections && (
                      <span className="px-2 py-1 text-xs font-bold text-white bg-gradient-to-r from-purple-500 to-teal-500 rounded-full">
                        {Object.values(profile[topicId] || {}).filter(option => option.selected).length}
                      </span>
                    )}
                    <svg
                      className={`w-5 h-5 text-purple-500 transition-transform duration-300 ${
                        isExpanded ? 'rotate-180' : ''
                      }`}
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                    </svg>
                  </div>
                </button>

                {/* é¸æŠè‚¢ï¼ˆå±•é–‹æ™‚ã®ã¿è¡¨ç¤ºï¼‰ - ã‚¿ã‚°ã‚¹ã‚¿ã‚¤ãƒ« */}
                {isExpanded && (
                  <div className="p-4 space-y-4 bg-white/40">
                    {/* ã‚¿ã‚°é¸æŠã‚¨ãƒªã‚¢ */}
                    <div className="flex flex-wrap gap-2">
                      {topic.options.map((option) => {
                        const isSelected = profile[topicId]?.[option]?.selected || false
                        return (
                          <button
                            key={option}
                            onClick={() => handleOptionToggle(topicId, option)}
                            className={`px-4 py-2 rounded-full font-medium text-sm transition-all duration-300 transform
                              ${isSelected
                                ? 'bg-gradient-to-r from-purple-500 to-teal-500 text-white scale-105 shadow-lg'
                                : 'bg-white/60 text-gray-700 hover:bg-white/80 hover:scale-105 shadow-md'
                              }`}
                          >
                            <span className="flex items-center gap-1">
                              {isSelected && <CheckCircle className="w-3 h-3" />}
                              {option}
                            </span>
                          </button>
                        )
                      })}
                    </div>

                    {/* é¸æŠã•ã‚ŒãŸã‚¿ã‚°ã®è©³ç´°å…¥åŠ› */}
                    <div className="space-y-3">
                      {topic.options.filter(option => profile[topicId]?.[option]?.selected).map((option) => (
                        <div key={option} className="backdrop-blur-md bg-white/50 rounded-xl p-3 shadow-inner">
                          <label className="text-sm font-medium text-purple-700 mb-1 block">
                            {option}ã®è©³ç´°
                          </label>
                          <input
                            type="text"
                            value={profile[topicId][option].freeText}
                            onChange={(e) => handleFreeTextChange(topicId, option, e.target.value)}
                            placeholder="è©³ã—ãæ•™ãˆã¦ãã ã•ã„"
                            className="w-full h-10 px-3 py-2 text-sm
                                     backdrop-blur-lg bg-white/60 border border-white/50
                                     rounded-lg shadow-inner
                                     focus:outline-none focus:ring-2 focus:ring-purple-400 focus:bg-white/80
                                     transition-all duration-300"
                            maxLength={100}
                            style={{ fontSize: '16px' }}
                          />
                          <p className="text-xs text-purple-600 mt-1 text-right font-medium">
                            {profile[topicId][option].freeText.length}/100
                          </p>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )
          })}
        </div>

        {/* ä¿å­˜ãƒœã‚¿ãƒ³ */}
        <div className="mt-6 relative">
          <button
            onClick={handleSave}
            disabled={isSaving}
            className={`w-full py-3 px-4 rounded-xl font-bold text-white text-base sm:text-lg
                     transform transition-all duration-300
                     ${isSaving
                       ? 'bg-gray-400 cursor-wait scale-95'
                       : 'bg-gradient-to-r from-pink-500 via-purple-500 to-teal-500 hover:scale-105 hover:shadow-2xl active:scale-95'
                     }
                     shadow-xl backdrop-blur-md relative overflow-hidden group`}
          >
            {/* ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */}
            {!isSaving && (
              <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent
                              -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
              </div>
            )}

            <span className="relative flex items-center justify-center gap-2">
              {isSaving ? (
                <>
                  <div className="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
                  ä¿å­˜ä¸­...
                </>
              ) : (
                <>
                  <Save className="w-5 h-5" />
                  ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜
                  <Sparkles className="w-4 h-4 animate-pulse" />
                </>
              )}
            </span>
          </button>

          {/* ä¿å­˜æˆåŠŸæ™‚ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ */}
          {toast.type === 'success' && toast.isVisible && (
            <div className="absolute inset-0 pointer-events-none">
              {[...Array(6)].map((_, i) => (
                <div
                  key={i}
                  className="absolute w-2 h-2 bg-yellow-400 rounded-full animate-ping"
                  style={{
                    left: `${20 + i * 15}%`,
                    top: '50%',
                    animationDelay: `${i * 0.1}s`,
                    animationDuration: '1s',
                  }}
                ></div>
              ))}
            </div>
          )}
        </div>

        {/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
        <Navigation />

        {/* ãƒˆãƒ¼ã‚¹ãƒˆ */}
        <Toast
          message={toast.message}
          type={toast.type}
          isVisible={toast.isVisible}
          onClose={hideToast}
        />
      </div>
    </div>
  )
}
</file>

<file path="src/app/home/page.tsx">
'use client'

import { useState, useEffect, useCallback, Suspense } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import Navigation from '@/components/Navigation'
import { LogOut, QrCode, Scan } from 'lucide-react'
import TopicModal from '@/components/TopicModal'
import Toast from '@/components/Toast'
import CameraScanner from '@/components/CameraScanner'

function HomeContent() {
  const [qrData, setQrData] = useState<{ url: string; svg: string } | null>(null)
  const [isLoading, setIsLoading] = useState(true)
  const [topic, setTopic] = useState<string>('')
  const [showTopicModal, setShowTopicModal] = useState(false)
  const [showScanner, setShowScanner] = useState(false)
  const [isTopicLoading, setIsTopicLoading] = useState(false)
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false
  })
  const router = useRouter()
  const searchParams = useSearchParams()

  useEffect(() => {
    fetchQR()
  }, [])

  const fetchQR = async () => {
    try {
      const response = await fetch('/api/qr/me', {
        credentials: 'include', // Added for better cookie handling
      })

      if (response.status === 401) {
        router.push('/auth/login')
        return
      }

      if (response.ok) {
        const data = await response.json()
        setQrData(data)
      } else {
        showToast('QRã‚³ãƒ¼ãƒ‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error')
      }
    } catch (error) {
      showToast('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error')
    } finally {
      setIsLoading(false)
    }
  }

  const showToast = (message: string, type: 'success' | 'error' | 'warning') => {
    setToast({ message, type, isVisible: true })
  }

  const hideToast = () => {
    setToast(prev => ({ ...prev, isVisible: false }))
  }

  const handleScanResult = useCallback(async (scannedSid: string) => {
    // å³åº§ã«å‡¦ç†ä¸­ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    setIsTopicLoading(true)
    setTopic('')
    setShowTopicModal(true)

    try {
      const response = await fetch('/api/scan', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include', // Added for better cookie handling
        body: JSON.stringify({ scannedSid }),
      })

      const data = await response.json()

      if (response.ok) {
        // æˆåŠŸ: ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã‚’æ›´æ–°
        setTopic(data.message)
        setIsTopicLoading(false)
        showToast('è©±é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼', 'success')
      } else if (response.status === 429) {
        // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³: ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ãƒˆãƒ¼ã‚¹ãƒˆã§é€šçŸ¥
        setIsTopicLoading(false)
        setShowTopicModal(false)
        showToast(data.message || 'æ™‚é–“ã‚’ãŠã„ã¦ãƒˆãƒ©ã‚¤ã—ã¦ãã ã•ã„ â³', 'warning')
      } else if (response.status === 503) {
        // ã‚µãƒ¼ãƒ“ã‚¹ä¸€æ™‚åˆ©ç”¨ä¸å¯
        setIsTopicLoading(false)
        setShowTopicModal(false)
        showToast(data.message || 'ã‚µãƒ¼ãƒ“ã‚¹ãŒä¸€æ™‚çš„ã«åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'warning')
      } else if (response.status === 500 && data.error === 'generation_failed') {
        // ç”Ÿæˆå¤±æ•—
        setIsTopicLoading(false)
        setShowTopicModal(false)
        showToast(data.message || 'è©±é¡Œã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚', 'warning')
      } else if (response.status === 401) {
        setIsTopicLoading(false)
        setShowTopicModal(false)
        router.push('/auth/login')
      } else if (response.status === 400 && data.error === 'self_scan') {
        setIsTopicLoading(false)
        setShowTopicModal(false)
        showToast('è‡ªåˆ†ã®QRã‚³ãƒ¼ãƒ‰ã¯ã‚¹ã‚­ãƒ£ãƒ³ã§ãã¾ã›ã‚“', 'warning')
      } else if (response.status === 404) {
        setIsTopicLoading(false)
        setShowTopicModal(false)
        showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'error')
      } else {
        setIsTopicLoading(false)
        setShowTopicModal(false)
        showToast('ã‚¹ã‚­ãƒ£ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error')
      }
    } catch (error) {
      setIsTopicLoading(false)
      setShowTopicModal(false)
      showToast('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error')
    }
  }, [router])

  // URLçµŒç”±ã®ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç†
  useEffect(() => {
    const scannedSid = searchParams.get('scannedSid')
    if (scannedSid && !isLoading) {
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
      router.replace('/home')
      // ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç†ã‚’å®Ÿè¡Œ
      handleScanResult(scannedSid)
    }
  }, [searchParams, isLoading, router, handleScanResult])

  const handleLogout = async () => {
    try {
      await fetch('/api/auth/logout', {
        method: 'POST',
        credentials: 'include', // Added for better cookie handling
      })
      router.push('/')
    } catch (error) {
      showToast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error')
    }
  }

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 via-teal-500 to-blue-600">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mx-auto mb-4"></div>
          <p className="text-white font-medium">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-600 via-teal-500 to-blue-600">
      {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      <div className="max-w-md mx-auto p-4 pb-20">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div className="flex justify-between items-center mb-4 pt-4">
          <div>
            <h1 className="text-xl sm:text-2xl font-bold text-white drop-shadow-lg">ãƒ›ãƒ¼ãƒ </h1>
            <p className="text-white/80 text-xs sm:text-sm">QRã‚³ãƒ¼ãƒ‰ã§æ–°ã—ã„å‡ºä¼šã„ã‚’</p>
          </div>
          <button
            onClick={handleLogout}
            className="p-2.5 backdrop-blur-lg bg-white/20 rounded-full
                     hover:bg-white/30 transition-all duration-300 transform hover:scale-110
                     shadow-lg group"
          >
            <LogOut className="w-4 h-4 sm:w-5 sm:h-5 text-white" />
          </button>
        </div>

        {/* QRã‚«ãƒ¼ãƒ‰ */}
        <div className="backdrop-blur-lg bg-white/90 rounded-2xl shadow-xl p-4 mb-6
                      transform transition-all duration-300 hover:scale-[1.02] hover:shadow-2xl">
          <div className="text-center mb-3">
            <h2 className="text-base sm:text-lg font-bold bg-gradient-to-r from-purple-600 to-teal-500 bg-clip-text text-transparent mb-1">
              ã‚ãªãŸã®QRã‚³ãƒ¼ãƒ‰
            </h2>
            <p className="text-xs sm:text-sm text-gray-600">å‹é”ã«èª­ã¿å–ã£ã¦ã‚‚ã‚‰ãŠã†</p>
          </div>

          {qrData ? (
            <div className="bg-white rounded-lg p-2 sm:p-3 shadow-inner flex items-center justify-center aspect-square">
              <div
                className="qr-container w-full max-w-[260px] sm:max-w-[300px] aspect-square"
                dangerouslySetInnerHTML={{ __html: qrData.svg }}
                style={{
                  display: 'block'
                }}
              />
            </div>
          ) : (
            <div className="flex items-center justify-center h-48 sm:h-64">
              <div className="animate-spin rounded-full h-8 w-8 sm:h-10 sm:w-10 border-4 border-purple-500 border-t-transparent"></div>
            </div>
          )}
        </div>

        {/* ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ */}
        <button
          onClick={() => setShowScanner(true)}
          className="w-full py-3 px-4 rounded-xl font-bold text-white text-base sm:text-lg
                   bg-gradient-to-r from-pink-500 via-purple-500 to-teal-500
                   transform transition-all duration-300 hover:scale-105 hover:shadow-2xl active:scale-95
                   shadow-xl backdrop-blur-md relative overflow-hidden group"
        >
          <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
            <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent
                          -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
          </div>
          <span className="relative flex items-center justify-center gap-2">
            <Scan className="w-5 h-5" />
            ç›¸æ‰‹ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹
          </span>
        </button>
      </div>

      {/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
      <Navigation />

      {/* ã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ */}
      <CameraScanner
        isOpen={showScanner}
        onClose={() => setShowScanner(false)}
        onScan={handleScanResult}
      />

      {/* ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      <TopicModal
        isOpen={showTopicModal}
        message={topic}
        isBusy={isTopicLoading}
        title={isTopicLoading ? 'QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šå®Œäº†' : 'ä¼šè©±ã®è©±é¡Œ'}
        subtitle={isTopicLoading ? 'AIãŒè©±é¡Œã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™' : undefined}
        onClose={() => {
          setShowTopicModal(false)
          setIsTopicLoading(false)
        }}
      />

      {/* ãƒˆãƒ¼ã‚¹ãƒˆ */}
      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={hideToast}
      />
    </div>
  )
}

export default function HomePage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 via-teal-500 to-blue-600">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mx-auto mb-4"></div>
          <p className="text-white font-medium">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    }>
      <HomeContent />
    </Suspense>
  )
}
</file>

</files>
