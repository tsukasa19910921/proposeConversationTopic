This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.claude/settings.local.json
.gitignore
CLAUDE.md
DEPLOYMENT_FIX.md
next.config.js
package.json
postcss.config.js
prisma/schema.prisma
src/app/api/auth/login/route.ts
src/app/api/auth/logout/route.ts
src/app/api/auth/signup/route.ts
src/app/api/metrics/me/route.ts
src/app/api/profile/me/route.ts
src/app/api/qr/me/route.ts
src/app/api/scan/route.ts
src/app/auth/login/page.tsx
src/app/auth/signup/page.tsx
src/app/globals.css
src/app/home/page.tsx
src/app/layout.tsx
src/app/metrics/page.tsx
src/app/page.tsx
src/app/profile/page.tsx
src/components/CameraScanner.tsx
src/components/Navigation.tsx
src/components/Toast.tsx
src/components/TopicModal.tsx
src/lib/cooldown.ts
src/lib/db.ts
src/lib/llm.ts
src/lib/qr.ts
src/lib/repos/counters.ts
src/lib/repos/profile.ts
src/lib/repos/users.ts
src/lib/session.ts
tailwind.config.js
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".claude/settings.local.json">
{
  "permissions": {
    "allow": [
      "Bash(npm run dev:*)",
      "Bash(curl:*)",
      "Bash(npm install:*)",
      "Bash(npx prisma generate:*)",
      "Bash(npx prisma:*)",
      "Bash(tasklist)",
      "Bash(taskkill:*)",
      "Bash(cp:*)"
    ],
    "deny": [],
    "ask": []
  }
}
</file>

<file path=".gitignore">
# dependencies
/node_modules
/.pnp
.pnp.js

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# local env files
.env*.local
.env

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="DEPLOYMENT_FIX.md">
# Vercelãƒ‡ãƒ—ãƒ­ã‚¤500ã‚¨ãƒ©ãƒ¼ä¿®æ­£ã‚¬ã‚¤ãƒ‰

## 1. å®Œäº†ã—ãŸä¿®æ­£
âœ… ã™ã¹ã¦ã®APIãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«å‹•çš„å®Ÿè¡Œè¨­å®šã‚’è¿½åŠ ã—ã¾ã—ãŸ
- cookies()ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚é™çš„ãƒ—ãƒªãƒ¬ãƒ³ãƒ€ãŒã§ããªã„ã‚¨ãƒ©ãƒ¼ã‚’è§£æ±º

## 2. Vercelç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### å¿…é ˆã®ç’°å¢ƒå¤‰æ•°
ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’Vercelã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§è¨­å®šã—ã¦ãã ã•ã„ï¼š

1. **DATABASE_URL** (å¿…é ˆ)
   - PostgreSQLã®æ¥ç¶šæ–‡å­—åˆ—
   - ä¾‹: `postgresql://user:password@host:5432/dbname?sslmode=require`
   - Supabase/Neonã®ç„¡æ–™ãƒ—ãƒ©ãƒ³ã§OK

2. **SESSION_SECRET** (å¿…é ˆ)
   - ãƒ©ãƒ³ãƒ€ãƒ ãªé•·ã„æ–‡å­—åˆ—ï¼ˆ32æ–‡å­—ä»¥ä¸Šæ¨å¥¨ï¼‰
   - æœªè¨­å®šã ã¨Cookieç½²åã§ã‚¨ãƒ©ãƒ¼â†’500ã‚¨ãƒ©ãƒ¼ã®åŸå› 
   - ç”Ÿæˆä¾‹: `openssl rand -hex 32`

3. **APP_BASE_URL** (å¿…é ˆ)
   - æœ¬ç•ªç’°å¢ƒã®URL
   - ä¾‹: `https://your-app-name.vercel.app`
   - QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã§ä½¿ç”¨

4. **GOOGLE_GEMINI_API_KEY** (å¿…é ˆ)
   - Google AI Studioã‹ã‚‰Gemini APIã‚­ãƒ¼ã‚’å–å¾—
   - https://makersuite.google.com/app/apikey

5. **SESSION_MAX_AGE_SECONDS** (ä»»æ„)
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 86400 (24æ™‚é–“)

### è¨­å®šæ‰‹é †
1. Vercelãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ãƒ­ã‚°ã‚¤ãƒ³
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
3. Settings â†’ Environment Variables
4. å„ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ï¼ˆProduction/Preview/Developmentå…¨ã¦ã«ãƒã‚§ãƒƒã‚¯ï¼‰
5. Save

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–

### Supabaseã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼š
```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œ
npx prisma db push
```

ã¾ãŸã¯ã€Vercelã®ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒƒãƒ—ã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™ï¼ˆpackage.jsonã®buildã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰

## 4. å†ãƒ‡ãƒ—ãƒ­ã‚¤
ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ãŸã‚‰ã€å†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œï¼š
```bash
vercel --prod
```

## 5. å‹•ä½œç¢ºèª

### APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
```bash
# ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ
curl -X POST https://your-app.vercel.app/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"userId":"test1","password":"password123"}'

# ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼ˆæˆåŠŸï¼‰
# {"ok":true}
# Set-Cookie: sid=...
```

### ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®ç¢ºèª
1. `/auth/signup`ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
2. `/home`ã§è‡ªåˆ†ã®QRè¡¨ç¤ºç¢ºèª
3. `/metrics`ã§å®Ÿç¸¾è¡¨ç¤ºç¢ºèª

## 6. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 500ã‚¨ãƒ©ãƒ¼ãŒç¶šãå ´åˆ
- Vercelã® Functions ãƒ­ã‚°ã‚’ç¢ºèª
- ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹å†ç¢ºèª
- DATABASE_URLã®æ¥ç¶šæ–‡å­—åˆ—ãŒæ­£ã—ã„ã‹ç¢ºèª

### "Dynamic server usage"ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆ
- ã™ã¹ã¦ã®APIãƒ«ãƒ¼ãƒˆã«`export const dynamic = 'force-dynamic'`ãŒã‚ã‚‹ã‹ç¢ºèª
- å†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œ

### favicon.ico 404ã‚¨ãƒ©ãƒ¼
- `/public/favicon.ico`ã‚’è¿½åŠ ï¼ˆä»»æ„ï¼‰
</file>

<file path="postcss.config.js">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};
</file>

<file path="src/app/auth/login/page.tsx">
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'

export default function LoginPage() {
  const [userId, setUserId] = useState('')
  const [password, setPassword] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState('')
  const router = useRouter()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsLoading(true)
    setError('')

    try {
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ userId, password }),
      })

      const data = await response.json()

      if (response.ok) {
        router.push('/home')
      } else {
        setError(data.error === 'invalid_credentials' ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“' : 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ')
      }
    } catch (error) {
      setError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div className="max-w-md mx-auto p-4">
      <div className="text-center mb-8">
        <h1 className="text-2xl font-bold text-gray-800 mb-2">ãƒ­ã‚°ã‚¤ãƒ³</h1>
        <p className="text-gray-600">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
      </div>

      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label htmlFor="userId" className="block text-sm font-medium text-gray-700 mb-1">
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
          </label>
          <input
            type="text"
            id="userId"
            value={userId}
            onChange={(e) => setUserId(e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            required
            disabled={isLoading}
          />
        </div>

        <div>
          <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">
            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
          </label>
          <input
            type="password"
            id="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            required
            disabled={isLoading}
          />
        </div>

        {error && (
          <div className="text-red-600 text-sm text-center bg-red-50 p-2 rounded-lg">
            {error}
          </div>
        )}

        <button
          type="submit"
          disabled={isLoading}
          className="w-full py-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {isLoading ? 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...' : 'ãƒ­ã‚°ã‚¤ãƒ³'}
        </button>
      </form>

      <div className="mt-6 text-center">
        <p className="text-gray-600">
          ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„å ´åˆ{' '}
          <Link href="/auth/signup" className="text-blue-500 hover:text-blue-600 font-medium">
            æ–°è¦ç™»éŒ²
          </Link>
        </p>
      </div>
    </div>
  )
}
</file>

<file path="src/app/auth/signup/page.tsx">
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'

export default function SignupPage() {
  const [userId, setUserId] = useState('')
  const [password, setPassword] = useState('')
  const [confirmPassword, setConfirmPassword] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState('')
  const router = useRouter()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setError('')

    if (password !== confirmPassword) {
      setError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“')
      return
    }

    if (password.length < 6) {
      setError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„')
      return
    }

    setIsLoading(true)

    try {
      const response = await fetch('/api/auth/signup', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ userId, password }),
      })

      const data = await response.json()

      if (response.ok) {
        router.push('/home')
      } else {
        setError(data.error === 'user_exists' ? 'ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™' : 'æ–°è¦ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ')
      }
    } catch (error) {
      setError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div className="max-w-md mx-auto p-4">
      <div className="text-center mb-8">
        <h1 className="text-2xl font-bold text-gray-800 mb-2">æ–°è¦ç™»éŒ²</h1>
        <p className="text-gray-600">æ–°ã—ã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„</p>
      </div>

      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label htmlFor="userId" className="block text-sm font-medium text-gray-700 mb-1">
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
          </label>
          <input
            type="text"
            id="userId"
            value={userId}
            onChange={(e) => setUserId(e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
            required
            disabled={isLoading}
            minLength={3}
          />
          <p className="text-xs text-gray-500 mt-1">3æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        </div>

        <div>
          <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">
            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
          </label>
          <input
            type="password"
            id="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
            required
            disabled={isLoading}
            minLength={6}
          />
          <p className="text-xs text-gray-500 mt-1">6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        </div>

        <div>
          <label htmlFor="confirmPassword" className="block text-sm font-medium text-gray-700 mb-1">
            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
          </label>
          <input
            type="password"
            id="confirmPassword"
            value={confirmPassword}
            onChange={(e) => setConfirmPassword(e.target.value)}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
            required
            disabled={isLoading}
          />
        </div>

        {error && (
          <div className="text-red-600 text-sm text-center bg-red-50 p-2 rounded-lg">
            {error}
          </div>
        )}

        <button
          type="submit"
          disabled={isLoading}
          className="w-full py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {isLoading ? 'ç™»éŒ²ä¸­...' : 'æ–°è¦ç™»éŒ²'}
        </button>
      </form>

      <div className="mt-6 text-center">
        <p className="text-gray-600">
          æ—¢ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®å ´åˆ{' '}
          <Link href="/auth/login" className="text-blue-500 hover:text-blue-600 font-medium">
            ãƒ­ã‚°ã‚¤ãƒ³
          </Link>
        </p>
      </div>
    </div>
  )
}
</file>

<file path="src/app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

/* QR Scanner Animation */
@keyframes scan {
  0% {
    top: 0;
  }
  50% {
    top: calc(100% - 4px);
  }
  100% {
    top: 0;
  }
}

.animate-scan {
  animation: scan 2s ease-in-out infinite;
}
</file>

<file path="src/app/home/page.tsx">
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import Navigation from '@/components/Navigation'
import TopicModal from '@/components/TopicModal'
import Toast from '@/components/Toast'
import CameraScanner from '@/components/CameraScanner'

export default function HomePage() {
  const [qrData, setQrData] = useState<{ url: string; svg: string } | null>(null)
  const [isLoading, setIsLoading] = useState(true)
  const [topic, setTopic] = useState<string>('')
  const [showTopicModal, setShowTopicModal] = useState(false)
  const [showScanner, setShowScanner] = useState(false)
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false
  })
  const router = useRouter()

  useEffect(() => {
    fetchQR()
  }, [])

  const fetchQR = async () => {
    try {
      const response = await fetch('/api/qr/me')

      if (response.status === 401) {
        router.push('/auth/login')
        return
      }

      if (response.ok) {
        const data = await response.json()
        setQrData(data)
      } else {
        showToast('QRã‚³ãƒ¼ãƒ‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error')
      }
    } catch (error) {
      showToast('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error')
    } finally {
      setIsLoading(false)
    }
  }

  const showToast = (message: string, type: 'success' | 'error' | 'warning') => {
    setToast({ message, type, isVisible: true })
  }

  const hideToast = () => {
    setToast(prev => ({ ...prev, isVisible: false }))
  }

  const handleScanResult = async (scannedSid: string) => {
    try {
      const response = await fetch('/api/scan', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ scannedSid }),
      })

      const data = await response.json()

      if (response.ok) {
        setTopic(data.message)
        setShowTopicModal(true)
        showToast('ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸï¼', 'success')
      } else if (response.status === 429) {
        showToast(data.message || 'æ™‚é–“ã‚’ãŠã„ã¦ãƒˆãƒ©ã‚¤ã—ã¦ãã ã•ã„', 'warning')
      } else if (response.status === 401) {
        router.push('/auth/login')
      } else if (response.status === 400 && data.error === 'self_scan') {
        showToast('è‡ªåˆ†ã®QRã‚³ãƒ¼ãƒ‰ã¯ã‚¹ã‚­ãƒ£ãƒ³ã§ãã¾ã›ã‚“', 'warning')
      } else if (response.status === 404) {
        showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'error')
      } else {
        showToast('ã‚¹ã‚­ãƒ£ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error')
      }
    } catch (error) {
      showToast('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error')
    }
  }

  const handleLogout = async () => {
    try {
      await fetch('/api/auth/logout', { method: 'POST' })
      router.push('/')
    } catch (error) {
      showToast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error')
    }
  }

  if (isLoading) {
    return (
      <div className="max-w-md mx-auto p-4 pb-20 min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
          <p className="text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="max-w-md mx-auto p-4 pb-20 min-h-screen">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-xl font-bold text-gray-800">ãƒ›ãƒ¼ãƒ </h1>
        <button
          onClick={handleLogout}
          className="text-sm text-gray-600 hover:text-gray-800"
        >
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>

      {/* QRã‚³ãƒ¼ãƒ‰è¡¨ç¤º */}
      <div className="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 className="text-lg font-semibold text-gray-800 mb-4 text-center">
          ã‚ãªãŸã®QRã‚³ãƒ¼ãƒ‰
        </h2>
        {qrData ? (
          <div className="flex justify-center">
            <div
              className="w-48 h-48 border border-gray-200 rounded-lg p-2"
              dangerouslySetInnerHTML={{ __html: qrData.svg }}
            />
          </div>
        ) : (
          <div className="flex justify-center">
            <div className="w-48 h-48 border border-gray-200 rounded-lg flex items-center justify-center bg-gray-50">
              <span className="text-gray-400">QRã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
          </div>
        )}
        <p className="text-xs text-gray-500 text-center mt-2">
          ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ç›¸æ‰‹ã«èª­ã¿å–ã£ã¦ã‚‚ã‚‰ã„ã¾ã—ã‚‡ã†
        </p>
      </div>

      {/* ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ */}
      <div className="space-y-3">
        <button
          onClick={() => setShowScanner(true)}
          className="w-full py-3 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-lg font-medium"
        >
          ğŸ“± ç›¸æ‰‹ã®QRã‚’èª­ã¿å–ã‚‹
        </button>
      </div>

      {/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
      <Navigation />

      {/* ã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ */}
      <CameraScanner
        isOpen={showScanner}
        onClose={() => setShowScanner(false)}
        onScan={handleScanResult}
      />

      {/* ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      <TopicModal
        isOpen={showTopicModal}
        message={topic}
        onClose={() => setShowTopicModal(false)}
      />

      {/* ãƒˆãƒ¼ã‚¹ãƒˆ */}
      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={hideToast}
      />
    </div>
  )
}
</file>

<file path="src/app/layout.tsx">
import './globals.css'
import { Inter } from 'next/font/google'

const inter = Inter({ subsets: ['latin'] })

export const metadata = {
  title: 'QRãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«Ã—è©±é¡Œæç¤º',
  description: 'é«˜æ ¡ç”Ÿå‘ã‘QRäº¤æ›ã‚¢ãƒ—ãƒª',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body className={inter.className}>
        <main className="min-h-screen bg-gray-50">
          {children}
        </main>
      </body>
    </html>
  )
}
</file>

<file path="src/app/metrics/page.tsx">
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import Navigation from '@/components/Navigation'
import Toast from '@/components/Toast'

interface MetricsData {
  scanOut: number
  scanIn: number
}

export default function MetricsPage() {
  const [metrics, setMetrics] = useState<MetricsData>({ scanOut: 0, scanIn: 0 })
  const [isLoading, setIsLoading] = useState(true)
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false
  })
  const router = useRouter()

  useEffect(() => {
    fetchMetrics()
  }, [])

  const fetchMetrics = async () => {
    try {
      const response = await fetch('/api/metrics/me')

      if (response.status === 401) {
        router.push('/auth/login')
        return
      }

      if (response.ok) {
        const data = await response.json()
        setMetrics(data)
      } else {
        showToast('å®Ÿç¸¾ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error')
      }
    } catch (error) {
      showToast('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error')
    } finally {
      setIsLoading(false)
    }
  }

  const showToast = (message: string, type: 'success' | 'error' | 'warning') => {
    setToast({ message, type, isVisible: true })
  }

  const hideToast = () => {
    setToast(prev => ({ ...prev, isVisible: false }))
  }

  if (isLoading) {
    return (
      <div className="max-w-md mx-auto p-4 pb-20 min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
          <p className="text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="max-w-md mx-auto p-4 pb-20 min-h-screen">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-xl font-bold text-gray-800">å®Ÿç¸¾</h1>
        <button
          onClick={fetchMetrics}
          className="text-sm text-blue-500 hover:text-blue-600"
        >
          æ›´æ–°
        </button>
      </div>

      {/* å®Ÿç¸¾ã‚«ãƒ¼ãƒ‰ */}
      <div className="space-y-4">
        {/* èª­ã¿å–ã‚Šå›æ•° */}
        <div className="bg-white rounded-lg shadow-md p-6">
          <div className="flex items-center justify-between">
            <div>
              <div className="flex items-center space-x-2 mb-2">
                <span className="text-2xl">ğŸ“±</span>
                <h2 className="text-lg font-semibold text-gray-800">èª­ã¿å–ã‚Šå›æ•°</h2>
              </div>
              <p className="text-sm text-gray-600">
                ã‚ãªãŸãŒä»–ã®äººã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ãŸå›æ•°
              </p>
            </div>
            <div className="text-right">
              <div className="text-3xl font-bold text-blue-500">{metrics.scanOut}</div>
              <div className="text-sm text-gray-500">å›</div>
            </div>
          </div>
        </div>

        {/* èª­ã¿å–ã‚‰ã‚Œå›æ•° */}
        <div className="bg-white rounded-lg shadow-md p-6">
          <div className="flex items-center justify-between">
            <div>
              <div className="flex items-center space-x-2 mb-2">
                <span className="text-2xl">âœ¨</span>
                <h2 className="text-lg font-semibold text-gray-800">èª­ã¿å–ã‚‰ã‚Œå›æ•°</h2>
              </div>
              <p className="text-sm text-gray-600">
                ä»–ã®äººãŒã‚ãªãŸã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ãŸå›æ•°
              </p>
            </div>
            <div className="text-right">
              <div className="text-3xl font-bold text-green-500">{metrics.scanIn}</div>
              <div className="text-sm text-gray-500">å›</div>
            </div>
          </div>
        </div>

        {/* ç·åˆå®Ÿç¸¾ */}
        <div className="bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg shadow-md p-6 text-white">
          <div className="text-center">
            <div className="text-2xl mb-2">ğŸ†</div>
            <h2 className="text-lg font-semibold mb-2">ç·åˆå®Ÿç¸¾</h2>
            <div className="text-2xl font-bold mb-1">
              {metrics.scanOut + metrics.scanIn}
            </div>
            <div className="text-sm opacity-90">
              ç·äº¤æµå›æ•°
            </div>
            <div className="mt-4 text-xs opacity-75">
              QRã‚³ãƒ¼ãƒ‰ã‚’é€šã˜ã¦{metrics.scanOut + metrics.scanIn}å›ã®å‡ºä¼šã„ãŒã‚ã‚Šã¾ã—ãŸï¼
            </div>
          </div>
        </div>

        {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
        <div className="text-center">
          {metrics.scanOut + metrics.scanIn === 0 ? (
            <p className="text-gray-500 text-sm">
              ã¾ã äº¤æµãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br />
              ãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ã€<br />
              æ–°ã—ã„å‡ºä¼šã„ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼
            </p>
          ) : (
            <p className="text-gray-500 text-sm">
              ç´ æ™´ã‚‰ã—ã„äº¤æµå®Ÿç¸¾ã§ã™ï¼<br />
              å¼•ãç¶šãæ–°ã—ã„å‡ºä¼šã„ã‚’æ¥½ã—ã‚“ã§ãã ã•ã„ã€‚
            </p>
          )}
        </div>
      </div>

      {/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
      <Navigation />

      {/* ãƒˆãƒ¼ã‚¹ãƒˆ */}
      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={hideToast}
      />
    </div>
  )
}
</file>

<file path="src/app/page.tsx">
'use client'

import { useState } from 'react'
import Link from 'next/link'

export default function HomePage() {
  const [isLoggedIn, setIsLoggedIn] = useState(false)

  return (
    <div className="max-w-md mx-auto p-4">
      <div className="text-center mb-8">
        <h1 className="text-2xl font-bold text-gray-800 mb-2">
          QRãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«Ã—è©±é¡Œæç¤º
        </h1>
        <p className="text-gray-600">
          QRã‚³ãƒ¼ãƒ‰ã‚’äº¤æ›ã—ã¦ã€ä¼šè©±ã®ãã£ã‹ã‘ã‚’è¦‹ã¤ã‘ã‚ˆã†ï¼
        </p>
      </div>

      {!isLoggedIn ? (
        <div className="space-y-4">
          <Link
            href="/auth/login"
            className="block w-full py-3 px-4 bg-blue-500 text-white text-center rounded-lg hover:bg-blue-600 transition-colors"
          >
            ãƒ­ã‚°ã‚¤ãƒ³
          </Link>
          <Link
            href="/auth/signup"
            className="block w-full py-3 px-4 bg-green-500 text-white text-center rounded-lg hover:bg-green-600 transition-colors"
          >
            æ–°è¦ç™»éŒ²
          </Link>
        </div>
      ) : (
        <div className="text-center">
          <p className="text-gray-600 mb-4">ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿</p>
          <Link
            href="/home"
            className="inline-block py-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
          >
            ãƒ›ãƒ¼ãƒ ã«é€²ã‚€
          </Link>
        </div>
      )}
    </div>
  )
}
</file>

<file path="src/app/profile/page.tsx">
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import Navigation from '@/components/Navigation'
import Toast from '@/components/Toast'

const TOPICS = {
  sports: {
    label: 'ã‚¹ãƒãƒ¼ãƒ„',
    icon: 'âš½',
    options: ['é‡çƒ', 'ã‚µãƒƒã‚«ãƒ¼', 'å“çƒ', 'ãƒ†ãƒ‹ã‚¹', 'ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«', 'ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«', 'ã‚´ãƒ«ãƒ•', 'ãã®ä»–']
  },
  music: {
    label: 'éŸ³æ¥½',
    icon: 'ğŸµ',
    options: ['J-POP', 'K-POP', 'ãƒ­ãƒƒã‚¯', 'ã‚¸ãƒ£ã‚º', 'ã‚¯ãƒ©ã‚·ãƒƒã‚¯', 'ã‚¢ãƒ‹ã‚½ãƒ³', 'ãƒœã‚«ãƒ­', 'ãã®ä»–']
  },
  food: {
    label: 'é£Ÿäº‹',
    icon: 'ğŸ•',
    options: ['å’Œé£Ÿ', 'æ´‹é£Ÿ', 'ä¸­è¯', 'ã‚¤ã‚¿ãƒªã‚¢ãƒ³', 'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰', 'ãŠè“å­ä½œã‚Š', 'ã‚«ãƒ•ã‚§', 'ãã®ä»–']
  },
  movies: {
    label: 'æ˜ ç”»ãƒ»ãƒ‰ãƒ©ãƒ',
    icon: 'ğŸ¬',
    options: ['é‚¦ç”»', 'æ´‹ç”»', 'éŸ“å›½ãƒ‰ãƒ©ãƒ', 'ã‚¢ãƒ‹ãƒ¡', 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼', 'ã‚³ãƒ¡ãƒ‡ã‚£', 'ãƒ›ãƒ©ãƒ¼', 'ãã®ä»–']
  },
  games: {
    label: 'ã‚²ãƒ¼ãƒ ',
    icon: 'ğŸ®',
    options: ['RPG', 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³', 'ãƒ‘ã‚ºãƒ«', 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', 'FPS', 'ãƒ¢ãƒã‚¤ãƒ«ã‚²ãƒ¼ãƒ ', 'ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ', 'ãã®ä»–']
  },
  books: {
    label: 'èª­æ›¸',
    icon: 'ğŸ“š',
    options: ['å°èª¬', 'æ¼«ç”»', 'ãƒ©ã‚¤ãƒˆãƒãƒ™ãƒ«', 'ãƒ“ã‚¸ãƒã‚¹æ›¸', 'è‡ªå·±å•“ç™º', 'æ­´å²', 'ç§‘å­¦', 'ãã®ä»–']
  }
}

interface ProfileData {
  [topicId: string]: {
    [option: string]: {
      selected: boolean
      freeText: string
    }
  }
}

export default function ProfilePage() {
  const [profile, setProfile] = useState<ProfileData>({})
  const [expandedTopics, setExpandedTopics] = useState<Set<string>>(new Set())
  const [isLoading, setIsLoading] = useState(true)
  const [isSaving, setIsSaving] = useState(false)
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false
  })
  const router = useRouter()

  useEffect(() => {
    fetchProfile()
  }, [])

  const initializeProfileStructure = () => {
    const initialProfile: ProfileData = {}
    Object.keys(TOPICS).forEach(topicId => {
      initialProfile[topicId] = {}
      TOPICS[topicId as keyof typeof TOPICS].options.forEach(option => {
        initialProfile[topicId][option] = {
          selected: false,
          freeText: ''
        }
      })
    })
    return initialProfile
  }

  const fetchProfile = async () => {
    try {
      const response = await fetch('/api/profile/me')

      if (response.status === 401) {
        router.push('/auth/login')
        return
      }

      if (response.ok) {
        const data = await response.json()
        const initialProfile = initializeProfileStructure()

        if (data && Object.keys(data).length > 0) {
          Object.keys(data).forEach(topicId => {
            if (initialProfile[topicId] && data[topicId]) {
              Object.keys(data[topicId]).forEach(option => {
                if (initialProfile[topicId][option]) {
                  initialProfile[topicId][option] = {
                    selected: data[topicId][option]?.selected || false,
                    freeText: data[topicId][option]?.freeText || ''
                  }
                }
              })
            }
          })
        }

        setProfile(initialProfile)
      } else {
        setProfile(initializeProfileStructure())
      }
    } catch (error) {
      showToast('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error')
      setProfile(initializeProfileStructure())
    } finally {
      setIsLoading(false)
    }
  }

  const showToast = (message: string, type: 'success' | 'error' | 'warning') => {
    setToast({ message, type, isVisible: true })
  }

  const hideToast = () => {
    setToast(prev => ({ ...prev, isVisible: false }))
  }

  const handleOptionToggle = (topicId: string, option: string) => {
    setProfile(prev => ({
      ...prev,
      [topicId]: {
        ...prev[topicId],
        [option]: {
          ...prev[topicId][option],
          selected: !prev[topicId][option].selected
        }
      }
    }))
  }

  const handleFreeTextChange = (topicId: string, option: string, value: string) => {
    setProfile(prev => ({
      ...prev,
      [topicId]: {
        ...prev[topicId],
        [option]: {
          ...prev[topicId][option],
          freeText: value
        }
      }
    }))
  }

  const toggleTopic = (topicId: string) => {
    setExpandedTopics(prev => {
      const newSet = new Set(prev)
      if (newSet.has(topicId)) {
        newSet.delete(topicId)
      } else {
        newSet.add(topicId)
      }
      return newSet
    })
  }

  const hasSelectedOptions = (topicId: string) => {
    return Object.values(profile[topicId] || {}).some(option => option.selected)
  }

  const handleSave = async () => {
    setIsSaving(true)

    try {
      const response = await fetch('/api/profile/me', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(profile),
      })

      if (response.status === 401) {
        router.push('/auth/login')
        return
      }

      if (response.ok) {
        showToast('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success')
      } else {
        showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error')
      }
    } catch (error) {
      showToast('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error')
    } finally {
      setIsSaving(false)
    }
  }

  if (isLoading) {
    return (
      <div className="max-w-md mx-auto p-4 pb-20 min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
          <p className="text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="max-w-md mx-auto p-4 pb-20 min-h-screen">
      <h1 className="text-xl font-bold text-gray-800 mb-6">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h1>

      <div className="space-y-4">
        {Object.entries(TOPICS).map(([topicId, topic]) => {
          const isExpanded = expandedTopics.has(topicId)
          const hasSelections = hasSelectedOptions(topicId)

          return (
            <div key={topicId} className="bg-white rounded-lg shadow-md overflow-hidden">
              {/* ãƒˆãƒ”ãƒƒã‚¯ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼‰ */}
              <button
                onClick={() => toggleTopic(topicId)}
                className="w-full p-4 flex items-center justify-between hover:bg-gray-50 transition-colors"
              >
                <div className="flex items-center space-x-3">
                  <span className="text-2xl">{topic.icon}</span>
                  <h2 className="text-lg font-semibold text-gray-800">{topic.label}</h2>
                  {hasSelections && (
                    <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                  )}
                </div>
                <div className="flex items-center space-x-2">
                  {hasSelections && (
                    <span className="text-xs text-blue-600 font-medium">
                      {Object.values(profile[topicId] || {}).filter(option => option.selected).length}ä»¶é¸æŠä¸­
                    </span>
                  )}
                  <svg
                    className={`w-5 h-5 text-gray-500 transition-transform duration-200 ${
                      isExpanded ? 'rotate-180' : ''
                    }`}
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                  </svg>
                </div>
              </button>

              {/* é¸æŠè‚¢ï¼ˆå±•é–‹æ™‚ã®ã¿è¡¨ç¤ºï¼‰ */}
              {isExpanded && (
                <div className="px-4 pb-4 space-y-3 border-t border-gray-100 pt-4">
                  {topic.options.map((option) => (
                    <div key={option} className="space-y-2">
                      {/* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */}
                      <label className="flex items-center space-x-3 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={profile[topicId]?.[option]?.selected || false}
                          onChange={() => handleOptionToggle(topicId, option)}
                          className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
                        />
                        <span className="text-gray-700">{option}</span>
                      </label>

                      {/* è‡ªç”±å…¥åŠ›æ¬„ï¼ˆé¸æŠæ™‚ã®ã¿è¡¨ç¤ºï¼‰ */}
                      {profile[topicId]?.[option]?.selected && (
                        <div className="ml-7">
                          <textarea
                            value={profile[topicId][option].freeText}
                            onChange={(e) => handleFreeTextChange(topicId, option, e.target.value)}
                            placeholder={`${option}ã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦ãã ã•ã„...`}
                            className="w-full h-20 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none bg-blue-50"
                            maxLength={100}
                          />
                          <p className="text-xs text-gray-500 mt-1 text-right">
                            {profile[topicId][option].freeText.length}/100æ–‡å­—
                          </p>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )
        })}
      </div>

      {/* ä¿å­˜ãƒœã‚¿ãƒ³ */}
      <div className="mt-6">
        <button
          onClick={handleSave}
          disabled={isSaving}
          className="w-full py-3 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {isSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜ã™ã‚‹'}
        </button>
      </div>

      {/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
      <Navigation />

      {/* ãƒˆãƒ¼ã‚¹ãƒˆ */}
      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={hideToast}
      />
    </div>
  )
}
</file>

<file path="src/components/CameraScanner.tsx">
'use client';

import { useState, useEffect } from 'react';
import dynamic from 'next/dynamic';

// Dynamic import to avoid SSR issues - using Scanner instead of QrScanner
const Scanner = dynamic(
  () => import('@yudiel/react-qr-scanner').then((mod) => mod.Scanner),
  {
    ssr: false,
    loading: () => (
      <div className="flex items-center justify-center h-full">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    )
  }
);

interface CameraScannerProps {
  isOpen: boolean;
  onClose: () => void;
  onScan: (data: string) => void;
}

export default function CameraScanner({ isOpen, onClose, onScan }: CameraScannerProps) {
  const [hasPermission, setHasPermission] = useState<boolean | null>(null);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (isOpen) {
      // Reset states when scanner opens
      setError(null);
      setHasPermission(null);

      // Request camera permission
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(() => setHasPermission(true))
        .catch(() => {
          setHasPermission(false);
          setError('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        });
    }
  }, [isOpen]);

  if (!isOpen) return null;

  const handleDecode = (result: string) => {
    // Parse the QR code URL to extract sid
    try {
      const url = new URL(result);
      const sid = url.searchParams.get('sid');
      if (sid) {
        onScan(sid);
        onClose();
      } else {
        setError('ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™');
      }
    } catch {
      // Handle non-URL QR codes
      setError('ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™');
    }
  };

  const handleError = (error: any) => {
    console.error('QR Scanner Error:', error);
    setError('ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-90 flex flex-col z-50">
      <div className="bg-white text-black p-4 flex justify-between items-center">
        <h2 className="text-xl font-semibold">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</h2>
        <button
          onClick={onClose}
          className="text-gray-600 hover:text-gray-800 text-2xl"
        >
          âœ•
        </button>
      </div>

      <div className="flex-1 relative">
        {hasPermission === false ? (
          <div className="flex flex-col items-center justify-center h-full text-white p-4">
            <svg
              className="w-24 h-24 mb-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
              />
            </svg>
            <p className="text-center mb-4">ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ</p>
            <p className="text-sm text-gray-300 text-center">
              ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„
            </p>
          </div>
        ) : hasPermission === null ? (
          <div className="flex flex-col items-center justify-center h-full text-white">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div>
            <p>ã‚«ãƒ¡ãƒ©ã®è¨±å¯ã‚’ç¢ºèªä¸­...</p>
          </div>
        ) : (
          <>
            <Scanner
              onScan={(result) => {
                if (result && result.length > 0) {
                  handleDecode(result[0].rawValue);
                }
              }}
              onError={handleError}
              constraints={{
                facingMode: { ideal: 'environment' }
              }}
              styles={{
                container: {
                  width: '100%',
                  height: '100%'
                },
                video: {
                  width: '100%',
                  height: '100%',
                  objectFit: 'cover' as const
                }
              }}
            />

            {/* Scanning overlay */}
            <div className="absolute inset-0 pointer-events-none">
              <div className="absolute inset-0 flex items-center justify-center">
                <div className="relative w-64 h-64">
                  {/* Corner markers */}
                  <div className="absolute top-0 left-0 w-12 h-12 border-t-4 border-l-4 border-white rounded-tl-lg"></div>
                  <div className="absolute top-0 right-0 w-12 h-12 border-t-4 border-r-4 border-white rounded-tr-lg"></div>
                  <div className="absolute bottom-0 left-0 w-12 h-12 border-b-4 border-l-4 border-white rounded-bl-lg"></div>
                  <div className="absolute bottom-0 right-0 w-12 h-12 border-b-4 border-r-4 border-white rounded-br-lg"></div>

                  {/* Scanning line animation */}
                  <div className="absolute inset-x-0 h-1 bg-gradient-to-r from-transparent via-blue-400 to-transparent animate-scan"></div>
                </div>
              </div>

              {/* Instructions */}
              <div className="absolute bottom-20 left-0 right-0 text-center text-white">
                <p className="text-lg">QRã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«åˆã‚ã›ã¦ãã ã•ã„</p>
              </div>
            </div>
          </>
        )}

        {error && (
          <div className="absolute top-20 left-4 right-4 bg-red-500 text-white p-4 rounded-lg">
            <p>{error}</p>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/components/Navigation.tsx">
'use client'

import Link from 'next/link'
import { usePathname } from 'next/navigation'

export default function Navigation() {
  const pathname = usePathname()

  const navItems = [
    { href: '/home', label: 'ãƒ›ãƒ¼ãƒ ', icon: 'ğŸ ' },
    { href: '/profile', label: 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«', icon: 'ğŸ‘¤' },
    { href: '/metrics', label: 'å®Ÿç¸¾', icon: 'ğŸ“Š' },
  ]

  return (
    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200">
      <div className="max-w-md mx-auto">
        <div className="flex justify-around">
          {navItems.map((item) => (
            <Link
              key={item.href}
              href={item.href}
              className={`flex flex-col items-center py-2 px-4 text-xs ${
                pathname === item.href
                  ? 'text-blue-500'
                  : 'text-gray-600 hover:text-gray-800'
              }`}
            >
              <span className="text-xl mb-1">{item.icon}</span>
              <span>{item.label}</span>
            </Link>
          ))}
        </div>
      </div>
    </nav>
  )
}
</file>

<file path="src/components/Toast.tsx">
'use client'

import { useEffect } from 'react'

interface ToastProps {
  message: string
  type: 'success' | 'error' | 'warning'
  isVisible: boolean
  onClose: () => void
}

export default function Toast({ message, type, isVisible, onClose }: ToastProps) {
  useEffect(() => {
    if (isVisible) {
      const timer = setTimeout(() => {
        onClose()
      }, 3000)
      return () => clearTimeout(timer)
    }
  }, [isVisible, onClose])

  if (!isVisible) return null

  const bgColor = {
    success: 'bg-green-500',
    error: 'bg-red-500',
    warning: 'bg-yellow-500',
  }[type]

  const icon = {
    success: 'âœ…',
    error: 'âŒ',
    warning: 'â³',
  }[type]

  return (
    <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-50">
      <div className={`${bgColor} text-white px-4 py-2 rounded-lg shadow-lg flex items-center space-x-2`}>
        <span>{icon}</span>
        <span>{message}</span>
      </div>
    </div>
  )
}
</file>

<file path="src/components/TopicModal.tsx">
'use client'

interface TopicModalProps {
  isOpen: boolean
  message: string
  onClose: () => void
}

export default function TopicModal({ isOpen, message, onClose }: TopicModalProps) {
  if (!isOpen) return null

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg max-w-md w-full p-6">
        <div className="text-center">
          <div className="text-4xl mb-4">ğŸ’¬</div>
          <h2 className="text-xl font-bold text-gray-800 mb-4">ä¼šè©±ã®è©±é¡Œ</h2>
          <p className="text-gray-700 mb-6 leading-relaxed">{message}</p>
          <button
            onClick={onClose}
            className="w-full py-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
          >
            é–‰ã˜ã‚‹
          </button>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="src/lib/cooldown.ts">
const mem = new Map<string, number>();
const WINDOW = 30_000; // 30 seconds

export async function canScan(scannerId: string, scannedId: string) {
  const key = `${scannerId}:${scannedId}`;
  const now = Date.now();
  const last = mem.get(key) ?? 0;

  if (now - last < WINDOW) {
    return { ok: false, waitMs: WINDOW - (now - last) };
  }

  mem.set(key, now);
  return { ok: true };
}

setInterval(() => {
  const now = Date.now();
  for (const [key, time] of mem.entries()) {
    if (now - time > WINDOW) {
      mem.delete(key);
    }
  }
}, WINDOW);
</file>

<file path="src/lib/db.ts">
import { PrismaClient } from '@prisma/client';

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma = globalForPrisma.prisma ?? new PrismaClient();

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;
</file>

<file path="src/lib/llm.ts">
import { GoogleGenerativeAI } from "@google/generative-ai";

const genAI = new GoogleGenerativeAI(process.env.GOOGLE_GEMINI_API_KEY!);
const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

const SYSTEM = `ã‚ãªãŸã¯é«˜æ ¡ç”Ÿã®åˆå¯¾é¢ã®ä¼šè©±ã‚’åŠ©ã‘ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
å®‰å…¨ç¬¬ä¸€ï¼ˆæ”¿æ²»/å®—æ•™/æ€§/ç—…æ°—/é‡‘éŠ­/å€‹äººç‰¹å®šã¯æ‰±ã‚ãªã„ï¼‰ã€‚
å‡ºåŠ›ã¯æ•¬ä½“ã§1ã€œ2æ–‡ã€æœ€å¾Œã¯è³ªå•ã§çµ‚ãˆã‚‹ã€‚å‡ºåŠ›ã¯1ä»¶ã®ã¿ã€‚`;

export async function generateTopic(profileA: any, profileB: any): Promise<string> {
  try {
    const prompt = [
      { role: "user", parts: [{ text: SYSTEM }] },
      {
        role: "user",
        parts: [{
          text: `A=${JSON.stringify(profileA)}\nB=${JSON.stringify(profileB)}\nå‡ºåŠ›ã¯ {"message":"..."} å½¢å¼ã§ã€‚`
        }]
      },
    ];

    const result = await model.generateContent({ contents: prompt });
    const response = result.response;
    const text = response.text().trim();

    try {
      const parsed = JSON.parse(text);
      return parsed.message || "éŸ³æ¥½ã¯ã‚ˆãè´ãã¾ã™ã‹ï¼Ÿæœ€è¿‘ã®ãŠæ°—ã«å…¥ã‚ŠãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚";
    } catch {
      return "éŸ³æ¥½ã¯ã‚ˆãè´ãã¾ã™ã‹ï¼Ÿæœ€è¿‘ã®ãŠæ°—ã«å…¥ã‚ŠãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚";
    }
  } catch (error) {
    console.error("LLM generation error:", error);
    return "éŸ³æ¥½ã¯ã‚ˆãè´ãã¾ã™ã‹ï¼Ÿæœ€è¿‘ã®ãŠæ°—ã«å…¥ã‚ŠãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚";
  }
}
</file>

<file path="src/lib/qr.ts">
import QRCode from "qrcode";

export async function generateQR(url: string): Promise<string> {
  try {
    const svg = await QRCode.toString(url, {
      type: "svg",
      errorCorrectionLevel: "M",
      margin: 0,
    });
    return svg;
  } catch (error) {
    console.error("QR generation error:", error);
    throw new Error("Failed to generate QR code");
  }
}
</file>

<file path="src/lib/repos/counters.ts">
import { prisma } from "@/lib/db";

export async function getCounters(userId: string) {
  const counters = await prisma.counters.findUnique({
    where: { userId },
  });

  return {
    scanOut: counters?.scanOutCount ?? 0,
    scanIn: counters?.scanInCount ?? 0,
  };
}

export async function incrScanOutIn(scannerId: string, scannedId: string) {
  await prisma.$transaction([
    prisma.counters.upsert({
      where: { userId: scannerId },
      create: {
        userId: scannerId,
        scanOutCount: 1,
        scanInCount: 0,
      },
      update: {
        scanOutCount: { increment: 1 },
      },
    }),
    prisma.counters.upsert({
      where: { userId: scannedId },
      create: {
        userId: scannedId,
        scanOutCount: 0,
        scanInCount: 1,
      },
      update: {
        scanInCount: { increment: 1 },
      },
    }),
  ]);
}
</file>

<file path="src/lib/repos/profile.ts">
import { prisma } from "@/lib/db";

export async function getProfile(userId: string) {
  const profile = await prisma.profile.findUnique({
    where: { userId },
  });

  return profile ? JSON.parse(profile.profileJson) : null;
}

export async function upsertProfile(userId: string, profileData: any) {
  const profileJson = JSON.stringify(profileData);

  if (profileJson.length > 8192) {
    throw new Error("Profile data too large (max 8KB)");
  }

  return await prisma.profile.upsert({
    where: { userId },
    create: {
      userId,
      profileJson: profileJson,
    },
    update: {
      profileJson: profileJson,
    },
  });
}
</file>

<file path="src/lib/repos/users.ts">
import { prisma } from "@/lib/db";
import crypto from "crypto";

export async function createUser(userId: string, password: string) {
  const passwordHash = crypto.createHash("sha256").update(password).digest("hex");

  return await prisma.user.create({
    data: {
      userId,
      passwordHash,
    },
  });
}

export async function getUserByUserId(userId: string) {
  return await prisma.user.findUnique({
    where: { userId },
  });
}

export async function verifyPassword(userId: string, password: string) {
  const user = await getUserByUserId(userId);
  if (!user) return null;

  const passwordHash = crypto.createHash("sha256").update(password).digest("hex");
  if (user.passwordHash !== passwordHash) return null;

  return user;
}
</file>

<file path="src/lib/session.ts">
import { cookies } from "next/headers";
import crypto from "crypto";

const NAME = "sid";
const MAX_AGE = Number(process.env.SESSION_MAX_AGE_SECONDS || 86400);
const SECRET = process.env.SESSION_SECRET!;

export function issueTicket(userId: string) {
  const exp = Math.floor(Date.now() / 1000) + MAX_AGE;
  const payload = `${userId}.${exp}`;
  const sig = crypto.createHmac("sha256", SECRET).update(payload).digest("hex");
  return `${payload}.${sig}`;
}

export function setSessionCookie(resp: any, userId: string) {
  const ticket = issueTicket(userId);
  resp.cookies.set(NAME, ticket, {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    sameSite: "strict",
    path: "/",
    maxAge: MAX_AGE,
  });
}

export function clearSessionCookie(resp: any) {
  resp.cookies.set(NAME, "", {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    sameSite: "strict",
    path: "/",
    maxAge: 0,
  });
}

export function requireSession() {
  const raw = cookies().get(NAME)?.value;
  if (!raw) throw new Error("UNAUTH");

  const parts = raw.split(".");
  if (parts.length !== 3) throw new Error("INVALID_FORMAT");

  const [userId, expStr, sig] = parts;
  const exp = Number(expStr);
  const now = Math.floor(Date.now() / 1000);

  if (now > exp) throw new Error("EXPIRED");

  const payload = `${userId}.${exp}`;
  const expected = crypto.createHmac("sha256", SECRET).update(payload).digest("hex");

  if (expected !== sig) throw new Error("BADSIG");

  return { userId };
}
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {},
  },
  plugins: [],
};
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "es2020",
    "lib": ["dom", "dom.iterable", "es2020"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
</file>

<file path="CLAUDE.md">
# CLAUDE.md â€” POCã€Œé«˜æ ¡ç”Ÿå‘ã‘QRãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«Ã—è©±é¡Œæç¤ºã€å®Ÿè£…ã‚¬ã‚¤ãƒ‰

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ **Vercel** ã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€**Gemini**ï¼ˆGoogle Generative AIï¼‰ã‚’ç”¨ã„ã¦ã€Œè©±é¡Œã‚’1ä»¶ã ã‘ã€ç”Ÿæˆã™ã‚‹Webã‚¢ãƒ—ãƒªã§ã™ã€‚  
é–‹ç™ºã¯ **Claude Code**ï¼ˆanthropic/claude-codeï¼‰ã§ã®ãƒšã‚¢ãƒ—ãƒ­ãƒ»è‡ªå‹•åŒ–ã‚’æƒ³å®šã—ãŸæ‰‹é †ãƒ»ã‚¿ã‚¹ã‚¯ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

---

## 0. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¦ç´„
- ç›®çš„ï¼šQRäº¤æ› â†’ GeminiãŒ**ä¼šè©±ã®æœ€åˆã®ã²ã¨è¨€ï¼ˆ1ä»¶ï¼‰**ã‚’æç¤º  
- ä¸»è¦ãƒšãƒ¼ã‚¸ï¼š
  - **ãƒ›ãƒ¼ãƒ **ï¼šè‡ªåˆ†ã®QRï¼ˆå¤§ï¼‰ï¼‹ã€Œç›¸æ‰‹ã®QRã‚’èª­ã¿å–ã‚‹ã€ãƒœã‚¿ãƒ³ã€è©±é¡Œã¯ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º  
  - **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«**ï¼šãƒˆãƒ”ãƒƒã‚¯â†’é¸æŠè‚¢â†’ä»»æ„å…¥åŠ›ï¼ˆPUTã§å…¨ç½®æ›ï¼‰  
  - **å®Ÿç¸¾**ï¼šè‡ªåˆ†ã® `scanOut / scanIn` æ•°å€¤ã®ã¿  
- ä¸»è¦APIï¼š
  - `POST /api/auth/signup|login|logout`ï¼ˆç½²åä»˜ãCookieã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰
  - `GET/PUT /api/profile/me`
  - `GET /api/qr/me`ï¼ˆURLï¼‹SVGè¿”å´ï¼‰
  - `POST /api/scan`ï¼ˆ30ç§’ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ / messageè¿”å´ï¼‰
  - `GET /api/metrics/me`ï¼ˆã‚«ã‚¦ãƒ³ãƒˆã®ã¿ï¼‰
- DBã¯ **User / Profile / Counters** ã®3è¡¨åˆ†é›¢è¨­è¨ˆã€‚  
- ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã¯ **30ç§’**ï¼ˆæœ¬ç•ªã¯KVæ¨å¥¨ã€é–‹ç™ºã¯ in-memoryï¼‰ã€‚

---

## 1. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **Framework**: Next.js 14ï¼ˆApp Routerï¼‰
- **Runtime**: Node.js 18+ï¼ˆVercelæ¨å¥¨ï¼‰
- **DB**: PostgreSQLï¼ˆNeon ã¾ãŸã¯ Supabase ç„¡æ–™æ  / Prismaï¼‰
- **LLM**: **Gemini 1.5**ï¼ˆGoogle Generative AI / @google/generative-aiï¼‰
- **Auth**: ç½²åä»˜ãCookieï¼ˆHMACï¼‰
- **QR**: SVGç”Ÿæˆï¼ˆ`qrcode`ï¼‰
- **Cooldown**: Vercel KVï¼ˆæœ¬ç•ªæ¨å¥¨ï¼‰ / é–‹ç™ºã¯ in-memory Map
- **UI**: React + Tailwindï¼ˆæ¨å¥¨ï¼‰

---

## 2. ç’°å¢ƒå¤‰æ•°ï¼ˆ.env.localï¼‰
DATABASE_URL=postgres://...
SESSION_SECRET=ãƒ©ãƒ³ãƒ€ãƒ é•·æ–‡å­—åˆ—
SESSION_MAX_AGE_SECONDS=86400
APP_BASE_URL=http://localhost:3000

GOOGLE_GEMINI_API_KEY=xxxxxxxxxxxxxxxx

---

## 3. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
```
/src
  /app
    /api
      /auth
        login/route.ts
        logout/route.ts
        signup/route.ts
      /profile/me/route.ts
      /qr/me/route.ts
      /scan/route.ts
      /metrics/me/route.ts
    layout.tsx
    page.tsx
    globals.css
  /lib
    db.ts
    session.ts       # HMACç½²åCookie
    llm.ts           # Geminiå‘¼ã³å‡ºã—
    qr.ts            # QRç”Ÿæˆ
    cooldown.ts      # ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
    repos/
      users.ts
      profile.ts
      counters.ts
  /components
    QrCard.tsx
    TopicModal.tsx
    Toast.tsx
    Navigation.tsx
    CameraScanner.tsx
/prisma
  schema.prisma
package.json
tsconfig.json
next.config.js
tailwind.config.js
postcss.config.js
.env.local
CLAUDE.md

---

## 4. UXè¨­è¨ˆãƒ»ç”»é¢ä»•æ§˜

### 4.1 ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ3ã‚¿ãƒ–ï¼‰
1. **ãƒ›ãƒ¼ãƒ ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰**
   - ä¸Šéƒ¨ï¼šè‡ªåˆ†ã®QRï¼ˆå¤§ããè¡¨ç¤ºï¼‰
   - ä¸‹éƒ¨ï¼šï¼»ç›¸æ‰‹ã®QRã‚’èª­ã¿å–ã‚‹ï¼½ãƒœã‚¿ãƒ³
   - ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸ â†’ ãƒ›ãƒ¼ãƒ ä¸Šã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è©±é¡Œè¡¨ç¤º â†’ ï¼»é–‰ã˜ã‚‹ï¼½ã§ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹

2. **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«**
   - ãƒˆãƒ”ãƒƒã‚¯ï¼ˆä¾‹ï¼šéŸ³æ¥½ã€ã‚¹ãƒãƒ¼ãƒ„ã€è¶£å‘³ç­‰ï¼‰â†’ é¸æŠè‚¢ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰
   - é¸æŠæ™‚ã®ã¿ä»»æ„ã®è‡ªç”±å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¡¨ç¤º
   - ï¼»ä¿å­˜ï¼½ãƒœã‚¿ãƒ³ã§PUTå…¨ç½®æ›

3. **å®Ÿç¸¾**
   - æ•°å€¤ã®ã¿ã‚·ãƒ³ãƒ—ãƒ«è¡¨ç¤ºï¼š
     - `scanOut`ï¼ˆèª­ã‚“ã å›æ•°ï¼‰
     - `scanIn`ï¼ˆèª­ã¾ã‚ŒãŸå›æ•°ï¼‰

### 4.2 èª­ã¿å–ã‚Šç”»é¢
- å…¨ç”»é¢ã‚«ãƒ¡ãƒ©ãƒ“ãƒ¥ãƒ¼
- QRæ¤œå‡º â†’ `POST /api/scan`
- **429ï¼ˆã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰æ™‚**ï¼šãƒ¢ãƒ¼ãƒ€ãƒ«å‡ºã•ãšã€**ãƒˆãƒ¼ã‚¹ãƒˆ**ã€Œæ™‚é–“ã‚’ãŠã„ã¦ãƒˆãƒ©ã‚¤ã—ã¦ãã ã•ã„ â³ã€

### 4.3 è©±é¡Œè¡¨ç¤º
- ãƒ¢ãƒ¼ãƒ€ãƒ«ã§**1ä»¶ã ã‘**è¡¨ç¤ºï¼ˆæ•¬ä½“ï¼1â€“2æ–‡ï¼è³ªå•ã§çµ‚ãˆã‚‹ï¼‰
- ï¼»é–‰ã˜ã‚‹ï¼½ã§ãƒ›ãƒ¼ãƒ ã¸ï¼ˆè‡ªåˆ†ã®QRãŒå†ã³å¤§ããè¡¨ç¤ºï¼‰

---

## 5. APIä»•æ§˜è©³ç´°

### 5.1 Auth
- `POST /api/auth/signup`
  - Body: `{ userId: string, password: string }`
  - æˆåŠŸ: 200 `{ok:true}` + `Set-Cookie: sid=...`
  - é‡è¤‡ID: 409 `{error:"user_exists"}`

- `POST /api/auth/login`
  - Body: `{ userId: string, password: string }`
  - æˆåŠŸ: 200 `{ok:true}` + `Set-Cookie: sid=...`
  - å¤±æ•—: 401 `{error:"invalid_credentials"}`

- `POST /api/auth/logout`
  - æˆåŠŸ: 200 `{ok:true}`ï¼ˆCookieç ´æ£„ï¼‰

### 5.2 Profileï¼ˆèªè¨¼å¿…é ˆï¼‰
- `GET /api/profile/me`
  - æˆåŠŸ: 200 `{...profileJson}`
  - æœªä½œæˆ: 404 or `{}`

- `PUT /api/profile/me`
  - Body: `{ ...profileJson }` ï¼ˆã‚µã‚¤ã‚ºä¸Šé™8KBï¼‰
  - æˆåŠŸ: 200 `{ok:true}`

### 5.3 QRï¼ˆèªè¨¼å¿…é ˆï¼‰
- `GET /api/qr/me`
  - æˆåŠŸ: 200 `{ "url": "https://app/scan?sid=<UUID>", "svg": "<svg...>" }`

### 5.4 Scanï¼ˆèªè¨¼å¿…é ˆï¼‰
- `POST /api/scan`
  - Body: `{ "scannedSid": "<ç›¸æ‰‹User.id(UUID)>" }`
  - æ¤œè¨¼ï¼šè‡ªå·±ã‚¹ã‚­ãƒ£ãƒ³â†’400ã€ç›¸æ‰‹ä¸åœ¨â†’404
  - ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³30ç§’â†’429 `{"error":"cooldown","message":"æ™‚é–“ã‚’ãŠã„ã¦ãƒˆãƒ©ã‚¤ã—ã¦ãã ã•ã„"}`
  - æˆåŠŸâ†’200 `{ "message": "äºŒäººã¨ã‚‚éŸ³æ¥½ãŒå¥½ãã¿ãŸã„ã§ã™ã­ã€‚æœ€è¿‘ã‚ˆãè´ãæ›²ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ" }`
  - å‰¯ä½œç”¨ï¼š`scanOut++` / `scanIn++`

### 5.5 Metricsï¼ˆèªè¨¼å¿…é ˆï¼‰
- `GET /api/metrics/me`
  - æˆåŠŸ: 200 `{ "scanOut": number, "scanIn": number }`

### 5.6 å…±é€šã‚¨ãƒ©ãƒ¼
| çŠ¶æ…‹ | HTTP | è¿”å´ä¾‹ |
|------|-----:|--------|
| æœªãƒ­ã‚°ã‚¤ãƒ³ | 401 | `{"error":"unauthorized"}` |
| è‡ªå·±ã‚¹ã‚­ãƒ£ãƒ³ | 400 | `{"error":"self_scan"}` |
| ç›¸æ‰‹ä¸åœ¨ | 404 | `{"error":"user_not_found"}` |
| ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ | 429 | `{"error":"cooldown","message":"æ™‚é–“ã‚’ãŠã„ã¦ãƒˆãƒ©ã‚¤ã—ã¦ãã ã•ã„"}` |
| äºˆæœŸã›ã¬ | 500 | `{"error":"internal"}` |

---

## 6. Prisma ã‚¹ã‚­ãƒ¼ãƒ
```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  userId       String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  profile      Profile?
  counters     Counters?
}

model Profile {
  userId      String   @id
  profileJson Json
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Counters {
  userId        String   @id
  scanOutCount  Int      @default(0)
  scanInCount   Int      @default(0)
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
```

---

## 5. ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆHMACç½²åä»˜ãCookieï¼‰
```ts
// lib/session.ts
import { cookies } from "next/headers";
import crypto from "crypto";

const NAME = "sid";
const MAX_AGE = Number(process.env.SESSION_MAX_AGE_SECONDS || 86400);
const SECRET = process.env.SESSION_SECRET!;

export function issueTicket(userId: string) {
  const exp = Math.floor(Date.now() / 1000) + MAX_AGE;
  const payload = `${userId}.${exp}`;
  const sig = crypto.createHmac("sha256", SECRET).update(payload).digest("hex");
  return `${payload}.${sig}`;
}

export function setSessionCookie(resp: any, userId: string) {
  const ticket = issueTicket(userId);
  resp.cookies.set(NAME, ticket, {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    sameSite: "strict",
    path: "/",
    maxAge: MAX_AGE,
  });
}

export function requireSession() {
  const raw = cookies().get(NAME)?.value;
  if (!raw) throw new Error("UNAUTH");
  const [userId, expStr, sig] = raw.split(".");
  const exp = Number(expStr);
  const now = Math.floor(Date.now() / 1000);
  if (now > exp) throw new Error("EXPIRED");
  const payload = `${userId}.${exp}`;
  const expect = crypto.createHmac("sha256", SECRET).update(payload).digest("hex");
  if (expect !== sig) throw new Error("BADSIG");
  return { userId };
}
```

---

## 6. ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³å®Ÿè£…
```ts
// lib/cooldown.ts
let mem = new Map<string, number>();
const WINDOW = 30_000;

export async function canScan(scannerId: string, scannedId: string) {
  const key = `${scannerId}:${scannedId}`;
  const now = Date.now();
  const last = mem.get(key) ?? 0;
  if (now - last < WINDOW) return { ok: false, waitMs: WINDOW - (now - last) };
  mem.set(key, now);
  return { ok: true };
}
```

---

## 7. Gemini å‘¼ã³å‡ºã—
```ts
// lib/llm.ts
import { GoogleGenerativeAI } from "@google/generative-ai";

const genAI = new GoogleGenerativeAI(process.env.GOOGLE_GEMINI_API_KEY!);
const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

const SYSTEM = `ã‚ãªãŸã¯é«˜æ ¡ç”Ÿã®åˆå¯¾é¢ã®ä¼šè©±ã‚’åŠ©ã‘ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
å®‰å…¨ç¬¬ä¸€ï¼ˆæ”¿æ²»/å®—æ•™/æ€§/ç—…æ°—/é‡‘éŠ­/å€‹äººç‰¹å®šã¯æ‰±ã‚ãªã„ï¼‰ã€‚
å‡ºåŠ›ã¯æ•¬ä½“ã§1ã€œ2æ–‡ã€æœ€å¾Œã¯è³ªå•ã§çµ‚ãˆã‚‹ã€‚å‡ºåŠ›ã¯1ä»¶ã®ã¿ã€‚`;

export async function generateTopic(profileA: any, profileB: any): Promise<string> {
  try {
    const prompt = [
      { role: "user", parts: [{ text: SYSTEM }] },
      { role: "user", parts: [{ text: `A=${JSON.stringify(profileA)}\nB=${JSON.stringify(profileB)}\nå‡ºåŠ›ã¯ {"message":"..."} å½¢å¼ã§ã€‚`} ] },
    ];
    const res = await model.generateContent({ contents: prompt });
    const msg = JSON.parse(res.response.text().trim()).message;
    return msg;
  } catch {
    return "éŸ³æ¥½ã¯ã‚ˆãè´ãã¾ã™ã‹ï¼Ÿæœ€è¿‘ã®ãŠæ°—ã«å…¥ã‚ŠãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚";
  }
}
```

---

## 8. API ã‚µãƒ³ãƒ—ãƒ«

### QR
```ts
// app/api/qr/me/route.ts
import { NextResponse } from "next/server";
import { requireSession } from "@/lib/session";
import QRCode from "qrcode";

export async function GET() {
  const me = requireSession();
  const url = `${process.env.APP_BASE_URL}/scan?sid=${me.userId}`;
  const svg = await QRCode.toString(url, { type: "svg", errorCorrectionLevel: "M", margin: 0 });
  return NextResponse.json({ url, svg });
}
```

### ã‚¹ã‚­ãƒ£ãƒ³
```ts
// app/api/scan/route.ts
import { NextResponse } from "next/server";
import { requireSession } from "@/lib/session";
import { prisma } from "@/lib/db";
import { getProfile } from "@/lib/repos/profile";
import { incrScanOutIn } from "@/lib/repos/counters";
import { generateTopic } from "@/lib/llm";
import { canScan } from "@/lib/cooldown";

export async function POST(req: Request) {
  try {
    const me = requireSession();
    const { scannedSid } = await req.json();
    if (!scannedSid) return NextResponse.json({ error: "bad_request" }, { status: 400 });
    if (me.userId === scannedSid) return NextResponse.json({ error: "self_scan" }, { status: 400 });

    const scanned = await prisma.user.findUnique({ where: { id: scannedSid } });
    if (!scanned) return NextResponse.json({ error: "user_not_found" }, { status: 404 });

    const cd = await canScan(me.userId, scanned.id);
    if (!cd.ok) return NextResponse.json({ error: "cooldown", message: "æ™‚é–“ã‚’ãŠã„ã¦ãƒˆãƒ©ã‚¤ã—ã¦ãã ã•ã„" }, { status: 429 });

    const [pa, pb] = await Promise.all([getProfile(me.userId), getProfile(scanned.id)]);
    const message = await generateTopic(pa ?? {}, pb ?? {});
    await incrScanOutIn(me.userId, scanned.id);

    return NextResponse.json({ message });
  } catch {
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}
```

### å®Ÿç¸¾
```ts
// app/api/metrics/me/route.ts
import { NextResponse } from "next/server";
import { requireSession } from "@/lib/session";
import { prisma } from "@/lib/db";

export async function GET() {
  const me = requireSession();
  const c = await prisma.counters.findUnique({ where: { userId: me.userId } });
  return NextResponse.json({
    scanOut: c?.scanOutCount ?? 0,
    scanIn:  c?.scanInCount  ?? 0,
  });
}
```

---

## 9. ãƒ†ã‚¹ãƒˆè¦³ç‚¹ï¼ˆPOCï¼‰
- ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼šCookieå±æ€§ç¢ºèª  
- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼šGETç©ºâ†’PUTä¿å­˜â†’GETåæ˜   
- QRï¼šURLï¼‹SVGãŒè¿”å´ã•ã‚Œã‚‹ã“ã¨  
- ã‚¹ã‚­ãƒ£ãƒ³ï¼šæ­£å¸¸ï¼è‡ªå·±ï¼ç›¸æ‰‹ä¸åœ¨ï¼ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³  
- LLMï¼šJSONå½¢å¼ã®è¿”å´ã€å¤±æ•—æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯  
- å®Ÿç¸¾ï¼šã‚«ã‚¦ãƒ³ãƒˆãŒæ­£ã—ãå¢—åŠ   

---

## 10. å®Ÿè£…çŠ¶æ³ã¨é †åº

### âœ… å®Ÿè£…å®Œäº†æ¸ˆã¿ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰ï¼š
1. **åŸºç›¤è¨­å®š**
   - Next.js 14ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–
   - Prismaè¨­å®šã¨ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ï¼ˆPostgreSQLå¯¾å¿œï¼‰
   - TypeScriptè¨­å®šï¼ˆtarget: es2020ï¼‰
   - Tailwind CSSè¨­å®š

2. **èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ** (ç½²åä»˜ãCookie)
   - `lib/session.ts` - HMACç½²åä»˜ãCookie
   - `lib/repos/users.ts` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
   - `api/auth/signup` - æ–°è¦ç™»éŒ²
   - `api/auth/login` - ãƒ­ã‚°ã‚¤ãƒ³
   - `api/auth/logout` - ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ

3. **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ©Ÿèƒ½**
   - `lib/repos/profile.ts` - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†ï¼ˆStringå‹ã§JSONä¿å­˜ï¼‰
   - `api/profile/me` - GET/PUT ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

4. **QRç”Ÿæˆãƒ»è¡¨ç¤º**
   - `lib/qr.ts` - SVG QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
   - `api/qr/me` - QRç”Ÿæˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

5. **ã‚¹ã‚­ãƒ£ãƒ³ãƒ»è©±é¡Œæç¤º**ï¼ˆæ ¸å¿ƒæ©Ÿèƒ½ï¼‰
   - `lib/cooldown.ts` - 30ç§’ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
   - `lib/llm.ts` - Geminié€£æº
   - `lib/repos/counters.ts` - ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ç®¡ç†
   - `api/scan` - ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

6. **å®Ÿç¸¾è¡¨ç¤º**
   - `api/metrics/me` - å®Ÿç¸¾å–å¾—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### âœ… å®Ÿè£…å®Œäº†æ¸ˆã¿ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰ï¼š
1. **èªè¨¼ç”»é¢**
   - `/auth/signup` - æ–°è¦ç™»éŒ²ç”»é¢
   - `/auth/login` - ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
   - èªè¨¼å¾Œã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†

2. **ãƒ¡ã‚¤ãƒ³ç”»é¢**
   - `/home` - QRè¡¨ç¤ºãƒ»ã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½
   - `/profile` - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
   - `/metrics` - å®Ÿç¸¾è¡¨ç¤º

3. **å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**
   - `Navigation.tsx` - 3ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
   - `TopicModal.tsx` - è©±é¡Œè¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«
   - `Toast.tsx` - ã‚¨ãƒ©ãƒ¼/é€šçŸ¥ãƒˆãƒ¼ã‚¹ãƒˆ
   - `CameraScanner.tsx` - QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼

### âœ… Vercelãƒ‡ãƒ—ãƒ­ã‚¤å¯¾å¿œï¼š
- **å‹•çš„å®Ÿè¡Œè¨­å®š**: å…¨APIãƒ«ãƒ¼ãƒˆã« `export const dynamic = 'force-dynamic'` è¿½åŠ 
- **ç’°å¢ƒå¤‰æ•°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: DEPLOYMENT_FIX.mdä½œæˆ
- **æœ¬ç•ªç’°å¢ƒã§ã®å‹•ä½œç¢ºèªæ¸ˆã¿**

### ğŸ“ ä¿®æ­£æ¸ˆã¿è¨­è¨ˆå¤‰æ›´ï¼š
- **Middlewareå‰Šé™¤**: Edgeç’°å¢ƒã§ã®next/headersäº’æ›æ€§å•é¡Œã«ã‚ˆã‚Šã€å„APIãƒãƒ³ãƒ‰ãƒ©ã§ã®èªè¨¼ãƒã‚§ãƒƒã‚¯ã«çµ±ä¸€
- **QRç”»åƒã‚µã‚¤ã‚º**: SVGã®æ‹¡å¤§ç¸®å°ç‰¹æ€§ã‚’æ´»ã‹ã™ãŸã‚widthå›ºå®šæŒ‡å®šã‚’å‰Šé™¤
- **Profile.profileJsonå‹**: PostgreSQLã¨ã®äº’æ›æ€§ã®ãŸã‚Stringå‹ã§ä¿æŒï¼ˆJSON.parse/stringifyã§å‡¦ç†ï¼‰
- **å‹•çš„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¼·åˆ¶**: cookies()ä½¿ç”¨ã«ã‚ˆã‚‹ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼å¯¾ç­–

### ğŸ‰ POCå®ŒæˆçŠ¶æ…‹ï¼š
ç¾åœ¨ã€å…¨æ©Ÿèƒ½ãŒå®Ÿè£…æ¸ˆã¿ã§Vercelãƒ‡ãƒ—ãƒ­ã‚¤ã‚‚æˆåŠŸã€‚ä»¥ä¸‹ãŒå‹•ä½œç¢ºèªæ¸ˆã¿ï¼š
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³
- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ãƒ»å–å¾—
- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ»è¡¨ç¤º
- ã‚¹ã‚­ãƒ£ãƒ³ãƒ»è©±é¡Œç”Ÿæˆï¼ˆGeminié€£æºï¼‰
- å®Ÿç¸¾ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º
- 30ç§’ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æ©Ÿèƒ½

---

## 11. å—ã‘å…¥ã‚Œæ¡ä»¶ï¼ˆPOC Doneï¼‰
20â€“30äººè¦æ¨¡ãƒ†ã‚¹ãƒˆã§ï¼š
- ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜æˆåŠŸç‡ â‰¥ 90%
- ã‚¹ã‚­ãƒ£ãƒ³â†’è©±é¡Œè¡¨ç¤ºã®æˆåŠŸç‡ â‰¥ 85%ã€å¹³å‡å¿œç­” â‰¤ 1.5s
- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼šã€Œä¼šè©±ã‚’å§‹ã‚ã‚„ã™ããªã£ãŸã€**â‰¥ 70%**
- ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã¯ 429 ã¨ãƒˆãƒ¼ã‚¹ãƒˆãŒæ­£ã—ãè¡¨ç¤º

---

## 12. ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ï¼ˆVercelï¼‰

### å¿…é ˆç’°å¢ƒå¤‰æ•°
1. **DATABASE_URL** - PostgreSQLæ¥ç¶šæ–‡å­—åˆ—ï¼ˆSupabase/Neonï¼‰
2. **SESSION_SECRET** - ãƒ©ãƒ³ãƒ€ãƒ ãª32æ–‡å­—ä»¥ä¸Šã®æ–‡å­—åˆ—
3. **APP_BASE_URL** - æœ¬ç•ªURLï¼ˆä¾‹: https://your-app.vercel.appï¼‰
4. **GOOGLE_GEMINI_API_KEY** - Gemini APIã‚­ãƒ¼
5. **SESSION_MAX_AGE_SECONDS** - ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 86400ï¼‰

### ãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèªäº‹é …
- âœ… å…¨APIãƒ«ãƒ¼ãƒˆã« `export const dynamic = 'force-dynamic'` è¨­å®šæ¸ˆã¿
- âœ… Prismaãƒ“ãƒ«ãƒ‰æ™‚ã« `prisma generate` å®Ÿè¡Œï¼ˆpackage.jsonã®buildã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å¯¾å¿œæ¸ˆã¿ï¼‰
- âœ… PostgreSQLï¼ˆSupabaseï¼‰ã¨ã®æ¥ç¶šç¢ºèªæ¸ˆã¿
- âœ… HTTPSç’°å¢ƒã§ã®å‹•ä½œç¢ºèªæ¸ˆã¿

---

## 13. é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### å‰ææ¡ä»¶
- Node.js 18+
- PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆSupabaseæ¨å¥¨ï¼‰
- Gemini API ã‚­ãƒ¼

### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# ç’°å¢ƒå¤‰æ•°è¨­å®š
cp .env.local.example .env.local
# DATABASE_URL, SESSION_SECRET, GOOGLE_GEMINI_API_KEY ã‚’è¨­å®š

# Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆ
npx prisma generate

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
npx prisma db push

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run dev
```

### APIãƒ†ã‚¹ãƒˆä¾‹
```bash
# æ–°è¦ç™»éŒ²
curl -X POST http://localhost:3000/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"userId":"test1","password":"password123"}'

# QRå–å¾—
curl -X GET http://localhost:3000/api/qr/me \
  -H "Cookie: sid=<session_cookie>"
```
</file>

<file path="next.config.js">
/** @type {import('next').NextConfig} */
const nextConfig = {};

module.exports = nextConfig;
</file>

<file path="src/app/api/auth/login/route.ts">
// Force dynamic execution (required for cookies)
export const dynamic = 'force-dynamic';
export const revalidate = 0;

import { NextRequest, NextResponse } from "next/server";
import { verifyPassword } from "@/lib/repos/users";
import { setSessionCookie } from "@/lib/session";

export async function POST(req: NextRequest) {
  try {
    const { userId, password } = await req.json();

    if (!userId || !password) {
      return NextResponse.json({ error: "bad_request" }, { status: 400 });
    }

    const user = await verifyPassword(userId, password);
    if (!user) {
      return NextResponse.json({ error: "invalid_credentials" }, { status: 401 });
    }

    const response = NextResponse.json({ ok: true });
    setSessionCookie(response, user.id);

    return response;
  } catch (error) {
    console.error("Login error:", error);
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}
</file>

<file path="src/app/api/auth/logout/route.ts">
// Force dynamic execution (required for cookies)
export const dynamic = 'force-dynamic';
export const revalidate = 0;

import { NextRequest, NextResponse } from "next/server";
import { clearSessionCookie } from "@/lib/session";

export async function POST(req: NextRequest) {
  try {
    const response = NextResponse.json({ ok: true });
    clearSessionCookie(response);
    return response;
  } catch (error) {
    console.error("Logout error:", error);
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}
</file>

<file path="src/app/api/auth/signup/route.ts">
// Force dynamic execution (required for cookies)
export const dynamic = 'force-dynamic';
export const revalidate = 0;

import { NextRequest, NextResponse } from "next/server";
import { createUser, getUserByUserId } from "@/lib/repos/users";
import { setSessionCookie } from "@/lib/session";

export async function POST(req: NextRequest) {
  try {
    const { userId, password } = await req.json();

    if (!userId || !password) {
      return NextResponse.json({ error: "bad_request" }, { status: 400 });
    }

    const existingUser = await getUserByUserId(userId);
    if (existingUser) {
      return NextResponse.json({ error: "user_exists" }, { status: 409 });
    }

    const user = await createUser(userId, password);

    const response = NextResponse.json({ ok: true });
    setSessionCookie(response, user.id);

    return response;
  } catch (error) {
    console.error("Signup error:", error);
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}
</file>

<file path="src/app/api/metrics/me/route.ts">
// Force dynamic execution (required for cookies)
export const dynamic = 'force-dynamic';
export const revalidate = 0;

import { NextResponse } from "next/server";
import { requireSession } from "@/lib/session";
import { getCounters } from "@/lib/repos/counters";

export async function GET() {
  try {
    const { userId } = requireSession();
    const counters = await getCounters(userId);

    return NextResponse.json({
      scanOut: counters.scanOut,
      scanIn: counters.scanIn,
    });
  } catch (error: any) {
    if (error.message === "UNAUTH" || error.message === "EXPIRED" || error.message === "BADSIG") {
      return NextResponse.json({ error: "unauthorized" }, { status: 401 });
    }
    console.error("Get metrics error:", error);
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}
</file>

<file path="src/app/api/profile/me/route.ts">
// Force dynamic execution (required for cookies)
export const dynamic = 'force-dynamic';
export const revalidate = 0;

import { NextRequest, NextResponse } from "next/server";
import { requireSession } from "@/lib/session";
import { getProfile, upsertProfile } from "@/lib/repos/profile";

export async function GET() {
  try {
    const { userId } = requireSession();
    const profile = await getProfile(userId);

    if (!profile) {
      return NextResponse.json({}, { status: 200 });
    }

    return NextResponse.json(profile);
  } catch (error: any) {
    if (error.message === "UNAUTH" || error.message === "EXPIRED" || error.message === "BADSIG") {
      return NextResponse.json({ error: "unauthorized" }, { status: 401 });
    }
    console.error("Get profile error:", error);
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}

export async function PUT(req: NextRequest) {
  try {
    const { userId } = requireSession();
    const profileData = await req.json();

    await upsertProfile(userId, profileData);

    return NextResponse.json({ ok: true });
  } catch (error: any) {
    if (error.message === "UNAUTH" || error.message === "EXPIRED" || error.message === "BADSIG") {
      return NextResponse.json({ error: "unauthorized" }, { status: 401 });
    }
    if (error.message.includes("Profile data too large")) {
      return NextResponse.json({ error: "profile_too_large" }, { status: 400 });
    }
    console.error("Update profile error:", error);
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}
</file>

<file path="src/app/api/qr/me/route.ts">
// Force dynamic execution (required for cookies)
export const dynamic = 'force-dynamic';
export const revalidate = 0;

import { NextResponse } from "next/server";
import { requireSession } from "@/lib/session";
import { generateQR } from "@/lib/qr";

export async function GET() {
  try {
    const { userId } = requireSession();
    const url = `${process.env.APP_BASE_URL}/scan?sid=${userId}`;
    const svg = await generateQR(url);

    return NextResponse.json({ url, svg });
  } catch (error: any) {
    if (error.message === "UNAUTH" || error.message === "EXPIRED" || error.message === "BADSIG") {
      return NextResponse.json({ error: "unauthorized" }, { status: 401 });
    }
    console.error("QR generation error:", error);
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}
</file>

<file path="src/app/api/scan/route.ts">
// Force dynamic execution (required for cookies)
export const dynamic = 'force-dynamic';
export const revalidate = 0;

import { NextRequest, NextResponse } from "next/server";
import { requireSession } from "@/lib/session";
import { prisma } from "@/lib/db";
import { getProfile } from "@/lib/repos/profile";
import { incrScanOutIn } from "@/lib/repos/counters";
import { generateTopic } from "@/lib/llm";
import { canScan } from "@/lib/cooldown";

export async function POST(req: NextRequest) {
  try {
    const { userId: scannerId } = requireSession();
    const { scannedSid } = await req.json();

    if (!scannedSid) {
      return NextResponse.json({ error: "bad_request" }, { status: 400 });
    }

    if (scannerId === scannedSid) {
      return NextResponse.json({ error: "self_scan" }, { status: 400 });
    }

    const scannedUser = await prisma.user.findUnique({
      where: { id: scannedSid },
    });

    if (!scannedUser) {
      return NextResponse.json({ error: "user_not_found" }, { status: 404 });
    }

    const cd = await canScan(scannerId, scannedUser.id);
    if (!cd.ok) {
      return NextResponse.json({
        error: "cooldown",
        message: "æ™‚é–“ã‚’ãŠã„ã¦ãƒˆãƒ©ã‚¤ã—ã¦ãã ã•ã„"
      }, { status: 429 });
    }

    const [profileA, profileB] = await Promise.all([
      getProfile(scannerId),
      getProfile(scannedUser.id),
    ]);

    const message = await generateTopic(profileA ?? {}, profileB ?? {});

    await incrScanOutIn(scannerId, scannedUser.id);

    return NextResponse.json({ message });
  } catch (error: any) {
    if (error.message === "UNAUTH" || error.message === "EXPIRED" || error.message === "BADSIG") {
      return NextResponse.json({ error: "unauthorized" }, { status: 401 });
    }
    console.error("Scan error:", error);
    return NextResponse.json({ error: "internal" }, { status: 500 });
  }
}
</file>

<file path="prisma/schema.prisma">
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  userId       String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  profile      Profile?
  counters     Counters?
}

model Profile {
  userId      String   @id
  profileJson String
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Counters {
  userId        String   @id
  scanOutCount  Int      @default(0)
  scanInCount   Int      @default(0)
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
</file>

<file path="package.json">
{
  "name": "propose-conversation-topic",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "prisma generate && next build",
    "start": "next start",
    "lint": "next lint",
    "db:generate": "prisma generate",
    "db:push": "prisma db push",
    "db:studio": "prisma studio"
  },
  "dependencies": {
    "@google/generative-ai": "^0.21.0",
    "@prisma/client": "^5.19.1",
    "@yudiel/react-qr-scanner": "^2.3.1",
    "autoprefixer": "^10.4.21",
    "next": "14.2.12",
    "qrcode": "^1.5.4",
    "react": "^18.3.1",
    "react-dom": "^18.3.1"
  },
  "devDependencies": {
    "@types/node": "^20.16.5",
    "@types/qrcode": "^1.5.5",
    "@types/react": "^18.3.5",
    "@types/react-dom": "^18.3.0",
    "eslint": "^8.57.0",
    "eslint-config-next": "14.2.12",
    "postcss": "^8.4.45",
    "prisma": "^5.19.1",
    "tailwindcss": "^3.4.10",
    "typescript": "^5.6.2"
  }
}
</file>

</files>
